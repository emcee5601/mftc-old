import{r as Cs,e as n,_ as nn}from"./mui-CBXShqvM.js";import{r as u,a as de}from"./echarts-SWUI2Nti.js";import{G as J,S as an,c as Bt,u as rn,L as on,N as vs,a as Rt,b as cn,O as ln,d as un,e as dn,_ as hn,f as Vt,g as dt,v as mn,h as Wt,i as gn,j as fn,k as pn,l as Sn,H as Tn,R as En,m as me}from"./react-etc-CvX0jPvx.js";import{s as xn,i as _s,a as Ns,b as bn,d as nt,M as Ae,c as Cn,L as vn,G as _n,B as Nn,e as ws}from"./utils-U6kK1nTw.js";import{A as wn}from"./ajv-QZpGHo-X.js";import{V as zt,P as yn,a as An,C as Rn,b as In,f as Pn}from"./drivers-BUg4LKBX.js";import{Q as Qe,k as Ln}from"./qr-code-Dmff3LKM.js";import{D as st}from"./react-datepicker-cqC2H3Td.js";import{u as On,a as kn,f as Ht,g as Dn,b as Mn,c as jn}from"./tanstack-tables-nv-LrAeV.js";import{f as Fn}from"./function-plot-CoA9H-jI.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function s(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(r){if(r.ep)return;r.ep=!0;const i=s(r);fetch(r.href,i)}})();var ys,Gt=Cs;ys=Gt.createRoot,Gt.hydrateRoot;function As(t){return J({tag:"svg",attr:{fill:"currentColor",viewBox:"0 0 16 16"},child:[{tag:"path",attr:{d:"M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"},child:[]}]})(t)}function Kt(t){return J({tag:"svg",attr:{fill:"currentColor",viewBox:"0 0 16 16"},child:[{tag:"path",attr:{d:"M0 4v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H2a2 2 0 0 0-2 2m4.271 1.055a.5.5 0 0 1 .52.038L8 7.386V5.5a.5.5 0 0 1 .79-.407l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 8 10.5V8.614l-3.21 2.293A.5.5 0 0 1 4 10.5v-5a.5.5 0 0 1 .271-.445"},child:[]}]})(t)}function Rs(t){return J({tag:"svg",attr:{fill:"currentColor",viewBox:"0 0 16 16"},child:[{tag:"path",attr:{d:"M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"},child:[]},{tag:"path",attr:{d:"M11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0"},child:[]}]})(t)}function $n(t){return J({tag:"svg",attr:{fill:"currentColor",viewBox:"0 0 16 16"},child:[{tag:"path",attr:{d:"M6 9a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3A.5.5 0 0 1 6 9M3.854 4.146a.5.5 0 1 0-.708.708L4.793 6.5 3.146 8.146a.5.5 0 1 0 .708.708l2-2a.5.5 0 0 0 0-.708z"},child:[]},{tag:"path",attr:{d:"M2 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1z"},child:[]}]})(t)}function Un(t){return J({tag:"svg",attr:{fill:"currentColor",viewBox:"0 0 16 16"},child:[{tag:"path",attr:{d:"M12.5 2A2.5 2.5 0 0 0 10 4.5a.5.5 0 0 1-1 0A3.5 3.5 0 1 1 12.5 8H.5a.5.5 0 0 1 0-1h12a2.5 2.5 0 0 0 0-5m-7 1a1 1 0 0 0-1 1 .5.5 0 0 1-1 0 2 2 0 1 1 2 2h-5a.5.5 0 0 1 0-1h5a1 1 0 0 0 0-2M0 9.5A.5.5 0 0 1 .5 9h10.042a3 3 0 1 1-3 3 .5.5 0 0 1 1 0 2 2 0 1 0 2-2H.5a.5.5 0 0 1-.5-.5"},child:[]}]})(t)}function It(t){return J({tag:"svg",attr:{fill:"currentColor",viewBox:"0 0 16 16"},child:[{tag:"path",attr:{d:"M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z"},child:[]}]})(t)}var ee=(t=>(t.NotInitialized="NotInitialized",t.Simulator="Simulator",t.SimulatorFile="Simulator-file",t.WebSerial="WebSerial",t.WebUsbSerial="WebUsbSerial",t.Manual="Manual",t))(ee||{});const qe={num:0,mean:0,stddev:0};var xt=(t=>(t.Paused="Paused",t.Transmitting="Transmitting",t))(xt||{}),te=(t=>(t.DISCONNECTED="Disconnected",t.WAITING="Waiting for PortaCount",t.RECEIVING="Receiving data",t))(te||{}),ue=(t=>(t.Idle="Idle",t.Testing="Testing",t.Counting="Counting",t.Disconnected="Disconnected",t))(ue||{}),k=(t=>(t.MASK="mask",t.AMBIENT="ambient",t))(k||{}),B=(t=>(t.External="External",t.Internal="Internal",t.Manual="Manual",t))(B||{});class Is{_connectionStatus="Disconnected";_controlSource="Internal";_sampleSource="mask";_dataTransmissionState="Transmitting";_batteryStatus="?";_pulseStatus="?";_componentVoltages=new Map;_lastLine="";_activity="Disconnected";get componentVoltages(){return this._componentVoltages}get batteryStatus(){return this._batteryStatus}set batteryStatus(e){this._batteryStatus=e}get pulseStatus(){return this._pulseStatus}set pulseStatus(e){this._pulseStatus=e}get connectionStatus(){return this._connectionStatus}set connectionStatus(e){this._connectionStatus=e}get controlSource(){return this._controlSource}set controlSource(e){this._controlSource=e}get sampleSource(){return this._sampleSource}set sampleSource(e){this._sampleSource=e}get dataTransmissionState(){return this._dataTransmissionState}set dataTransmissionState(e){this._dataTransmissionState=e}get activity(){return this._activity}set activity(e){this._activity=e}get lastLine(){return this._lastLine}set lastLine(e){this._lastLine=e}}var m=(t=>(t.SPEECH_ENABLED="speech-enabled",t.SPEECH_VOICE="speech-voice",t.VERBOSE="verbose",t.SAY_PARTICLE_COUNT="say-particle-count",t.RESULTS_TABLE_SORT="results-table-sort",t.PARTICIPANT_RESULTS_TABLE_SORT="participant-results-table-sort",t.SAY_ESTIMATED_FIT_FACTOR="say-estimated-fit-factor",t.BAUD_RATE="baud-rate",t.PROTOCOL_INSTRUCTION_SETS="protocol-instruction-sets",t.SELECTED_PROTOCOL="selected-protocol",t.KEEP_SCREEN_AWAKE="keep-screen-awake",t.TEST_TEMPLATE="test-template",t.ENABLE_SIMULATOR="enable-simulator",t.ENABLE_AUTO_CONNECT="enable-auto-connect",t.SIMULATOR_FILE_SPEED="simulator-file-speed",t.SELECTED_DATA_SOURCE="selected-data-source",t.SYNC_DEVICE_STATE_ON_CONNECT="sync-device-state-on-connect",t.MINUTES_ALLOTTED_PER_PARTICIPANT="minutes-allotted-per-participant",t.EVENT_END_HHMM="event-end-hhmm",t.SHOW_ELAPSED_PARTICIPANT_TIME="show-elapsed-participant-time",t.SHOW_REMAINING_EVENT_TIME="show-remaining-event-time",t.ENABLE_WEB_SERIAL_DRIVERS="enable-webserial-drivers",t.ENABLE_TEST_INSTRUCTIONS_ZOOM="enable-test-instructions-zoom",t.BOOKMARKS="bookmarks",t.MASK_LIST="mask-list",t.PARTICIPANT_LIST="participant-list",t.AUTO_UPDATE_MASK_LIST="auto-update-mask-list",t.COLOR_SCHEME="color-scheme",t.SHOW_MASK_PERF_GRAPH="show-mask-perf-graph",t.SAMPLE_MASK_WHEN_IDLE="sample-mask-when-idle",t.USE_IDLE_AMBIENT_VALUES="use-idle-ambient-values",t.NORMALIZE_MASK_LIST_NAMES="normalize-mask-list-names",t.AUTO_DETECT_BAUD_RATE="auto-detect-baud-rate",t.ENABLE_TESTER_MODE="enable-tester-mode",t.SHOW_STDDEV="show-stddev",t.SHOW_SIMULATOR_RESULTS="show-simulator-results",t.ENABLE_CONTROL_SOURCE_WIDGET="enable-control-source-widget",t.STATS_FIRST_DATE="so-stats-first-date",t.STATS_LAST_DATE="so-stats-last-date",t.RESULTS_TABLE_FILTER="so-results-table-filter",t.PARTICIPANT_RESULTS_TABLE_FILTER="so-participant-results-table-filter",t.COMBINED_MASK_LIST="so-combined-mask-list",t.COMBINED_PARTICIPANT_LIST="so-combined-participant-list",t.TEST_NOTES="so-test-notes",t.CONNECTION_STATUS_IN_VIEW="so-connection-status-in-view",t.ACTIVITY="so-activity",t.ZOOM_INSTRUCTIONS="so-zoom-instructions",t.CURRENT_AMBIENT_AVERAGE="so-current-ambient-average",t.CURRENT_MASK_AVERAGE="so-current-mask-average",t.CONNECTION_STATUS="so-connection-status",t.PROTOCOL_EXECUTION_STATE="so-protocol-execution-state",t.PROTOCOL_START_TIME="so-protocol-start-time",t.STAGE_START_TIME="so-stage-start-time",t.CURRENT_STAGE_INDEX="so-current-stage-index",t.DEFAULT_TO_PREVIOUS_PARTICIPANT="default-to-previous-participant",t.AUTO_ESTIMATE_FIT_FACTOR="auto-estimate-fit-factor",t.SHOW_PROTOCOL_EDITOR="show-protocol-editor",t.SHOW_SIMPLE_PROTOCOL_EDITOR="show-simple-protocol-editor",t.SHOW_SETTINGS="show-settings",t.SHOW_LOG_PANELS="show-log-panels",t.SHOW_HISTORICAL_TESTS="show-historical-tests",t.SHOW_CURRENT_TEST_PANEL="show-current-test-panel",t.SHOW_EXTERNAL_CONTROL="show-external-control",t.ENABLE_PROTOCOL_EDITOR="enable-protocol-editor",t.ENABLE_QR_CODE_SCANNER="enable-qr-code-scanner",t.ENABLE_STATS="enable-stats",t.USE_COMPACT_UI="use-compact-ui",t.ADVANCED_MODE="advanced-mode",t.CONTROL_SOURCE_IN_VIEW="so-control-source-in-view",t.SAMPLE_SOURCE_IN_VIEW="so-sample-source-in-view",t.IS_PROTOCOL_RUNNING="so-is-protocol-running",t.LAST_KNOWN_SETTINGS_KEYS_HASH="last-known-settings-keys-hash",t.AUTO_CREATE_FAST_PROTOCOLS="auto-create-fast-protocols",t))(m||{});const Bn={"speech-enabled":!1,"advanced-mode":!1,"speech-voice":"default",verbose:!1,"say-particle-count":!1,"results-table-sort":[{id:"ID",desc:!0}],"participant-results-table-sort":[{id:"ID",desc:!0}],"auto-estimate-fit-factor":!1,"say-estimated-fit-factor":!1,"show-external-control":!1,"baud-rate":1200,"protocol-instruction-sets":{w1:["Normal breathing. Breathe normally","Heavy breathing. Take deep breaths.",["Jaw movement.","Read the rainbow passage:","When the sunlight strikes raindrops in the air, they act as a prism and form a rainbow.","The rainbow is a division of white light into many beautiful colors.","These take the shape of a long round arch, with its path high above,","and its two ends apparently beyond the horizon.","There is, according to legend, a boiling pot of gold at one end.","People look, but no one ever finds it.","When a man looks for something beyond his reach,","his friends say he is looking for the pot of gold at the end of the rainbow."].join(" "),"Head movement. Look up, down, left, and right. Repeat."],"Modified CNC (B2)":[{title:"Prep",instructions:"Breathe normally while we sample the air.",ambient_purge:4,ambient_sample:20,mask_purge:0,mask_sample:0},{title:"Talking",instructions:["Talk out loud slowly, loud enough to be heard by the test administrator.","Or count backwards from 100."].join(" "),ambient_purge:0,ambient_sample:0,mask_purge:4,mask_sample:30},{title:"Bending over",instructions:"Bend at the waist as if going to touch your toes. Inhale 2 times at the bottom.",ambient_purge:0,ambient_sample:0,mask_purge:4,mask_sample:30},{title:"Head side-to-side",instructions:"Slowly turn head from side to side. Inhale 2 times at each extreme.",ambient_purge:0,ambient_sample:0,mask_purge:4,mask_sample:30},{title:"Head up-and-down",instructions:"Slowly move head up and down. Inhale 2 times at each extreme.",ambient_purge:0,ambient_sample:0,mask_purge:4,mask_sample:30},{title:"Finalize",instructions:"Breathe normally while we sample the air again.",ambient_purge:4,ambient_sample:9,mask_purge:0,mask_sample:0}],"Modified CNC (B)":[{instructions:"prep",ambient_purge:4,ambient_sample:20,mask_purge:0,mask_sample:0},{instructions:"Bending over. Bend at the waist as if going to touch your toes. Inhale 2 times at the bottom.",ambient_purge:0,ambient_sample:0,mask_purge:4,mask_sample:30},{instructions:["Talking.","Talk out loud slowly and loud enough to be heard by the test administrator.","Count backwards from 100,","or read the Rainbow Passage:","When the sunlight strikes raindrops in the air, they act as a prism and form a rainbow.","The rainbow is a division of white light into many beautiful colors.","These take the shape of a long round arch, with its path high above,","and its two ends apparently beyond the horizon.","There is, according to legend, a boiling pot of gold at one end.","People look, but no one ever finds it.","When a man looks for something beyond his reach,","his friends say he is looking for the pot of gold at the end of the rainbow."].join(" "),ambient_purge:0,ambient_sample:0,mask_purge:4,mask_sample:30},{instructions:"Head side-to-side. Slowly turn head from side to side. Inhale 2 times at each extreme.",ambient_purge:0,ambient_sample:0,mask_purge:4,mask_sample:30},{instructions:"Head up-and-down. Slowly move head up and down. Inhale 2 times at each extreme.",ambient_purge:0,ambient_sample:0,mask_purge:4,mask_sample:30},{instructions:"finalize",ambient_purge:4,ambient_sample:9,mask_purge:0,mask_sample:0}],osha:["Normal breathing. In a normal standing position, without talking, the subject shall breathe normally","Deep breathing. In a normal standing position, the subject shall breathe slowly and deeply, taking caution so as not to hyperventilate","Turning head side to side. Standing in place, the subject shall slowly turn his/her head from side to side between the extreme positions on each side. The head shall be held at each extreme momentarily so the subject can inhale at each side.","Moving head up and down. Standing in place, the subject shall slowly move his/her head up and down. The subject shall be instructed to inhale in the up position (i.e., when looking toward the ceiling).","Talking. The subject shall talk out loud slowly and loud enough so as to be heard clearly by the test conductor. The subject can read from a prepared text such as the Rainbow Passage, count backward from 100, or recite a memorized poem or song.","Grimace. The test subject shall grimace by smiling or frowning. (This applies only to QNFT testing; it is not performed for QLFT)","Bending over. The test subject shall bend at the waist as if he/she were to touch his/her toes. Jogging in place shall be substituted for this exercise in those test environments such as shroud type QNFT or QLFT units that do not permit bending over at the waist.","Normal breathing. Same as exercise (1)."],Singing:[{ambient_purge:4,ambient_sample:20,instructions:"prep",mask_purge:0,mask_sample:0},{ambient_purge:0,ambient_sample:0,instructions:"Sing!",mask_purge:4,mask_sample:240},{ambient_purge:4,ambient_sample:9,instructions:"finalize",mask_purge:0,mask_sample:0}]},"selected-protocol":"w1","keep-screen-awake":!0,"test-template":{},"enable-simulator":!1,"enable-auto-connect":!0,"simulator-file-speed":300,"selected-data-source":ee.WebSerial,"sync-device-state-on-connect":!1,"minutes-allotted-per-participant":20,"event-end-hhmm":"13:30","show-elapsed-participant-time":!1,"show-remaining-event-time":!1,"auto-create-fast-protocols":!1,"last-known-settings-keys-hash":"","use-compact-ui":!0,"enable-webserial-drivers":!1,"enable-protocol-editor":!1,"enable-qr-code-scanner":!1,"enable-stats":!1,"enable-test-instructions-zoom":!1,bookmarks:{},"mask-list":[],"participant-list":[],"auto-update-mask-list":!0,"color-scheme":"auto","show-mask-perf-graph":!1,"sample-mask-when-idle":!1,"use-idle-ambient-values":!1,"normalize-mask-list-names":!0,"auto-detect-baud-rate":!1,"enable-tester-mode":!1,"show-stddev":!1,"show-simulator-results":!0,"enable-control-source-widget":!1,"so-stats-first-date":new Date(0),"so-stats-last-date":new Date,"so-results-table-filter":[],"so-participant-results-table-filter":[],"so-combined-mask-list":[],"so-combined-participant-list":[],"so-test-notes":[],"so-control-source-in-view":!0,"so-sample-source-in-view":!0,"so-connection-status-in-view":!0,"so-activity":ue.Disconnected,"so-zoom-instructions":!1,"so-current-ambient-average":qe,"so-current-mask-average":qe,"so-is-protocol-running":!1,"so-connection-status":te.DISCONNECTED,"so-protocol-execution-state":"Idle","so-protocol-start-time":0,"so-stage-start-time":0,"so-current-stage-index":0,"default-to-previous-participant":!1,"show-protocol-editor":!1,"show-simple-protocol-editor":!1,"show-settings":!1,"show-log-panels":!1,"show-historical-tests":!1,"show-current-test-panel":!1};class Vn{cache=new Map;defaults=new Map;listeners=[];sessionConfigPrefix;constructor(e){this.sessionConfigPrefix=e||null}getStorageKey(e){return`config-${e}`}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(s=>e!==s)}setDefaults(e){e.forEach(s=>{this.setDefault(s.name,s.value)})}setDefault(e,s){this.defaults.set(e,s)}getConfig(e,s={}){const a=this.getStorageKey(e);if(!this.cache.has(e)){const r=this.isSessionOnlyConfig(e)?null:localStorage.getItem(a),i=r===null?this.getDefaultValue(e,s):JSON.parse(r);this.cache.set(e,i)}return this.cache.get(e)}isSessionOnlyConfig(e){return this.sessionConfigPrefix&&e.startsWith(this.sessionConfigPrefix)}getDefaultValue(e,s={}){const a=this.defaults.has(e)?this.defaults.get(e):s;return a===void 0&&console.warn(`No default value for ${e}, using ""`),a}setConfig(e,s){this.cache.get(e)!==s&&(this.cache.set(e,s),this.isSessionOnlyConfig(e)||localStorage.setItem(this.getStorageKey(e),xn(s)),this.dispatch(e,s))}dispatch(e,s){this.listeners.forEach(a=>{a.subscriptions().includes(e)&&(async()=>a.configChanged(e,s))()})}}const Le=new Vn("so-"),Wn=u.createContext(Le);var be=(t=>(t.SAMPLE="sample",t.PURGE="purge",t))(be||{});function zn(t){const e=[];let s=null,a=0;return t.forEach((r,i)=>{let o=0;r.mask_sample>0&&(s=(s??0)+1);const c=r.mask_sample>0?s:null;if(r.ambient_purge>0){const l={index:e.length,stage:r,stageIndex:i,exerciseNumber:c,source:k.AMBIENT,state:be.PURGE,protocolStartTimeOffsetSeconds:a,stageStartTimeOffsetSeconds:o,duration:r.ambient_purge,data:[]};e.push(l),a+=l.duration,o+=l.duration}if(r.ambient_sample>0){const l={index:e.length,stage:r,stageIndex:i,exerciseNumber:c,source:k.AMBIENT,state:be.SAMPLE,protocolStartTimeOffsetSeconds:a,stageStartTimeOffsetSeconds:o,duration:r.ambient_sample,data:[]};e.push(l),a+=l.duration,o+=l.duration}if(r.mask_purge>0){const l={index:e.length,stage:r,stageIndex:i,exerciseNumber:c,source:k.MASK,state:be.PURGE,protocolStartTimeOffsetSeconds:a,stageStartTimeOffsetSeconds:o,duration:r.mask_purge,data:[]};e.push(l),a+=l.duration,o+=l.duration}if(r.mask_sample>0){const l={index:e.length,stage:r,stageIndex:i,exerciseNumber:c,source:k.MASK,state:be.SAMPLE,protocolStartTimeOffsetSeconds:a,stageStartTimeOffsetSeconds:o,duration:r.mask_sample,data:[]};e.push(l),a+=l.duration}}),e}function He(t){return t.ambient_purge+t.ambient_sample+t.mask_purge+t.mask_sample}const Hn=new wn,Gn={type:"object",properties:{},additionalProperties:{type:"array",items:{oneOf:[{type:"string"},{oneOf:[{type:"object",properties:{title:{type:"string"},instructions:{type:"string"},ambient_purge:{type:"integer",minimum:0,maximum:10},ambient_sample:{type:"integer",minimum:0,maximum:60},mask_purge:{type:"integer",minimum:0,maximum:10},mask_sample:{type:"integer",minimum:0,maximum:600}},required:["instructions"],additionalProperties:!1}]}]}}},bt=Hn.compile(Gn),pe={defaultAmbientPurgeDuration:4,defaultAmbientSampleDuration:5,defaultMaskPurgeDuration:4,defaultMaskSampleDuration:40};function Kn(t){return typeof t=="string"?t.split(/\./)[0]:t.title??t.instructions.split(/\./)[0]??"oops no title or instructions?!"}function qn(t){return typeof t=="string"?t:t.instructions??t.i??t.instructions??t.i??"oops no instructions?!"}function Yn(t){return typeof t=="string"?pe.defaultAmbientSampleDuration:t.ambient_sample??t.as??t.ambient_duration??t.a??pe.defaultAmbientSampleDuration}function Xn(t){return typeof t=="string"?pe.defaultMaskSampleDuration:t.mask_sample??t.ms??t.sample_duration??t.s??pe.defaultMaskSampleDuration}function Zn(t){if(typeof t=="string")return pe.defaultAmbientPurgeDuration;let e;return(e=t.ambient_purge)!==void 0||(e=t.ap)!==void 0||(e=t.purge_duration)!==void 0||(e=t.p)!==void 0?e:t.ambient_duration===0||t.a===0?0:pe.defaultAmbientPurgeDuration}function Jn(t){if(typeof t=="string")return pe.defaultMaskPurgeDuration;let e;return(e=t.mask_purge)!==void 0||(e=t.mp)!==void 0||(e=t.purge_duration)!==void 0||(e=t.p)!==void 0?e:t.sample_duration===0||t.s===0?0:pe.defaultMaskPurgeDuration}function Qn(t){return t.some(e=>typeof e!="string")}function ea(t){const e={};return Object.entries(t).forEach(([s,a])=>{const r=[];e[s]=r,a.forEach(i=>{r.push({title:Kn(i),instructions:qn(i),ambient_sample:Yn(i),mask_sample:Xn(i),ambient_purge:Zn(i),mask_purge:Jn(i)})}),Qn(a)||r.push({title:"Finalizing",instructions:"Breathe normally while we sample the air.",ambient_purge:pe.defaultAmbientPurgeDuration,ambient_sample:pe.defaultAmbientSampleDuration,mask_purge:0,mask_sample:0})}),e}function ta(t){return t.mask_sample>0}function Ct(t){return t.reduce((e,s)=>e+(ta(s)?1:0),0)}class sa{_protocolStages=[];numExercisesForProtocol={};_listenerMap=new Map;constructor(){this.addListener({subscriptions:()=>[m.SELECTED_PROTOCOL],settingsChanged:(e,s)=>{e===m.SELECTED_PROTOCOL&&this.updateProtocolStages(s)}}),this.addListener({subscriptions:()=>[m.ENABLE_SIMULATOR],settingsChanged:(e,s)=>{e===m.ENABLE_SIMULATOR&&!s&&[ee.Simulator,ee.SimulatorFile].includes(this.getSetting(m.SELECTED_DATA_SOURCE))&&this.saveSetting(m.SELECTED_DATA_SOURCE,Le.getDefaultValue(m.SELECTED_DATA_SOURCE))}})}addListener(e){const s={subscriptions:()=>e.subscriptions?e.subscriptions():[],configChanged(a,r){e.settingsChanged&&e.settingsChanged(a,r)}};this._listenerMap.set(e,s),Le.addListener(s)}removeListener(e){const s=this._listenerMap.get(e);s&&Le.removeListener(s)}getDefault(e){return Le.getDefaultValue(e)}get selectedProtocol(){return this.getSetting(m.SELECTED_PROTOCOL)}set selectedProtocol(e){console.log(`set selected protocol ${e}`),e in this.protocolDefinitions?this.saveSetting(m.SELECTED_PROTOCOL,e):console.log(`trying to set an invalid protocol name: ${e}, ignoring`)}get protocolStages(){return this._protocolStages}set protocolStages(e){this._protocolStages=e}get eventEndTime(){const e=new Date,[s,a]=this.getSetting(m.EVENT_END_HHMM).split(":");return e.setHours(Number(s),Number(a),0,0),e}set eventEndTime(e){const s=`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`;this.saveSetting(m.EVENT_END_HHMM,s)}get numExercises(){return Ct(this.protocolStages)}get sayEstimatedFitFactor(){return this.getSetting(m.SAY_ESTIMATED_FIT_FACTOR)}set sayEstimatedFitFactor(e){this.saveSetting(m.SAY_ESTIMATED_FIT_FACTOR,e)}get verboseSpeech(){return this.getSetting(m.VERBOSE)}set verboseSpeech(e){this.saveSetting(m.VERBOSE,e)}get sayParticleCount(){return this.getSetting(m.SAY_PARTICLE_COUNT)}set sayParticleCount(e){this.saveSetting(m.SAY_PARTICLE_COUNT,e)}get speechEnabled(){return this.getSetting(m.SPEECH_ENABLED)}set speechEnabled(e){this.saveSetting(m.SPEECH_ENABLED,e)}getProtocolDefinition(e){return this.protocolDefinitions[e]||[]}getProtocolNames(){return Object.keys(this.protocolDefinitions)}resetToDefault(e){console.debug(`resetting setting ${e} to defaults`);const s=this.getDefault(e);return this.saveSetting(e,s),s}get protocolDefinitions(){try{const e=ea(this.getSetting(m.PROTOCOL_INSTRUCTION_SETS));if(bt(e))return e;console.log("Protocol definitions could not be validated")}catch(e){console.warn("Exception while parsing protocol definitions:",e)}return console.debug("resetting protocol definitions to default"),this.resetToDefault(m.PROTOCOL_INSTRUCTION_SETS)}getTestTemplate(){return this.getSetting(m.TEST_TEMPLATE)}async getActualSetting(e){return this.getSetting(e)}getSetting(e){return Le.getConfig(e)}async loadAllSettings(){const e=this.protocolDefinitions;for(const s of Object.keys(e)){const a=e[s];this.numExercisesForProtocol[s]=Ct(a)}}saveSetting(e,s){Le.setConfig(e,s)}updateProtocolStages(e){console.debug(`updateProtocolStages ${e}`);const s=this.protocolDefinitions[e];s&&(this.protocolStages=s)}getProtocolDuration(e){return(this.protocolDefinitions[e]??[]).reduce((a,r)=>a+He(r),0)}getProtocolTimeRemaining(){const e=this.getSetting(m.SELECTED_PROTOCOL),s=this.getSetting(m.CURRENT_STAGE_INDEX),a=this.getSetting(m.STAGE_START_TIME),r=this.protocolDefinitions[e]??[],i=r[s],o=Date.now()-a;return r.filter((l,d)=>s<d).reduce((l,d)=>l+1e3*He(d),Math.max(0,1e3*He(i)-o))}}const Re=new sa,na={med:"M",medium:"M",small:"S",large:"L","ear loop":"earloop","head strap":"headstrap","head loop":"heeadstrap",headloop:"headstrap"},aa=["headstrap","earloop","adhesive"],ra=["unspecified","XXS","XS","S","M","L","XL","XXL","Kids","Adult Regular"],ia=["unknown","3M","ACI","BNX","Benehal","Blox","Bluna","Breatheteq","Champak","Drager","Envo","Flo","Gerson","Jackson","Laianzhi","Lighthouse","Omnimask","Powecom","Rackmask","Readimask","Trident","Vitacore","Vog","WellBefore","Zero","Zimi"],et="[,;]";class oa{_maker;_model;_size;_color;_attachmentType;_shape;constructor(e,s,a,r,i,o="unspecified"){this._maker=e,this._model=s,this._size=a,this._color=r,this._attachmentType=i,this._shape=o}get shortName(){return[this.maker,this.model].join(" ")}get normalizedName(){return[this.maker,this.model,this.size,this.color,this.attachmentType].join(" ").replaceAll(new RegExp(`(?<=\\s)${et}*(?=\\s)`,"ig")," ").replaceAll(/\s+/g," ").trim()}get maker(){return this._maker}set maker(e){this._maker=e}get model(){return this._model}set model(e){this._model=e}get size(){return this._size}set size(e){this._size=e}get color(){return this._color}set color(e){this._color=e}get attachmentType(){return this._attachmentType}set attachmentType(e){this._attachmentType=e}get shape(){return this._shape}set shape(e){this._shape=e}}function Ps(t){return Pt(t).normalizedName}function Pt(t){const e=new oa,s=(t??"").replaceAll(/\s+/g," ");let r=Object.entries(na).toSorted(([o],[c])=>c.length-o.length).reduce((o,[c,l])=>o.replaceAll(new RegExp(`${c}`,"ig"),l),s),i=r.toLowerCase();return ia.find(o=>{const c=i.match(new RegExp(`\\b${o.toLowerCase()}${et}*\\b`,"i"));if(c&&c.index!==void 0){const l=c.index;return e.maker=o,i=i.slice(0,l)+i.slice(l+c[0].length),r=r.slice(0,l)+r.slice(l+c[0].length),!0}else return!1}),ra.find(o=>{const c=i.match(new RegExp(`\\b${o}${et}*\\b`,"i"));if(c&&c.index!==void 0){const l=c.index;return e.size=o,i=i.slice(0,l)+i.slice(l+c[0].length),r=r.slice(0,l)+r.slice(l+c[0].length),!0}else return!1}),aa.find(o=>{const c=i.match(new RegExp(`\\b${o}${et}*\\b`,"i"));if(c&&c.index!==void 0){const l=c.index;return e.attachmentType=o,i=i.slice(0,l)+i.slice(l+c[0].length),r=r.slice(0,l)+r.slice(l+c[0].length),!0}else return!1}),i.split(/\s+/).find(o=>CSS.supports("color",o)?(e.color=o,i=i.replace(o,""),r=r.replace(new RegExp(o,"i"),""),!0):!1),r.length>0&&(e.model=r.replaceAll(/\s+/g," ").trim(),r=""),e}function ie(t,e=!1,s=!0){const a=Math.abs(t),r=Math.round(a%1e3),i=Math.floor(a/1e3),o=i%60,c=Math.floor(i/60),l=c%60,d=Math.floor(c/60),h=s?`:${o.toString().padStart(2,"0")}`:"",p=e&&s&&r>0?`.${r.toString().padStart(3,"0")}`:"",g=d||!s;return`${t<0?"-":""}${g?`${d}:`:""}${l.toString().padStart(g?2:1,"0")}${h}${p}`}function ca(t,e=!1){return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}${e?`:${t.getSeconds().toString().padStart(2,"0")}`:""}`}function we(t){return 100*(1-1/t)}function la(t){return 1/(1-t/100)}function vt(t){return t>99.99?">99.99":t>99.9?t.toFixed(2):t>90?t.toFixed(1):t>0?t.toFixed(0):"?"}function qt(t){return t.toFixed(t<10?1:0)}function Lt(t){return vt(we(t))}function ua(t){switch(t){case te.DISCONNECTED:return"connection-status status-disconnected";case te.WAITING:return"connection-status status-waiting";case te.RECEIVING:return"connection-status status-receiving";default:return"connection-status"}}function da(t){const e=t.match(/rgb(?<hasAlpha>a)?\((?<r>\d+),\s*(?<g>\d+),\s*(?<b>\d+)(,\s*(?<a>\d+))?\)/)||t.match(/color\((?<srgb>s)rgb(-linear)?\s+(?<r>[\d.]+)\s+(?<g>[\d.]+)\s+(?<b>[\d.]+)\)/)||t.match(/(?<oklab>oklab)\((?<L>[\d.]+)\s+(?<a>[\d.-]+)\s+(?<B>[\d.-]+)(\s+(?<A>[\d.]+))?\)/);if(!e||!e.groups)return console.debug(`no match for ${t}`),"black";const{r:s,g:a,b:r,srgb:i,oklab:o,L:c}=e.groups;if(o)return Number(c)>.5?"black":"white";{const l=i?1:255,d=2.2;return .2126*Math.pow(Number(s)/l,d)+.7152*Math.pow(Number(a)/l,d)+.0722*Math.pow(Number(r)/l,d)>Math.pow(.5,d)?"black":"white"}}function ha(t,e=!0){if(!e&&!t||(t=Number(t),isNaN(t)||t<=0))return"whitesmoke";const s=100*(1-1/t);if(s>99)return"darkgreen";if(s>=95){const a=Math.round(100*(99-s)/4),r=100-a;return`color-mix(in srgb, yellowgreen ${a}%, darkgreen ${r}%)`}if(s>=80){const a=Math.round(100*(95-s)/15),r=100-a;return`color-mix(in srgb, darkorange ${a}%, yellowgreen ${r}%)`}if(s>0){const a=Math.round(100*(80-s)/80),r=100-a;return`color-mix(in srgb, darkred ${a}%, darkorange ${r}%)`}return"darkred"}function ma(t,e){return!e&&!t?"result-cell":(t=Number(t),isNaN(t)||t<=0?"result-cell aborted":t>=100?"result-cell very-high-fit-score":t>=33?"result-cell high-fit-score":t>=20?"result-cell moderate-fit-score":"result-cell low-fit-score")}function ga(t,e=0,s=-1){return t.slice(e,s).reduce((a,r)=>a+r,0)}function Ls(...t){return Os(t)}function Os(t,e=0,s=-1){return s<0&&(s=t.length),ga(t,e,s)/(s-e)}function _t(t){return isNaN(t)||_s(t)||Ns(t)?"?":t>=1e4?Math.round(t/1e3).toFixed(0)+"k":(t.toFixed||console.debug("unexpected value:",t),t.toFixed(0))}function Ue(t){return isNaN(t)||_s(t)||Ns(t)||t<1||!bn(t)?"?":t<10?t.toFixed(2):_t(t)}function ht(t){if(t.length===0)return 0;const e=t.toSorted();if(e.length%2===0){const s=e.length/2;return(e[s-1]+e[s])/2}else{const s=Math.floor(e.length/2);return e[s]}}const Be=Intl.Collator("en",{sensitivity:"base"});function fa(){return window.navigator.userAgent.includes("Mobi")}function pa(t,e){return(e.ParticleCounts??[]).filter(s=>s.type===k.MASK).at(t-1)}function ks(t){const[,e]=t.reduce(([i,o],c,l)=>{const d=i+(c-i)/(l+1),h=o+(c-i)*(c-d);return[d,h]},[0,0]),s=e/t.length,a=Math.sqrt(s);return{mean:t.reduce((i,o)=>i+o,0)/t.length,stddev:a,num:t.length}}function Ds(t){const{stddev:e,mean:s}=ks(t.data.map(a=>a.concentration));return{average:s>10?Math.round(s):Number(Math.max(.01,s).toFixed(2)),stddev:e}}function Ge(t){return Ds(t).average}function Sa(t){const e=Object.entries(t).filter(([s])=>s.startsWith("Ex ")).map(([,s])=>Number(s)).filter(s=>isFinite(s)&&s>1);return e.length/e.reduce((s,a)=>s+1/a,0)}class at{static DEFAULT_MAX_AGE_MS=60*1e3;history=[];source;maxAgeMs;settingName;nextSampleTimeMs=0;constructor(e,s=at.DEFAULT_MAX_AGE_MS){this.source=e,this.maxAgeMs=s,this.settingName=e===k.AMBIENT?m.CURRENT_AMBIENT_AVERAGE:m.CURRENT_MASK_AVERAGE}particleConcentrationReceived(e){const s=Date.now();if(e.sampleSource===this.source&&s>this.nextSampleTimeMs){this.history.push(e);const a=this.history.findLastIndex(r=>s-r.timestamp>this.maxAgeMs);a>-1&&this.history.splice(0,a+1),Re.saveSetting(this.settingName,this.getStats(10*60*1e3,0))}}getEvents(e){const s=Date.now();return this.history.filter(a=>s-a.timestamp<e)}getStats(e,s=5){const a=this.getEvents(e);return a.length<s?(console.debug(`${this.source} collector not enough samples for ${s} samples with max age ${e}ms; only have ${a.length} samples.`),qe):ks(a.map(r=>r.concentration))}isPurging(){return Date.now()<this.nextSampleTimeMs}reset(e=0){e&&(this.nextSampleTimeMs=Date.now()+e),this.history.splice(0),this.resetStats(this.settingName)}resetStats(e){Re.saveSetting(e,qe)}}const Yt=new TextDecoder("utf-8");async function*Ms(t){async function e(){const c=await t.read();return!c.done&&c.value,c}let{value:s,done:a}=await e(),r=s?Yt.decode(s,{stream:!0}):"";const i=/\r\n|\n|\r/gm;let o=0;for(;;){const c=i.exec(r);if(!c){if(a)break;const d=r.substring(o);({value:s,done:a}=await e()),r=d+(s?Yt.decode(s,{stream:!0}):""),o=i.lastIndex=0;continue}yield r.substring(o,c.index),o=i.lastIndex}o<r.length&&(yield r.substring(o))}function Xt(t){return new ReadableStream({start(e){s().catch(a=>e.error(a));async function s(){return t.dataRequest().then(a=>a.length===0?(Ye("No data from source: closing"),e.close(),new Uint8Array):(e.enqueue(a),s()))}},cancel(){Ye("cancel() called on underlying source"),t.close()}})}class js{_closed=!1;close(){this.closeImpl(),this._closed=!0}set closed(e){this._closed=e}get closed(){return this._closed}}class ke extends js{static NO_MORE_DATA=new Promise(e=>e(new Uint8Array));static DEFAULT_BYTES_PER_SECOND=1200;static encoder=new TextEncoder;reader;linesSource;nextLine;lastLineTimestamp=0;buffer=new Uint8Array;bufferIndex=0;fileOrUrl;rateBytesPerSecond;lastRequestTime=0;constructor(e,s=ke.DEFAULT_BYTES_PER_SECOND){super(),this.fileOrUrl=e,this.rateBytesPerSecond=Math.max(s,1)}async dataRequest(){if(this.reader===void 0){if(typeof this.fileOrUrl=="string"?this.reader=await fetch(this.fileOrUrl).then(l=>{if(l.ok)return l.body?.getReader();throw new Error(`Failed to file: ${l.status}`)}):this.reader=this.fileOrUrl.stream().getReader(),!this.reader)return ke.NO_MORE_DATA;console.debug("simulator(file) started")}this.linesSource||(this.linesSource=Ms(this.reader));let e=0;if(this.bufferIndex>=this.buffer.length){if(!this.nextLine){const h=await this.linesSource.next();if(h.done)return ke.NO_MORE_DATA;this.nextLine=h.value}const d=/^(?<timestamp>\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d.\d{3}Z)\s*(?<rest>.+)$/i.exec(this.nextLine);if(d&&d.groups){const{timestamp:h,rest:p}=d.groups,g=Date.parse(h);e=this.lastLineTimestamp?g-this.lastLineTimestamp:0,this.lastLineTimestamp=g,this.buffer=ke.encoder.encode(p+`\r
`)}else this.buffer=ke.encoder.encode(this.nextLine+`\r
`);this.bufferIndex=0,this.nextLine=void 0}let s=Date.now(),a=e;s===this.lastRequestTime&&(a+=50,s+=a,a>50&&console.debug(`simulator: next data chunk available ${ie(a)}`));const r=s-(this.lastRequestTime||s-1e3);this.lastRequestTime=s;const i=Math.ceil(r*this.rateBytesPerSecond/1e3),o=this.bufferIndex+(this.bufferIndex+i<this.buffer.length?i:this.buffer.length),c=this.buffer?.slice(this.bufferIndex,o);return this.bufferIndex+=c.length,new Promise(l=>{a?setTimeout(()=>{l(c)},a):l(c)})}closeImpl(){}}function Ye(t){console.log(`source: ${t}`)}const ne=new class{_synth;speechEnabled=!1;_allVoices=[];selectedVoice=null;speechRate=1;constructor(){}findDefaultVoice(){const e=this.allVoices.find(s=>s.default);return e||null}findVoiceByName(t){return this.allVoices.find(e=>e.name===t)||null}ensureSynthInitialized(){this._synth||(this._synth=this.initSynth(),console.debug("init synth"))}initSynth(){const t=window.speechSynthesis;return this.updateVoiceList(t.getVoices()),t.onvoiceschanged=()=>{this.updateVoiceList(t.getVoices())},t}get synth(){return this.ensureSynthInitialized(),this._synth}updateVoiceList(t){this._allVoices=t.filter(e=>e.lang.startsWith("en")).sort((e,s)=>`${e.lang} ${e.name}`.localeCompare(`${s.lang} ${s.name}`))}setSelectedVoice(t){this.selectedVoice=t}getSelectedVoice(){return this.selectedVoice}get allVoices(){return this.ensureSynthInitialized(),this._allVoices}setSpeechEnabled(t){this.speechEnabled=t}isSayingSomething(){return this.synth.speaking}sayItLater(t){if(!this.speechEnabled)return;const e=new SpeechSynthesisUtterance(t);e.voice=this.selectedVoice,e.rate=this.speechRate,this.synth.speak(e)}sayIt(t){if(!this.speechEnabled)return;console.log(`using voice ${this.selectedVoice?.name} say it ${t}`);const e=new SpeechSynthesisUtterance(t);e.voice=this.selectedVoice,e.rate=this.speechRate,this.synth.speaking?(this.synth.cancel(),setTimeout(()=>this.synth.speak(e),60)):this.synth.speak(e)}sayItPolitely(t){if(this.isSayingSomething()){console.log(`say it politely yielding. ${t}`);return}this.sayIt(t)}};class ye{static PARTICLE_COUNT=/^(?<timestamp>\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d.\d{3}Z)?\s*(?<concentration>\d+\.\d+)\s*/;static SAMPLING_FROM_MASK=/^VF$/;static SAMPLING_FROM_AMBIENT=/^VN$/;static DATA_TRANSMISSION_DISABLED=/^ZD$/;static DATA_TRANSMISSION_ENABLED=/^ZE$/;static EXTERNAL_CONTROL=/^(OK|EJ)$/;static INTERNAL_CONTROL=/^G$/;static TURN_POWER_OFF=/^Y$/;static N95_COMPANION_PATTERN=/^Q(?<connected>[YN])/i;static SETTINGS_PATTERN=/^S.+$/}class M{static INVOKE_EXTERNAL_CONTROL="J";static RELEASE_FROM_EXTERNAL_CONTROL="G";static TEST_TO_SEE_N95_COMPANION_IS_ATTACHED="Q";static SWITCH_VALVE_ON="VN";static SWITCH_VALVE_OFF="VF";static DISABLE_CONTINUOUS_DATA_TRANSMISSION="ZD";static ENABLE_CONTINUOUS_DATA_TRANSMISSION="ZE";static REQUEST_RUNTIME_STATUS_OF_BATTERY_AND_SIGNAL_PULSE="R";static REQUEST_VOLTAGE_INFO="C";static REQUEST_SETTINGS="S";static TURN_POWER_OFF="Y";static SET_MASK_SAMPLE_TIME="PTMxxvv";static SET_AMBIENT_SAMPLE_TIME="PTA00vv";static SET_MASK_SAMPLE_PURGE_TIME="PTPM0vv";static SET_AMBIENT_SAMPLE_PURGE_TIME="PTPA0vv";static SET_FIT_FACTOR_PASS_LEVEL="PPxxvvvvv";static DISPLAY_CONCENTRATION_ON_PORTACOUNT_PLUS="Dxxxxxx.xx";static DISPLAY_FIT_FACTOR_PASS_LEVEL_ON_PORTACOUNT_PLUS="Lxxxxxx";static DISPLAY_FIT_FACTOR_ON_PORTACOUNT_PLUS="Fxxxxxx.x";static DISPLAY_OVERALL_FIT_FACTOR_ON_PORTACOUNT_PLUS="Axxxxxx.x";static DISPLAY_EXERCISE_NUMBER_ON_PORTACOUNT_PLUS="Ixxxxxxxx";static CLEAR_DISPLAY_ON_PORTACOUNT_PLUS="K";static SOUND_BEEPER_INSIDE_THE_PORTACOUNT_PLUS="Bxx";static expectedCommandResponses=new Map([[M.INVOKE_EXTERNAL_CONTROL,ye.EXTERNAL_CONTROL]]);writer=null;encoder=new TextEncoder;verifiedToBeExternallyControllable=!1;portaCountClient;commandChain;constructor(e){this.portaCountClient=e}setWriter(e){this.writer=e}sendCommand(e,s=1){if(!this.writer){console.log("external control writer not available");return}const a=`${e}\r`,r=M.expectedCommandResponses.get(e)||RegExp(`^${e}`),i=this.encoder.encode(a),o=()=>new Promise((c,l)=>{let d=!1,h=s,p;const g=()=>{clearTimeout(p),this.portaCountClient.removeListener(f)},f={lineReceived:b=>{(r?r.exec(b):e===b)?(d=!0,g(),c()):b.startsWith("E")&&(console.debug(`got an error response for command ${e}: ${b}`),v())}},T=()=>{this.writer.write(i)},E=()=>{p&&clearTimeout(p),p=setTimeout(v,3e3)},v=()=>{if(d){console.debug(`retry handler triggered but we've already received the expected response for command '${e}'`);return}h>0?(console.debug(`retrying command '${e}'`),h--,T(),E()):(r?l(`too many retries, giving up on command '${e}'`):(console.debug(`no explicit expected response for command '${e}', but also didn't receive any other recognized response`),c()),g())};this.portaCountClient.addListener(f),T(),h>0&&E()});this.commandChain?this.commandChain=this.commandChain.then(o).catch(()=>{}):this.commandChain=o()}set controlSource(e){e===B.Internal?this.releaseManualControl():(this.assumeManualControl(),this.verifiedToBeExternallyControllable||this.verifyExternalControllability())}set sampleSource(e){e===k.AMBIENT?this.sampleAmbient():this.sampleMask()}assumeManualControl(){this.sendCommand(M.INVOKE_EXTERNAL_CONTROL)}releaseManualControl(){this.sendCommand(M.RELEASE_FROM_EXTERNAL_CONTROL)}enableDataTransmission(){this.sendCommand(M.ENABLE_CONTINUOUS_DATA_TRANSMISSION)}disableDataTransmission(){this.sendCommand(M.DISABLE_CONTINUOUS_DATA_TRANSMISSION)}sampleAmbient(){this.sendCommand(M.SWITCH_VALVE_ON)}sampleMask(){this.sendCommand(M.SWITCH_VALVE_OFF)}requestSettings(){this.sendCommand(M.REQUEST_SETTINGS)}requestRuntimeStatus(){this.sendCommand(M.REQUEST_RUNTIME_STATUS_OF_BATTERY_AND_SIGNAL_PULSE)}powerOff(){this.sendCommand(M.TURN_POWER_OFF),ne.sayItLater("Power off")}beep(e=2){this.sendCommand(`B${String(e).padStart(2,"0")}`)}verifyExternalControllability(){let e=0;const s={lineReceived(){e=Date.now()}};this.portaCountClient.addListener(s),this.beep(),this.beep(),setTimeout(()=>{this.portaCountClient.removeListener(s),Date.now()-e>3e3?console.log("Could not verify that we can externally control the device"):this.verifiedToBeExternallyControllable=!0},5e3)}}class Ta{supportedBaudRates=[300,600,1200,2400,9600];async readFromReader(e){const s=await e.read();return!s.done&&s.value,s}async openPortWithAutoDetectedBaudRate(e,s=this.supportedBaudRates.length-1){if(s<0)return console.debug("baud rate auto-detect unsuccessful. giving up."),0;const a=this.supportedBaudRates[s];return console.log(`auto-detecting baud rate... trying ${a}...`),e.open({baudRate:Number(a)}).then(()=>e.readable?e.readable:Promise.reject("reader not ready")).then(r=>r.getReader()).then(async r=>{let i=0,o=30;try{for(;o>0;){const{value:c,done:l}=await this.readFromReader(r);if(l){console.debug("autobaud / reader done");break}const d=new TextDecoder("utf-8"),h=c?d.decode(c,{stream:!0}):"";if(h.match(/^\s*$/)){console.debug("ignoring whitespace");continue}if(o-=h.length,i+=this.looksLikeAscii(h),i<-5)return this.openPortWithAutoDetectedBaudRate(e,s-1);if(i>5)return a}return o>0?(console.warn("reader closed before enough data was read, retrying..."),this.openPortWithAutoDetectedBaudRate(e,s)):(console.warn(`autobaud inconclusive for ${a}`),this.openPortWithAutoDetectedBaudRate(e,s-1))}finally{r.releaseLock()}})}looksLikeAscii(e){const s=e.match(/[a-zA-Z0-9#:./\s]/g),r=(s?s.length:0)*2-e.length;return console.debug(`looksLikeAscii(${e}) = ${r}`),r}}const ce=class{static PORTACOUNT_VERSION=/^PORTACOUNT\s+PLUS\S+PROM\S+(?<version>.+)/i;static COPYRIGHT=/^COPYRIGHT.+/i;static LICENSE=/^ALL\s+RIGHTS\s+RESERVED/i;static SERIAL_NUMBER=/^Serial\s+Number\s+(?<serialNumber>\d+)/i;static PASS_LEVEL=/^FF\s+pass\s+level\s+(?<passLevel>\d+)/i;static NUM_EXERCISES=/^No\.\s+of\s+exers\s*=\s*(?<num_exercises>\d+)/i;static AMBIENT_PURGE=/^Ambt\s+purge\s*=\s*(?<ambientPurgeTime>\d+)/i;static AMBIENT_SAMPLE=/^Ambt\s+sample\s*=\s*(?<ambientSampleTime>\d+)/i;static MASK_PURGE=/^Mask\s+purge\s*=\s*(?<maskPurgeTime>\d+)/i;static MASK_SAMPLE=/^Mask\s+sample\s+(?<exerciseNumber>\d+)\s*=\s*(?<maskSampleTime>\d+)/i;static DIP_SWITCH=/^DIP\s+switch\s+=\s+(?<dipSwitchBits>\d+)/i;static COUNT_READING=/^(?<timestamp>\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d.\d{3}Z)?\s*Conc\.\s+(?<concentration>[\d.]+)/i;static NEW_TEST=/^NEW\s+TEST\s+PASS\s*=\s*(?<passLevel>\d+)/i;static AMBIENT_READING=/^Ambient\s+(?<concentration>[\d.]+)/i;static MASK_READING=/^Mask\s+(?<concentration>[\d+.]+)/i;static FIT_FACTOR=/^FF\s+(?<exerciseNumber>\d+)\s+(?<fitFactor>[\d.]+)\s+(?<result>.+)/;static TEST_TERMINATED=/^Test\s+Terminated/i;static OVERALL_FIT_FACTOR=/^Overall\s+FF\s+(?<fitFactor>[\d.]+)\s+(?<result>.+)/i;static LOW_PARTICLE_COUNT=/^(?<concentration>\d+)\/cc\s+Low\s+Particle\s+Count/i;static BATTERY_AND_PULSE_STATUS=/^R(?<battery>.)(?<pulse>.)$/;static VOLTAGE_INFO=/^(?<component>C[SBTCLPD])(?<value>.+)$/;static Setting=class{static Timing=class{static AMBIENT_PURGE=/^STPA\s+(?<duration>\d+)/i;static MASK_PURGE=/^STPM\s+(?<duration>\d+)/i;static AMBIENT_SAMPLE=/^STA\s+(?<duration>\d+)/i;static MASK_SAMPLE=/^STM(?<exercise_num>\d\d)(?<duration>\d+)/i};static FF_PASS_LEVEL=/^SP\s+(?<index>\d\d)(?<score>\d+)/i;static SERIAL_NUMBER=/^SS\s+(?<serial_number>\d+)/i;static RUN_TIME_SINCE_FACTORY_SERVICE=/^SR\s+(?<runtime>\d+)/i;static LAST_SERVICE_DATE=/^SD\s+0(?<month>\d\d)(?<year>\d\d)/i}};class Te{_timestamp;constructor(){this._timestamp=Date.now()}get timestamp(){return this._timestamp}asOf(e){return this._timestamp=e,this}}class Zt extends Te{line;constructor(e){super(),this.line=e}}class mt extends Te{sampleSource;constructor(e){super(),this.sampleSource=e}}class gt extends Te{dataTransmissionState;constructor(e){super(),this.dataTransmissionState=e}}class ft extends Te{source;constructor(e){super(),this.source=e}}class Jt extends Te{constructor(){super()}}class je extends Te{sampleSource;controlSource;concentration;stddev;constructor(e,s,a,r){super(),this.concentration=e,this.sampleSource=s,this.controlSource=a,this.stddev=r}}class pt extends Te{ff;exerciseNum;result;constructor(e,s,a){super(),this.ff=e,this.exerciseNum=s,this.result=a}}class Qt extends Te{constructor(){super()}}class es extends Te{constructor(){super()}}class Ze extends Te{connectionStatus;constructor(e){super(),this.connectionStatus=e}}class ts extends Te{activity;constructor(e){super(),this.activity=e}}class ve extends Te{settings;constructor(e){super(),this.settings=e}}class St extends Te{state;constructor(e){super(),this.state=e}}class Ea{numExercises=4;ambientPurge=0;maskPurge=0;ambientSample=0;maskSample=new Map;fitFactorPassLevel=new Map;serialNumber="?";runTimeSinceFactoryServiceSeconds=0;lastServiceDate=new Date(0)}class xa{_externalController;listeners=[];_state=new Is;_settings=new Ea;_baudRate=1200;_syncOnConnect=!1;baudRateDetector;constructor(){console.log("PortaCountClient8020 constructor called"),this._externalController=new M(this),this.addListener(this.stateUpdatingListener),this.baudRateDetector=new Ta}get baudRate(){return this._baudRate}set baudRate(e){this._baudRate=e}get syncOnConnect(){return this._syncOnConnect}set syncOnConnect(e){this._syncOnConnect=e}get externalController(){return this._externalController}get settings(){return this._settings}get state(){return this._state}setActivity(e){this.state.activity=e,this.dispatch(new ts(e))}stateUpdatingListener={connectionStatusChanged:e=>{Re.saveSetting(m.CONNECTION_STATUS,e),this.state.connectionStatus=e},controlSourceChanged:e=>{this.state.controlSource=e},sampleSourceChanged:e=>{this.state.sampleSource=e},dataTransmissionStateChanged:e=>{this.state.dataTransmissionState=e},lineReceived:e=>{this.state.lastLine=e}};async monitor(e){this.dispatch(new Ze(te.WAITING));for await(const s of Ms(e))this.state.connectionStatus===te.WAITING&&this.dispatch(new Ze(te.RECEIVING)),s.trim().length>0&&(this.dispatch(new Zt(s)),this.processLine(s));this.setActivity(ue.Disconnected),this.dispatch(new Ze(te.DISCONNECTED)),console.log("monitor reached end of reader")}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners.filter((s,a,r)=>s===e?(r.splice(a,1),!0):!1)}dispatch(e){this.listeners.forEach(s=>{switch(e.constructor.name){case ts.name:{s.activityChanged&&s.activityChanged(e.activity);break}case je.name:{s.particleConcentrationReceived&&s.particleConcentrationReceived(e);break}case Qt.name:{this.setActivity(ue.Idle),s.testTerminated&&s.testTerminated();break}case es.name:{this.setActivity(ue.Idle),s.testCompleted&&s.testCompleted();break}case pt.name:{s.fitFactorResultsReceived&&s.fitFactorResultsReceived(e);break}case Jt.name:{s.testStarted&&s.testStarted(e.timestamp);break}case ft.name:{s.controlSourceChanged&&s.controlSourceChanged(e.source);break}case gt.name:{s.dataTransmissionStateChanged&&s.dataTransmissionStateChanged(e.dataTransmissionState);break}case Zt.name:{s.lineReceived&&s.lineReceived(e.line);break}case mt.name:{s.sampleSourceChanged&&s.sampleSourceChanged(e.sampleSource);break}case Ze.name:{if(s.connectionStatusChanged){const a=e;s.connectionStatusChanged(a.connectionStatus)}break}case St.name:{s.stateChanged&&s.stateChanged(e.state);break}case ve.name:{s.settingsChanged&&s.settingsChanged(e.settings);break}default:console.error(`unsupported event: ${JSON.stringify(e)}`)}})}processConcentration(e,s){this.state.activity!==ue.Testing&&this.setActivity(ue.Counting);const a=Number(e.concentration),r=this.state.sampleSource,i=new je(a,r,s),o=e.timestamp;o&&i.asOf(Date.parse(o)),this.dispatch(i)}orderedLineProcessors=[[ye.PARTICLE_COUNT,e=>{this.processConcentration(e,B.External)}],[ce.COUNT_READING,e=>{this.processConcentration(e,B.Internal)}],[ce.AMBIENT_READING,e=>{const s=e.concentration;s&&this.dispatch(new je(Number(s),k.AMBIENT,B.Internal))}],[ce.MASK_READING,e=>{const s=e.concentration;s&&this.dispatch(new je(Number(s),k.MASK,B.Internal))}],[ce.FIT_FACTOR,e=>{this.setActivity(ue.Testing);const s=Number(e.fitFactor),a=Number(e.exerciseNumber),r=e.result;this.dispatch(new pt(s,a,r)),this._settings.numExercises<a&&(this._settings.numExercises=a,this.dispatch(new ve(this._settings)))}],[ce.NEW_TEST,()=>{this.setActivity(ue.Testing),this.dispatch(new Jt)}],[ce.TEST_TERMINATED,()=>{this.setActivity(ue.Idle),this.dispatch(new Qt)}],[ce.OVERALL_FIT_FACTOR,e=>{this.setActivity(ue.Idle);const s=Number(e.fitFactor),a=e.result;this.dispatch(new pt(s,"Final",a)),this.dispatch(new es)}],[ye.SAMPLING_FROM_MASK,()=>{this.dispatch(new mt(k.MASK))}],[ye.SAMPLING_FROM_AMBIENT,()=>{this.dispatch(new mt(k.AMBIENT))}],[ye.EXTERNAL_CONTROL,()=>{this.dispatch(new ft(B.External))}],[ye.INTERNAL_CONTROL,()=>{this.dispatch(new ft(B.Internal))}],[ye.DATA_TRANSMISSION_DISABLED,()=>{this.dispatch(new gt(xt.Paused))}],[ye.DATA_TRANSMISSION_ENABLED,()=>{this.dispatch(new gt(xt.Transmitting))}],[ce.Setting.FF_PASS_LEVEL,e=>{this._settings.fitFactorPassLevel.set(Number(e.index),Number(e.score)),this.dispatch(new ve(this._settings))}],[ce.Setting.Timing.MASK_SAMPLE,e=>{this._settings.maskSample.set(Number(e.exercise_num),Number(e.duration)),this.dispatch(new ve(this._settings))}],[ce.VOLTAGE_INFO,e=>{this._state.componentVoltages.set(e.component,Number(e.value)),this.dispatch(new St(this._state))}],[ce.Setting.Timing.MASK_PURGE,e=>{this._settings.maskPurge=Number(e.duration),this.dispatch(new ve(this._settings))}],[ce.Setting.Timing.AMBIENT_SAMPLE,e=>{this._settings.ambientSample=Number(e.duration),this.dispatch(new ve(this._settings))}],[ce.Setting.Timing.AMBIENT_PURGE,e=>{this._settings.ambientPurge=Number(e.duration),this.dispatch(new ve(this._settings))}],[ce.BATTERY_AND_PULSE_STATUS,e=>{this._state.batteryStatus=e.battery==="G"?"Good":"Bad",this._state.pulseStatus=e.pulse==="G"?"Good":"Bad",this.dispatch(new St(this._state))}],[ce.Setting.SERIAL_NUMBER,e=>{this._settings.serialNumber=e.serial_number,this.dispatch(new ve(this._settings))}],[ce.Setting.LAST_SERVICE_DATE,e=>{const s=Number(e.month)-1,a=Number(e.year),r=a+(a<61?2e3:1900);this._settings.lastServiceDate=new Date(r,s),this.dispatch(new ve(this._settings))}],[ce.Setting.RUN_TIME_SINCE_FACTORY_SERVICE,e=>{this._settings.runTimeSinceFactoryServiceSeconds=10*60*Number(e.runtime),this.dispatch(new ve(this._settings))}],[ce.NUM_EXERCISES,e=>{this._settings.numExercises=Number(e.num_exercises),this.dispatch(new ve(this._settings))}]];processLine(e){if(e.length===0)return;const s=e;this.orderedLineProcessors.find(([r,i])=>{const o=r.exec(s);return o?(o.groups?i(o.groups):i({}),!0):!1})||(s.match(/^E/)?console.warn(`error: ${s}`):s.match(/^W/)?console.warn(`write protected: ${s}`):console.warn(`portacount client: no parser for line: ${s}`))}connect(e){console.debug(`portacount client connect(${JSON.stringify(e)})`),e.connected&&e.readable?(console.debug("portacount client connect, connected; setting up reader and writer"),e.readable&&this.monitor(e.readable.getReader()),e.writable&&(this.externalController.setWriter(e.writable.getWriter()),this.syncOnConnect&&(console.debug("sync on connect"),this.waitUntilPortaCountIsReady().then(()=>{this.syncState()}).catch(s=>{console.warn(s)})))):(console.debug("portacount client connect not connected, attempting to connect..."),Re.getSetting(m.AUTO_DETECT_BAUD_RATE)&&e.readable?this.baudRateDetector.openPortWithAutoDetectedBaudRate(e).then(()=>{this.connect(e)}).catch(s=>{console.log(s)}):e.open({baudRate:Number(this.baudRate)}).then(()=>{console.log(`port opened: ${JSON.stringify(e.getInfo())}`),this.connect(e)}))}async waitUntilPortaCountIsReady(){return new Promise((e,s)=>{const a=Date.now(),r=setInterval(()=>{const c=Date.now()-a;console.debug(`elapsed ${c}`),c>65e3?(clearInterval(r),s(`waited too long for PortaCount to become ready. Elapsed ${ie(c)}.`)):this.externalController.sendCommand(M.INVOKE_EXTERNAL_CONTROL,0)},1e3),i=()=>{this.removeListener(o),clearInterval(r),console.debug("PortaCount is ready."),e()},o={controlSourceChanged:c=>{c===B.External&&i()},lineReceived:c=>{ye.N95_COMPANION_PATTERN.exec(c)&&i()}};this.addListener(o)})}syncState(){this.externalController.enableDataTransmission(),this.externalController.requestRuntimeStatus(),this.externalController.requestSettings(),this.externalController.sendCommand(M.REQUEST_VOLTAGE_INFO),this.externalController.beep(1),this.externalController.beep(1),this.externalController.beep(1)}}class Fs{db;dbName;version;defaultDataStores;openPromise;constructor(e,s=[],a=1){this.dbName=e,this.version=a,this.defaultDataStores=s}async getDataFromDataSource(e,s=()=>!0){return new Promise((a,r)=>{const i=this.openTransactionClassic("readonly"),o=[];if(!i){console.debug(`${this.dbName} database not ready`),r(`${this.dbName} database not ready`);return}const c=i.objectStore(e).openCursor(null,"next");c.onerror=l=>{console.error(`getAllDataFromDataSource openCursor request error ${l}`),r(`error ${l}`)},c.onsuccess=l=>{const d=c.result;d?(s(d.value)&&o.push(d.value),d.continue()):(console.debug(`${this.dbName} cursor done ${l}. got ${o.length} records`),a(o))}})}onOpenSuccess(e){this.db=e.result,console.debug(`${this.dbName} Database Opened`,this.db)}onOpenError(e){console.error(`${this.dbName} Database error: ${e.error?.message}`)}openTransactionClassic(e,s=this.defaultDataStores){if(!this.db){console.log(`${this.dbName} database not ready`);return}try{const a=this.db.transaction(s,e);return a.oncomplete=()=>{},a.onerror=r=>{console.warn(`${this.dbName} transaction error ${r}`)},a}catch(a){console.error(`${this.dbName} error opening transaction: ${a}`);return}}async openTransaction(e,s=this.defaultDataStores){return new Promise((a,r)=>{if(!this.db){console.debug(`${this.dbName} database not ready`),r(`${this.dbName} database not ready`);return}const i=this.db.transaction(s,e);i.oncomplete=()=>{},i.onerror=o=>{console.error(`${this.dbName} transaction error ${JSON.stringify(o)}`)},a(i)})}async get(e,s){return new Promise((a,r)=>{this.openTransaction("readonly").then(i=>{const o=i.objectStore(e).get(s);o.onsuccess=()=>{a(o.result)},o.onerror=c=>{const l=`${this.dbName} get(${s}) failed; error: ${c}`;console.error(l),r(l)}})})}async put(e,s){return new Promise((a,r)=>{this.openTransaction("readwrite").then(i=>{try{const o=i.objectStore(e).put(s);o.onsuccess=()=>{a(o.result)},o.onerror=c=>{const l=`${this.dbName} put(${JSON.stringify(s)}) failed; error: ${c}`;console.error(l),r(l)}}catch(o){r(`${o} value: ${JSON.stringify(s)}`)}})})}async delete(e,s){return new Promise((a,r)=>{this.openTransaction("readwrite").then(i=>{try{const o=i.objectStore(e).delete(s);o.onsuccess=()=>{a(o.result)},o.onerror=c=>{const l=`${this.dbName} delete(${s}) failed; error: ${c}`;console.error(l),r(l)}}catch(o){r(`${o}, key: ${s}`)}})})}async open(){return console.debug(`open called on ${this.dbName}`),this.openPromise?this.openPromise:this.db?this.db:(this.openPromise=new Promise((e,s)=>{const a=window.indexedDB.open(this.dbName,this.version);a.onsuccess=()=>{this.onOpenSuccess(a),e(a.result)},a.onerror=()=>{this.onOpenError(a),s(a.error?.message)},a.onupgradeneeded=()=>{this.onUpgradeNeeded(a)}}),this.openPromise)}close(){this.db?.close(),console.debug(`${this.dbName} closed`)}}class _e extends Fs{static DEFAULT_DB_NAME="fit-test-data-db";static TEST_RESULTS_OBJECT_STORE="test-results-table-data";constructor(e=_e.DEFAULT_DB_NAME){super(e,[_e.TEST_RESULTS_OBJECT_STORE],2)}onUpgradeNeeded(e){const s=e.result;console.warn(`${this.dbName} Database upgrade needed: ${s.name}`),s.createObjectStore(_e.TEST_RESULTS_OBJECT_STORE,{autoIncrement:!0,keyPath:"ID"})}keepRecords=[];async getData(e){return this.getDataFromDataSource(_e.TEST_RESULTS_OBJECT_STORE,e)}async createNewTest(e,s,a,r,i){const o=this.openTransactionClassic("readwrite");if(!o)return console.log("database not ready"),new Promise((d,h)=>h(`${this.dbName} database not ready`));const c={Time:e,ProtocolName:s,TestController:a,DataSource:r};i&&(c.DeviceID=i);const l=o?.objectStore(_e.TEST_RESULTS_OBJECT_STORE).add(c);return new Promise((d,h)=>{l.onerror=p=>{const g=`createNewTest request error ${p}`;console.log(g),h(g)},l.onsuccess=p=>{console.log(`createNewTest request complete: ${p}, new key is ${l.result}`),c.ID=Number(l.result),d(c)}})}async updateTest(e){return new Promise((s,a)=>{const r=this.openTransactionClassic("readwrite");if(!r){console.log("database not ready"),a(`${this.dbName} database not ready`);return}e.ID=Number(e.ID);const i=r.objectStore(_e.TEST_RESULTS_OBJECT_STORE).put(e);i.onerror=o=>{const c=`updateTest request error ${o}`;console.log(c),a(c)},i.onsuccess=()=>{s({ID:i.result})}})}async addRecord(e){const s=e;return delete s.ID,this.put(_e.TEST_RESULTS_OBJECT_STORE,s)}async addRecords(e){for(const s of e)await this.addRecord(s)}async deleteRecord(e){return this.deleteRecordById(e.ID)}async deleteRecordById(e){return this.delete(_e.TEST_RESULTS_OBJECT_STORE,e)}}const Ce=new _e;class De{}class ss extends De{instructions;constructor(e){super(),this.instructions=e}}class Ot extends De{estimate;constructor(e){super(),this.estimate=e}}class ba extends Ot{constructor(e){super(e)}}class Ca extends Ot{constructor(e){super(e)}}class va extends Ot{constructor(e){super(e)}}class ns extends De{line;constructor(e){super(),this.line=e}}class as extends De{message;constructor(e){super(),this.message=e}}class rs extends De{data;constructor(e){super(),this.data=e}}class is extends De{record;constructor(e){super(),this.record=nt(e)}}class os extends De{record;constructor(e){super(),this.record=nt(e)}}class _a extends De{}class Oe extends Fs{static DEFAULT_DB_NAME="raw-serial-line-data-db";static SERIAL_LINE_OBJECT_STORE="serial-line-data";constructor(e=Oe.DEFAULT_DB_NAME){super(e,[Oe.SERIAL_LINE_OBJECT_STORE],1)}onUpgradeNeeded(e){const s=e.result;console.warn(`Database upgrade needed: ${this.dbName}`),s.createObjectStore(Oe.SERIAL_LINE_OBJECT_STORE,{autoIncrement:!0,keyPath:"index"})}keepRecords=[];now=new Date;async getData(e){return this.getDataFromDataSource(Oe.SERIAL_LINE_OBJECT_STORE,e)}getSomeRecentLines(e){const s=this.openTransactionClassic("readonly");if(!s){console.debug(`${this.dbName} database not ready`);return}const a=s.objectStore(Oe.SERIAL_LINE_OBJECT_STORE).openCursor(null,"prev");let r=!1;a.onerror=i=>{console.log(`getSomeRecentLines openCursor request error ${i}`)},a.onsuccess=i=>{console.log(`getSomeRecentLines openCursor request complete: ${i}`);const o=a.result;if(o?(this.keepRecords.push(o.value),o.continue()):(console.log(`${this.dbName} cursor done`),r=!0),r)for(console.log(`collected ${this.keepRecords.length} records`);this.keepRecords.length>0;){const c=this.keepRecords.pop();c&&e(c)}}}addLine(e){const s=this.openTransactionClassic("readwrite");if(!s)return console.log(`${this.dbName} database not ready`),{};const a={timestamp:new Date().toISOString(),data:e},r=s.objectStore(Oe.SERIAL_LINE_OBJECT_STORE).add(a);r.onerror=i=>{console.error(`addRecord request error ${i}`)},r.onsuccess=()=>{}}}const rt=new Oe;class Na{listeners=[];resultsDatabase;currentTestData=null;lastExerciseNum=0;sampleSource=k.MASK;setResults;inProgressTestPromiseChain;controlSource=B.Internal;settings;_rawLines="";_processedData="";_logLines="";_dataSource=ee.NotInitialized;portaCountClient=null;constructor(){this.settings=Re,this.resultsDatabase=Ce}hasCurrentTestData(){return this.currentTestData!==null}get saveLinesToDb(){return this._dataSource!==ee.Simulator}set dataSource(e){this._dataSource=e}get dataSource(){return this._dataSource}get rawLines(){return this._rawLines}get logLines(){return this._logLines}get processedData(){return this._processedData}appendToRaw(e){this._rawLines+=e+`
`,this.dispatch(new ns(e))}appendToLog(e){this._logLines+=e,this.dispatch(new as(e))}appendToProcessedData(e){this._processedData+=e,this.dispatch(new rs(e))}setInstructions(e){this.dispatch(new ss(e))}setInstructionsForExercise(e){if(!this.settings.selectedProtocol)return;const s=this.settings.selectedProtocol,r=this.settings.getProtocolDefinition(s)[e-1],i=typeof r=="object"?"instructions"in r?r.instructions:r.i:r;i&&this.setInstructions(`Begin exercise ${e}: ${i}`)}recordTestComplete(e){e!==void 0&&(this.recordExerciseResult("Final",e),this.setInstructions(`Test completed; final score: ${Ue(e)}`));const s=()=>{console.log(`test complete, id ${this.currentTestData?.ID}, final score ${e}`),this.currentTestData=null};this.chain(s)}recordTestAborted(){const e=()=>{if(!this.currentTestData){console.log("no current row, ignoring");return}this.currentTestData[`Ex ${this.lastExerciseNum+1}`]="aborted",this.setInstructions("Test cancelled."),this.updateCurrentRowInDatabase(),console.log("test aborted")};this.chain(e)}chain(e){this.inProgressTestPromiseChain?this.inProgressTestPromiseChain=this.inProgressTestPromiseChain.then(e):e()}async recordTestStart(e,s=new Date().toLocaleString(),a=this.settings.selectedProtocol){if(!this.resultsDatabase){console.log("database not ready");return}if(!a){console.log("protocols not loaded (not ready)");return}this.lastExerciseNum=0;const r=await this.resultsDatabase.createNewTest(s,a,e,e===B.Manual?ee.Manual:this.dataSource,this.portaCountClient?.settings.serialNumber);this.currentTestData=r;const i=this.settings.getTestTemplate();for(const o in i)o in r||o.startsWith("Ex ")||o.startsWith("Final")||typeof i[o]=="string"&&(this.currentTestData[o]=i[o]);this.updateCurrentRowInDatabase(),console.log(`new test added: ${JSON.stringify(this.currentTestData)}`),this.dispatch(new is(r))}recordNextExerciseResult(e){this.recordExerciseResult(this.lastExerciseNum+1,e)}recordExerciseResult(e,s){const a=()=>{if(!this.currentTestData){console.log("no current row! ignoring");return}typeof e=="number"?(this.currentTestData[`Ex ${e}`]=`${Math.floor(s)}`,this.lastExerciseNum=e):this.currentTestData[`${e}`]=`${Math.floor(s)}`,this.updateCurrentRowInDatabase()};this.chain(a)}updateTest(e){if(e.ID){if(e.ID===this.currentTestData?.ID){const s=this.currentTestData;this.currentTestData=e,Object.entries(s).forEach(([a,r])=>{typeof r=="number"&&this.currentTestData&&this.currentTestData[a]!==r&&(this.currentTestData[a]=r,this.setResults&&this.setResults(i=>[...i]))})}this.resultsDatabase.updateTest(e)}else console.log(`updateTest() unexpected record with no ID: ${e}`)}updateCurrentRowInDatabase(){this.currentTestData&&(this.resultsDatabase.updateTest(this.currentTestData),this.dispatch(new os(this.currentTestData)))}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners.filter((s,a,r)=>s===e?(r.splice(a,1),!0):!1)}dispatch(e){this.listeners.forEach(s=>{switch(e.constructor.name){case is.name:{s.newTestStarted&&s.newTestStarted(e.record);break}case os.name:{s.currentTestUpdated&&s.currentTestUpdated(e.record);break}case _a.name:{s.tick&&s.tick();break}case ns.name:{s.logRawLine&&s.logRawLine(e.line);break}case as.name:{if(s.logMessage){const a=e;s.logMessage(a.message)}break}case rs.name:{if(s.logProcessedData){const a=e;s.logProcessedData(a.data)}break}case ba.name:{if(s.estimatedFitFactorChanged){const a=e;s.estimatedFitFactorChanged(a.estimate)}break}case va.name:{s.estimatedMaskConcentrationChanged&&s.estimatedMaskConcentrationChanged(e.estimate);break}case Ca.name:{s.estimatedAmbientConcentrationChanged&&s.estimatedAmbientConcentrationChanged(e.estimate);break}case ss.name:{if(s.instructionsChanged){const a=e;s.instructionsChanged(a.instructions)}break}}})}portaCountListener={lineReceived:e=>{e.trim().length>0&&(this.appendToRaw(e),this.saveLinesToDb&&rt.addLine(e))},sampleSourceChanged:e=>{console.log(`sampling from ${e}`),this.appendToLog(`sampling from ${e}
`),this.sampleSource=e},dataTransmissionStateChanged:e=>{this.appendToLog(`data transmission state: ${e}`)},testStarted:e=>{this.appendToProcessedData(`
Starting a new test. ${new Date(e).toLocaleString()}
`),this.setInstructionsForExercise(1),this.inProgressTestPromiseChain=this.recordTestStart(B.Internal,new Date(e).toLocaleString());const s=Date.now();this.settings.saveSetting(m.PROTOCOL_START_TIME,s),this.settings.saveSetting(m.STAGE_START_TIME,s),this.settings.saveSetting(m.CURRENT_STAGE_INDEX,0),this.settings.saveSetting(m.PROTOCOL_EXECUTION_STATE,"Executing")},controlSourceChanged:e=>{this.controlSource=e},fitFactorResultsReceived:e=>{const s=e.ff,a=e.exerciseNum,r=e.result;this.recordExerciseResult(a,s),typeof a=="number"?(this.appendToProcessedData(`Exercise ${a}: Fit factor is ${s}. Result: ${r}
`),this.setInstructionsForExercise(a+1),ne.sayItLater(`Score was ${s}`),this.settings.saveSetting(m.PROTOCOL_EXECUTION_STATE,"Executing"),this.settings.saveSetting(m.CURRENT_STAGE_INDEX,a-1),this.settings.saveSetting(m.STAGE_START_TIME,Date.now())):(this.appendToProcessedData(`
Test complete. ${r} with FF of ${s}
`),this.setInstructions(`Test complete. Score: ${s}`),this.appendToLog(JSON.stringify(this.currentTestData)+`
`),this.recordTestComplete(),ne.sayItLater(`Final score was ${s}`),this.settings.saveSetting(m.PROTOCOL_EXECUTION_STATE,"Idle"))},testTerminated:()=>{this.appendToProcessedData(`
Test aborted
`),this.recordTestAborted(),this.recordTestComplete(),this.settings.saveSetting(m.PROTOCOL_EXECUTION_STATE,"Idle")},particleConcentrationReceived:e=>{const s=()=>{if(this.currentTestData){e.controlSource===B.Internal&&this.recordParticleCount(e);return}const a=e.concentration;this.controlSource===B.External&&this.appendToProcessedData(`${this.sampleSource}: ${a}
`)};this.chain(s)}};recordParticleCount(e){if(!this.currentTestData)return;this.currentTestData.ParticleCounts||(this.currentTestData.ParticleCounts=[]);const s=e.stddev?{stddev:e.stddev}:{};this.currentTestData.ParticleCounts.push({type:e.sampleSource,count:e.concentration,...s}),this.updateCurrentRowInDatabase()}setPortaCountClient(e){this.portaCountClient=e,e.addListener(this.portaCountListener)}}class Xe{}class cs extends Xe{newSegment;constructor(e){super(),this.newSegment=e}}class ls extends Xe{segment;constructor(e){super(),this.segment=e}}class us extends Xe{}class ds extends Xe{}class hs extends Xe{}class wa{_portaCountClient;controller;listeners=[];_segments=[];_currentSegmentIndex;_lastAmbientSegment;dataCollector;_protocolStartTime=null;ambientSampleCollector;maskSampleCollector;constructor(e,s,a,r){this._portaCountClient=e,this.dataCollector=s,this.controller=e.externalController,this.ambientSampleCollector=a,this.maskSampleCollector=r,this._portaCountClient.addListener(this.getPortaCountListener()),this._portaCountClient.addListener(this.ambientSampleCollector),this._portaCountClient.addListener(this.maskSampleCollector)}getPortaCountListener(){return{controlSourceChanged:s=>{s===B.Internal&&this.cancel()},particleConcentrationReceived:s=>{if(s.controlSource!==B.Internal&&this.state!=="Idle"&&this.state!=="Paused"){if(!this.currentSegment){console.warn("protocol executor test is in progress but no current segment (shouldn't happen).");return}if(this.currentSegment.source!==s.sampleSource){switch(console.debug(`segment expecting data to be from source ${this.currentSegment.source} but received data from ${s.sampleSource}. ignoring, and switching valve position`),this.currentSegment.source){case k.AMBIENT:this.controller.sampleAmbient();break;case k.MASK:this.controller.sampleMask();break}return}if(this.currentSegment.data.push(s),this.dispatch(new ls(this.currentSegment)),this.currentSegmentHasEnoughData()){const a=this.closeSegment(this.currentSegment);a&&this.executeSegment(a)}}}}}currentSegmentHasEnoughData(){return this.currentSegment&&this.currentSegment.data.length>=this.currentSegment.duration}getSetting(e){return Re.getSetting(e)}saveSetting(e,s){Re.saveSetting(e,s)}get state(){return this.getSetting(m.PROTOCOL_EXECUTION_STATE)}set state(e){this.saveSetting(m.PROTOCOL_EXECUTION_STATE,e)}get segments(){return this._segments}set segments(e){console.debug("protocol executor updating segments"),this._segments=e}get protocolStartTime(){return this._protocolStartTime}set protocolStartTime(e){this._protocolStartTime=e}get lastAmbientSegment(){return this._lastAmbientSegment}set lastAmbientSegment(e){this._lastAmbientSegment=e}get currentSegment(){if(this._currentSegmentIndex!==void 0&&!(this._currentSegmentIndex>=this.segments.length))return this.segments[this._currentSegmentIndex]}set currentSegmentIndex(e){this._currentSegmentIndex=e,this.dispatch(new cs(this.currentSegment))}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners.filter((s,a,r)=>s===e?(r.splice(a,1),!0):!1)}set protocol(e){if(this.state==="Executing"){console.warn("attempted to set protocol while protocol is executing. ignoring. this is not allowed.");return}const s=Re.getProtocolDefinition(e);this.segments=zn(s)}async executeProtocol(e){if(this.state==="Executing"){console.log("protocol execution in progress (can't start another protocol)");return}if(e&&(this.protocol=e),this.segments.length===0){console.debug(`trying to execute protocol, but no segments found, protocolName: ${e}`);return}this.lastAmbientSegment=void 0,this.protocolStartTime=new Date,this.controller.assumeManualControl(),await this.dataCollector.recordTestStart(B.External,this.protocolStartTime.toLocaleString());let s=0;if(this.getSetting(m.USE_IDLE_AMBIENT_VALUES)&&(console.debug("trying to use idle ambient values"),this.segments.length>2&&this.segments[0].source===k.AMBIENT&&this.segments[1].source===k.AMBIENT&&this.segments[1].state===be.SAMPLE)){const a=this.segments[1].duration,r=this.ambientSampleCollector.getEvents(6e4).slice(-a);r.length===a&&(console.debug("using ambient values collected while idle"),this.segments[1].data.push(...r),s=this.closeSegment(this.segments[1]),this.controller.beep())}this.ambientSampleCollector.reset(),this.maskSampleCollector.reset(),this.executeSegment(s),this.controller.beep(),this.dispatch(new us)}dispatch(e){this.listeners.forEach(s=>{switch(e.constructor.name){case ls.name:{s.segmentDataUpdated&&s.segmentDataUpdated(e.segment);break}case cs.name:{s.segmentChanged&&s.segmentChanged(e.newSegment);break}case us.name:{s.started&&s.started();break}case ds.name:{s.cancelled&&s.cancelled();break}case hs.name:{s.completed&&s.completed();break}default:console.warn(`Unhandled event in dispatcher: ${e.constructor.name}`)}})}executeSegment(e){if(e>=this.segments.length){console.warn("trying to execute invalid segment with index: ",e);return}this.state="Executing";const s=this.segments[e];switch(s.segmentStartTimeMs=Date.now(),s.data.splice(0),this.currentSegmentIndex=e,this.saveSetting(m.CURRENT_STAGE_INDEX,s.stageIndex),(e===0||s.stageIndex!==this.segments[e-1].stageIndex)&&(this.saveSetting(m.CURRENT_STAGE_INDEX,s.stageIndex),this.saveSetting(m.STAGE_START_TIME,s.segmentStartTimeMs),s.exerciseNumber?ne.sayIt(`Exercise ${s.exerciseNumber}: ${s.stage.instructions}`):ne.sayIt(s.stage.instructions)),s.source){case k.AMBIENT:this.controller.sampleAmbient(),this.ambientSampleCollector.reset();break;case k.MASK:this.controller.sampleMask(),this.maskSampleCollector.reset();break}}updateValvePosition(){this.getSetting(m.SAMPLE_MASK_WHEN_IDLE)?(this.controller.sampleMask(),console.debug("sample mask when idle in effect")):this.getSetting(m.USE_IDLE_AMBIENT_VALUES)&&(this.controller.sampleAmbient(),console.debug("use idle ambient values in effect"))}pause(){console.log("pausing protocol");const e=this.currentSegment?.stageIndex;e!==void 0&&this.segments.filter(s=>s.stageIndex===e).forEach(s=>{s?.data.splice(0)}),this.state="Paused"}resume(){const e=this.currentSegment?.stageIndex;if(e===void 0){console.debug("can't resume: no current stage");return}this.resumeFromStage(e)}resumeFromStage(e){const s=this.segments.find(a=>a.stageIndex===e);if(s===void 0){console.debug("can't resume: can't determine first segment in current stage");return}console.debug(`resuming at segment ${s.index} stage ${s.stageIndex}`),this.dataCollector.setInstructions(""),this.saveSetting(m.CURRENT_MASK_AVERAGE,qe),this.executeSegment(s.index)}restartFromExercise(e){if(this.state!=="Paused"){console.debug(`can only restartFrom when Paused, current state is ${this.state}`);return}const s=this.segments.find(a=>a.exerciseNumber===e);if(s===void 0){console.debug(`can't restart from ex ${e}: can't determine stage for exercise ${e}`);return}this.resumeFromStage(s.stageIndex)}cancel(){this.protocolStartTime=null,console.log("cancelling protocol"),this.state="Idle",this.dataCollector.recordTestAborted(),this.dispatch(new ds),this.controller.beep(),this.updateValvePosition()}calculateFinalFitFactor(){const e=this.segments.filter(s=>s.calculatedScore!==void 0);return e.length/e.reduce((s,a)=>s+1/a.calculatedScore,0)}closeSegment(e){const s=(this.segments.length+e.index+1)%this.segments.length;if(e.state===be.PURGE){switch(e.source){case k.AMBIENT:this.ambientSampleCollector.reset();break;case k.MASK:this.maskSampleCollector.reset();break}return s}const{average:a,stddev:r}=Ds(e);if(this.dataCollector.recordParticleCount(new je(a,e.source,B.External,Math.round(r))),e.source===k.AMBIENT){if(this.lastAmbientSegment){const i=Ls(Ge(this.lastAmbientSegment),a);for(let o=e.index-1;o>this.lastAmbientSegment.index;o--){const c=this.segments[o];if(c.state===be.SAMPLE){const l=Ge(c),d=i/l;isNaN(d)?console.debug(`ff2 is NaN. averageAmbient ${i}, ambient1`,this.lastAmbientSegment,`, ambient2 ${a}, maskConcentration ${l}, mask segment`,c,"all segments (getter)",this.segments,"all segments (direct)",this._segments):(console.debug(`updating ex ${c.exerciseNumber} score from ${c.calculatedScore} to ${d}`),c.calculatedScore=d,this.dataCollector.recordExerciseResult(c.exerciseNumber??0,c.calculatedScore))}}}this.lastAmbientSegment=e}else e.source===k.MASK&&(this.lastAmbientSegment?(e.calculatedScore=Ge(this.lastAmbientSegment)/a,this.dataCollector.recordExerciseResult(e.exerciseNumber??0,e.calculatedScore),this.controller.beep()):console.error("mask segment completed, but there was no last ambient segment."));return s===0&&this.closeProtocol(),s}closeProtocol(){console.log("no more segments (test completed)"),this.state="Idle";const e=this.calculateFinalFitFactor();this.dataCollector.recordTestComplete(e),this.dispatch(new hs),this.controller.beep(),this.controller.beep(),this.updateValvePosition()}}class ya{readable;writable;connected=!1;constructor(e,s){this.readable=e,this.writable=s}getInfo(){return{usbVendorId:-1337}}open(e){return console.debug(`todo: set simulator baud rate to ${e.baudRate}`),this.connected=!0,Promise.resolve()}}class Aa{reader;_readerController;writer;_port;_portaCountState=new Is;encoder=new TextEncoder;_started=!1;targetCount=2e3;targetCountVariancePct=10;targetMaskFF=100;targetMaskFFVariancePct=15;constructor(){this.reader=this.createReader(),this.writer=this.createWriter(),this._port=new ya(this.reader,this.writer)}get port(){return this._started=!0,this._port}stop(){this.reader.cancel("stop")}sendResponse(e){const s=this.encoder.encode(e);this._readerController?.enqueue(s)}createReader(){let e,s=!1;return new ReadableStream({pull:a=>{s=!0},start:a=>{console.debug("PortaCountSimulator started"),this._readerController=a,e=setInterval(()=>{if(this._started){const i=this.generateConcentration();s&&(s=!1,a.enqueue(this.encoder.encode(`${i}
`)))}},1e3)},cancel(){Ye("cancel() called on underlying source"),e&&clearInterval(e)}})}createWriter(){const e=new CountQueuingStrategy({highWaterMark:1}),s=new TextDecoder,a=this,r=/\r\n|\n|\r/gm;let i="";return new WritableStream({write:o=>{const c=s.decode(o);i+=c;const l=r.exec(i);if(l){const d=i.substring(0,l.index);i=i.substring(r.lastIndex),r.lastIndex=0,a.executeCommand(d)}},close(){},abort(o){console.debug(`abort: ${o}`)}},e)}getNextCount(){return Math.round(this.targetCount*(1+(Math.random()-.5)*2*this.targetCountVariancePct/100))}executeCommand(e){switch(e){case M.REQUEST_RUNTIME_STATUS_OF_BATTERY_AND_SIGNAL_PULSE:{this.sendResponse(`RGG
`);break}case M.REQUEST_VOLTAGE_INFO:{["CS191","CB483","CT236","CC065","CL614","CP255","CD068"].forEach(s=>{this.sendResponse(`${s}
`)});break}case M.REQUEST_SETTINGS:{["STPA 00004","STA  00005","STPM 00011","STM0100040","STM0200040","STM0300040","STM0400040","STM0500040","STM0600040","STM0700040","STM0800040","STM0900040","STM1000040","STM1100040","STM1200040","STM1300040","SP 0100100","SP 0200250","SP 0300500","SP 0401000","SP 0501250","SP 0601667","SP 0702000","SP 0804000","SP 0905000","SP 1006667","SP 1110000","SP 1200000","SS   17754","SR   00722","SD   00519"].forEach(s=>{this.sendResponse(`${s}
`)});break}case M.SWITCH_VALVE_OFF:{this._portaCountState.sampleSource=k.MASK,this.sendResponse(M.SWITCH_VALVE_OFF),this.sendResponse(`
`);break}case M.SWITCH_VALVE_ON:{this._portaCountState.sampleSource=k.AMBIENT,this.sendResponse(M.SWITCH_VALVE_ON),this.sendResponse(`
`);break}case M.INVOKE_EXTERNAL_CONTROL:{this._portaCountState.controlSource===B.External?this.sendResponse(`EJ
`):(this._portaCountState.controlSource=B.External,this.sendResponse(`OK
`));break}case M.RELEASE_FROM_EXTERNAL_CONTROL:{this._portaCountState.controlSource=B.Internal,this.sendResponse(`G
`);break}default:this.sendResponse(`${e}
`)}}generateConcentration(){let e;this._portaCountState.sampleSource===k.MASK?e=this.getNextCount()/(this.targetMaskFF*(1+(Math.random()-.5)*2*this.targetMaskFFVariancePct/100)):e=this.getNextCount();let s;return this._portaCountState.controlSource===B.External?s=`${e.toFixed(2).padStart(9,"0")}`:s=`Conc.${e.toFixed(e<10?2:0).padStart(10," ")} #/cc`,s}}class ms{device;driver;connected=!1;readable;writable;constructor(e,s){this.device=e,this.driver=s,this.readable=s.getReadableStreamFromDataSource(),this.writable=s.getWritableStreamFromDataSink()}getInfo(){return{usbVendorId:this.device.vendorId,usbProductId:this.device.productId}}async open(e){return new Promise((s,a)=>{this.driver.open(this.device,e).then(()=>{this.connected=!0,s(),console.log(`${this.driver.name} opened`)}).catch(a)})}}class kt extends js{options;name;noDataWaitTimeMs=300;readable;writable;inboundDataQueue=[];constructor(e){super(),this.name=this.constructor.name,this.options=e}getReadableStreamFromDataSource(){const e=this;return new ReadableStream({start(s){a().catch(r=>s.error(r));async function a(){return e.dataRequest().then(r=>r.length===0?(Ye("No data from source: closing"),s.close(),new Uint8Array):(s.enqueue(r),a()))}},cancel(){Ye("cancel() called on underlying source"),e.closeImpl()}})}getWritableStreamFromDataSink(){const e=new CountQueuingStrategy({highWaterMark:1}),s=new TextDecoder,a=this;return new WritableStream({write(r){const i=s.decode(r);return console.log(`sending to ${a.name}: ${i}`),new Promise((o,c)=>{a.write(r).then(l=>{console.log(`successfully sent to ${a.name}: ${l.status}, bytesWritten: ${l.bytesWritten}`),o()}).catch(l=>{console.log(`error sending to ${a.name}: ${l.toString()}`),c(l)})})},close(){console.log(`${a.name} sink closed`)},abort(r){console.log(`${a.name} Sink error:`,r)}},e)}async dataRequest(){if(this.inboundDataQueue.length===0)return console.debug(`dataRequest() called, closed? ${this.closed}`),this.closed?Promise.resolve(new Uint8Array):new Promise(s=>{setTimeout(()=>{this.dataRequest().then(a=>{s(a)})},this.noDataWaitTimeMs)});const e=this.inboundDataQueue.splice(0,this.inboundDataQueue.length);return new Promise(s=>{const a=e.reduce((i,o)=>i+o.length,0),r=new Uint8Array(a);e.reduce((i,o)=>(r.set(o,i),i+o.length),0),s(r)})}}class Ra extends kt{delegate;constructor(){super([{filters:[{vendorId:zt,productId:yn},{vendorId:zt,productId:An}]}])}async open(e,s){return new Promise((a,r)=>{this.delegate=new Rn(e,s),this.delegate.addEventListener("data",i=>{const o=i.detail;this.inboundDataQueue.push(o)}),this.delegate.addEventListener("ready",()=>{a(this)}),this.delegate.addEventListener("error",i=>{r(i)}),this.delegate.addEventListener("disconnected",()=>{console.debug(`disconnected from ${JSON.stringify(e)}`),this.closed=!0}),this.delegate.open()})}async closeImpl(){return this.delegate?.close()}async write(e){return this.delegate?this.delegate.write(e):new Promise((s,a)=>{a("not yet initialized")})}}class Ia extends kt{delegate;constructor(){super([{filters:[{vendorId:1659,productId:9123},{vendorId:1659,productId:8963}]}])}async open(e,s){return new Promise((a,r)=>{this.delegate=new In(e,s),this.delegate.addEventListener("data",i=>{const o=i.detail;this.inboundDataQueue.push(o)}),this.delegate.addEventListener("ready",()=>{a(this)}),this.delegate.addEventListener("error",i=>{r(i)}),this.delegate.addEventListener("disconnected",()=>{console.debug(`disconnected from ${JSON.stringify(e)}`),this.closed=!0}),this.delegate.open()})}async closeImpl(){return this.delegate?.close()}async write(e){return this.delegate?this.delegate.write(e):new Promise((s,a)=>{a("not yet initialized")})}}class Pa extends kt{delegate;constructor(){super([{filters:[{vendorId:1027,productId:24577}]}])}async open(e,s){return new Promise((a,r)=>{this.delegate=new Pn(e,s),this.delegate.addEventListener("data",i=>{const o=i.detail;this.inboundDataQueue.push(o)}),this.delegate.addEventListener("ready",()=>{a(this)}),this.delegate.addEventListener("error",i=>{r(i.detail)}),this.delegate.addEventListener("disconnected",()=>{console.debug(`disconnected from ${JSON.stringify(e)}`),this.closed=!0})})}async closeImpl(){return this.delegate.closeAsync()}async write(e){return this.delegate.writeAsync(e)}}class $e{static supportedDrivers=[new Pa,new Ia,new Ra];static async getPorts(){const e=[];return navigator.usb&&(await navigator.usb.getDevices()).forEach(a=>{const r=$e.findDriverForDevice(a);r&&e.push(new ms(a,r))}),e}async requestPort(){return new Promise((e,s)=>{const a=$e.supportedDrivers.flatMap(r=>r.options.flatMap(i=>i.filters));navigator.usb.requestDevice({filters:a}).then(r=>{const i=$e.findDriverForDevice(r);i?e(new ms(r,i)):s(`could not find driver for device ${JSON.stringify(r)}`)})})}static findDriverForDevice(e){return this.supportedDrivers.find(s=>s.options.flatMap(r=>r.filters).find(r=>r.vendorId==e.vendorId&&r.productId===e.productId))}}class La{listeners=[];intervalMs;intervalId;constructor(e=1e3){this.intervalMs=e}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners.filter((s,a,r)=>s===e?(r.splice(a,1),!0):!1)}tick(){const e=Date.now();this.listeners.forEach(s=>{s.tick(e)})}start(){this.intervalId=setInterval(()=>{this.tick()},this.intervalMs)}stop(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=void 0)}}const $s=new La;function Dt(t){const e=u.useContext(X),s=()=>{},a=u.useRef(s);u.useEffect(()=>{a.current=t},[t]),u.useEffect(()=>{const r={tick:()=>{a.current()}};return e.timingSignal.addListener(r),()=>e.timingSignal.removeListener(r)},[])}const U=Re,Ve=new Na,Ie=new xa,Us=new at(k.AMBIENT),Bs=new at(k.MASK),Vs=new wa(Ie,Ve,Us,Bs),Oa=new Aa;function ka(){Ve.setPortaCountClient(Ie)}function Da(){ne.synth.getVoices(),ne.setSpeechEnabled(U.getSetting(m.SPEECH_ENABLED));const t=ne.findVoiceByName(U.getSetting(m.SPEECH_VOICE));t&&ne.setSelectedVoice(t),Ie.addListener({particleConcentrationReceived(a){if(!ne.isSayingSomething()&&U.speechEnabled&&U.sayParticleCount){const r=a.concentration,i=Math.ceil(r),o=i<20?(Math.ceil(r*10)/10).toFixed(1):i,c=U.verboseSpeech?`Particle count is ${o}`:o.toString();ne.sayIt(c)}}});let e="";const s={instructionsChanged(a){const r=a.split(".",2)[0];e!==a&&(e=a,ne.sayItLater(r))},estimatedFitFactorChanged(a){U.sayEstimatedFitFactor&&ne.sayItPolitely(`Estimated Fit Factor is ${a.toFixed(0)}`)}};Ve.addListener(s)}function Ma(t){const e=U.getProtocolDefinition(t),s=Ct(e),a=Ie.settings,r=a.numExercises||s;r!==s&&console.warn(`numExercises (${r} does not match num exercise for protocol ${t} (${s})`);const i=[];let o=0;return e.forEach(c=>{if(c.mask_sample){o++;const l={title:c.title,instructions:c.instructions,ambient_purge:a.ambientPurge||pe.defaultAmbientPurgeDuration,ambient_sample:a.ambientSample||pe.defaultAmbientSampleDuration,mask_purge:a.maskPurge||pe.defaultMaskPurgeDuration,mask_sample:a.maskSample.get(o)||pe.defaultMaskSampleDuration};o>r?console.log(`Ignoring extra exercises. Device is configured for ${r}. Ignoring exercise ${o}`):i.push(l)}}),i.push({title:"Finalize",instructions:"Breathe normally",ambient_purge:a.ambientPurge,ambient_sample:a.ambientSample,mask_purge:0,mask_sample:0}),i}async function Ws(){const t=navigator.serial?(await navigator.serial.getPorts()).filter(o=>o.getInfo().usbVendorId):[],e=await $e.getPorts(),s=e.length>0?e[0]:null,a=t.length>0?t[0]:null,r=U.getSetting(m.SELECTED_DATA_SOURCE);let i=null;r===ee.WebUsbSerial&&s?i=s:r===ee.WebSerial&&a?i=a:s?(i=s,U.saveSetting(m.SELECTED_DATA_SOURCE,ee.WebUsbSerial)):a&&(i=a,U.saveSetting(m.SELECTED_DATA_SOURCE,ee.WebSerial)),i?(console.debug(`auto-connecting to port ${JSON.stringify(i)}`),Ie.connect(i)):U.getSetting(m.ENABLE_AUTO_CONNECT)&&setTimeout(()=>Ws(),1500)}async function ja(){const t=new Date,e=new Date(t.getTime()-t.getTimezoneOffset()*60*1e3).toISOString().substring(0,10);function s(r){const i=new Date(r);try{return new Date(i.getTime()-i.getTimezoneOffset()*60*1e3).toISOString().substring(0,10)===e}catch{return!1}}const a=U.getSetting(m.NORMALIZE_MASK_LIST_NAMES);return Ce.getData().then(r=>{const i=Ke(r.map(l=>a?Ps(l.Mask):l.Mask)),o=Ke(r.map(l=>l.Notes)),c=Ke(r.filter(l=>s(l.Time)).map(l=>l.Participant));U.saveSetting(m.COMBINED_MASK_LIST,i),U.saveSetting(m.TEST_NOTES,[...o].sort(Be.compare)),U.saveSetting(m.COMBINED_PARTICIPANT_LIST,c)})}function Fa(){Ie.baudRate=U.getSetting(m.BAUD_RATE),Ie.syncOnConnect=U.getSetting(m.SYNC_DEVICE_STATE_ON_CONNECT)}function $a(){let t=!1,e=ue.Disconnected;function s({executorRunning:r,activity:i}){r!==void 0&&(t=r),i!==void 0&&(e=i),U.saveSetting(m.ACTIVITY,t?ue.Testing:e)}const a={started(){s({executorRunning:!0})},cancelled(){s({executorRunning:!1})},completed(){s({executorRunning:!1})},activityChanged(r){s({activity:r})},connectionStatusChanged(r){switch(r){case te.DISCONNECTED:s({activity:ue.Disconnected});break;default:s({activity:ue.Idle});break}}};Ie.addListener(a),Vs.addListener(a)}function Ua(){const t={newTestStarted(s){const r=U.getSetting(m.NORMALIZE_MASK_LIST_NAMES)?Ps(s.mask):Mt(s.Mask);if(!r)return;const i=U.getSetting(m.COMBINED_MASK_LIST);new Set(i.map(c=>c.toLowerCase())).has(r.toLowerCase())||U.saveSetting(m.COMBINED_MASK_LIST,[...i,r].toSorted(Be.compare))}};Ve.addListener(t);const e=Ke([...U.getSetting(m.MASK_LIST),...U.getSetting(m.COMBINED_MASK_LIST)]);U.saveSetting(m.COMBINED_MASK_LIST,e),U.getSetting(m.AUTO_UPDATE_MASK_LIST)&&U.saveSetting(m.MASK_LIST,e)}function Ba(){const t={newTestStarted(s){const a=Mt(s.Participant);if(!a)return;const r=U.getSetting(m.COMBINED_PARTICIPANT_LIST);new Set(r.map(o=>o.toLowerCase())).has(a.toLowerCase())||U.saveSetting(m.COMBINED_PARTICIPANT_LIST,[...r,a].toSorted(Be.compare))}};Ve.addListener(t);const e=Ke([...U.getSetting(m.PARTICIPANT_LIST),...U.getSetting(m.COMBINED_PARTICIPANT_LIST)]);U.saveSetting(m.COMBINED_PARTICIPANT_LIST,e),U.saveSetting(m.PARTICIPANT_LIST,e)}function Va(){Object.entries(Bn).forEach(([t,e])=>{Le.setDefault(t,e)})}async function Wa(){Va(),await U.loadAllSettings(),await Ce.open(),await rt.open(),Fa(),Da(),ka(),await ja(),$a(),Ua(),Ba(),$s.start(),U.getSetting(m.ENABLE_AUTO_CONNECT)&&await Ws()}function Mt(t){return(t??"").replaceAll(/\s+/g," ").trim()}function Ke(t){const e=new Set;return[...t.reduce((a,r)=>{const i=Mt(r),o=i.toLowerCase();return o&&!e.has(o)&&(e.add(o),a.add(i)),a},new Set)].toSorted(Be.compare)}await Wa();const zs={portaCountClient:Ie,settings:U,dataCollector:Ve,protocolExecutor:Vs,portaCountSimulator:Oa,timingSignal:$s,ambientSampleCollector:Us,maskSampleCollector:Bs},X=u.createContext(zs);function za(t,e={}){const s=u.useContext(Wn),[a,r]=u.useState(s.getConfig(t,e));return u.useEffect(()=>{const c={subscriptions:()=>[t],configChanged(l,d){r(d)}};return s.addListener(c),()=>s.removeListener(c)},[]),[a,c=>{const l=typeof c=="function"?c(s.getConfig(t,e)):c;s.setConfig(t,l),r(l)},()=>s.getConfig(t)]}function w(t){return za(t)}const Ha=u.createContext(null),Tt={didCatch:!1,error:null};class Ga extends u.Component{constructor(e){super(e),this.resetErrorBoundary=this.resetErrorBoundary.bind(this),this.state=Tt}static getDerivedStateFromError(e){return{didCatch:!0,error:e}}resetErrorBoundary(){const{error:e}=this.state;if(e!==null){for(var s,a,r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];(s=(a=this.props).onReset)===null||s===void 0||s.call(a,{args:i,reason:"imperative-api"}),this.setState(Tt)}}componentDidCatch(e,s){var a,r;(a=(r=this.props).onError)===null||a===void 0||a.call(r,e,s)}componentDidUpdate(e,s){const{didCatch:a}=this.state,{resetKeys:r}=this.props;if(a&&s.error!==null&&Ka(e.resetKeys,r)){var i,o;(i=(o=this.props).onReset)===null||i===void 0||i.call(o,{next:r,prev:e.resetKeys,reason:"keys"}),this.setState(Tt)}}render(){const{children:e,fallbackRender:s,FallbackComponent:a,fallback:r}=this.props,{didCatch:i,error:o}=this.state;let c=e;if(i){const l={error:o,resetErrorBoundary:this.resetErrorBoundary};if(typeof s=="function")c=s(l);else if(a)c=u.createElement(a,l);else if(r!==void 0)c=r;else throw o}return u.createElement(Ha.Provider,{value:{didCatch:i,error:o,resetErrorBoundary:this.resetErrorBoundary}},c)}}function Ka(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];return t.length!==e.length||t.some((s,a)=>!Object.is(s,e[a]))}function Hs({options:t,children:e,onChange:s,value:a,id:r}){const i=c=>n.jsx("div",{id:r,style:{width:"100%",height:"100%"},children:n.jsx(Bt.DropdownIndicator,{...c,children:e})}),o=c=>n.jsx(Ga,{fallback:n.jsx("div",{style:{background:"red",color:"white"},children:"menu is too wide to fit on screen"}),children:n.jsx(Bt.MenuPortal,{...c})});return n.jsx("div",{className:"svg-container icon-button",children:n.jsx(an,{components:{DropdownIndicator:i,MenuPortal:o},options:t,value:a?{value:a,label:a}:null,styles:{control:()=>({height:"inherit"}),container:()=>({aspectRatio:"1/1",height:"inherit"}),valueContainer:()=>({height:0,width:0,overflow:"hidden"}),indicatorsContainer:()=>({height:"inherit"}),indicatorSeparator:()=>({display:"none"}),dropdownIndicator:()=>({padding:0,height:"inherit"}),menu:c=>({...c,zIndex:10,width:"max-content",textAlign:"left"})},menuPortalTarget:document.body,tabSelectsValue:!1,isSearchable:!1,onChange:c=>{s(c?.value)}})})}function qa(t){return J({tag:"svg",attr:{viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true"},child:[{tag:"path",attr:{fillRule:"evenodd",d:"M19.892 4.09a3.75 3.75 0 0 0-5.303 0l-4.5 4.5c-.074.074-.144.15-.21.229l4.965 4.966a3.75 3.75 0 0 0-1.986-4.428.75.75 0 0 1 .646-1.353 5.253 5.253 0 0 1 2.502 6.944l5.515 5.515a.75.75 0 0 1-1.061 1.06l-18-18.001A.75.75 0 0 1 3.521 2.46l5.294 5.295a5.31 5.31 0 0 1 .213-.227l4.5-4.5a5.25 5.25 0 1 1 7.425 7.425l-1.757 1.757a.75.75 0 1 1-1.06-1.06l1.756-1.757a3.75 3.75 0 0 0 0-5.304ZM5.846 11.773a.75.75 0 0 1 0 1.06l-1.757 1.758a3.75 3.75 0 0 0 5.303 5.304l3.129-3.13a.75.75 0 1 1 1.06 1.061l-3.128 3.13a5.25 5.25 0 1 1-7.425-7.426l1.757-1.757a.75.75 0 0 1 1.061 0Zm2.401.26a.75.75 0 0 1 .957.458c.18.512.474.992.885 1.403.31.311.661.555 1.035.733a.75.75 0 0 1-.647 1.354 5.244 5.244 0 0 1-1.449-1.026 5.232 5.232 0 0 1-1.24-1.965.75.75 0 0 1 .46-.957Z",clipRule:"evenodd"},child:[]}]})(t)}function Nt(t){return J({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"},child:[]},{tag:"path",attr:{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"},child:[]},{tag:"circle",attr:{cx:"7",cy:"12",r:"1.5"},child:[]},{tag:"circle",attr:{cx:"12",cy:"12",r:"1.5"},child:[]},{tag:"circle",attr:{cx:"17",cy:"12",r:"1.5"},child:[]}]})(t)}function Ya(t){return J({tag:"svg",attr:{viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true"},child:[{tag:"path",attr:{fillRule:"evenodd",d:"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z",clipRule:"evenodd"},child:[]}]})(t)}function Xa(t){return J({tag:"svg",attr:{fill:"none",viewBox:"0 0 24 24",strokeWidth:"2",stroke:"currentColor","aria-hidden":"true"},child:[{tag:"path",attr:{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"},child:[]}]})(t)}function it({compact:t=!1}){const e=u.useContext(X),[s]=u.useState(e.dataCollector),[a]=u.useState(e.portaCountClient),[r]=w(m.ENABLE_SIMULATOR),[i]=w(m.BAUD_RATE),o=[3,30,300,1200,14400,28800,56760],[c,l]=w(m.SIMULATOR_FILE_SPEED),[d,h]=w(m.SELECTED_DATA_SOURCE),[p]=w(m.CONNECTION_STATUS),[,g]=w(m.CONNECTION_STATUS_IN_VIEW),[f]=w(m.ENABLE_WEB_SERIAL_DRIVERS),{ref:T,inView:E}=rn();u.useEffect(()=>{g(E)},[E]);function v(){s.dataSource=ee.WebUsbSerial,new $e().requestPort().then(b)}function b(O){console.log(`got serial port ${O.toLocaleString()}, using baud rate ${i}`),a.connect(O)}function I(){s.dataSource=ee.WebSerial,"serial"in navigator?(console.log("webserial supported!"),navigator.serial.requestPort().then(b)):console.log("no serial support. As of this writing, web serial is only supported on desktop chrome.")}function C(){s.dataSource=ee.Simulator,b(e.portaCountSimulator.port)}function P(){s.dataSource=ee.Simulator;function O(Y,G=null){return{readable:Y,writable:G,connected:!1,getInfo(){return{}},open(){return this.connected=!0,Promise.resolve()}}}if("showOpenFilePicker"in window)window.showOpenFilePicker({id:"simulator-files"}).then(Y=>{Y[0].getFile().then(G=>{const _=Xt(new ke(G,c)),j=O(_,null);b(j)})});else{const Y=Xt(new ke("./fit-test-console/simulator-data/test-data.txt",c)),G=O(Y,null);b(G)}}function K(){H(d)}function H(O){switch(O){case ee.WebUsbSerial:v();break;case ee.WebSerial:I();break;case ee.Simulator:C();break;case ee.SimulatorFile:P();break;default:console.log(`unexpected dataSource : ${O}`);break}}function q(O){H(O)}const V=[{value:ee.WebUsbSerial,label:"App drivers (webusb serial)"}];f&&V.push({value:ee.WebSerial,label:"Computer drivers (webserial)"}),r&&V.push({value:ee.SimulatorFile,label:"Simulator (file)"},{value:ee.Simulator,label:"Simulator"});const W=n.jsxs(Hs,{id:"compact-driver-selector-widget",options:V,onChange:O=>q(O),children:[p===te.DISCONNECTED&&n.jsx(qa,{color:"red"}),p===te.WAITING&&n.jsx(Nt,{color:"orange"}),p===te.RECEIVING&&n.jsx(Ya,{color:"green"})]});return t?W:n.jsxs("fieldset",{id:"driver-selector-widget",className:"info-box-compact",ref:T,children:[n.jsxs("legend",{children:["Data Source ",n.jsx("span",{className:ua(p),children:p})]}),n.jsxs("div",{style:{display:"inline-block"},children:[n.jsx("select",{id:"data-source-selector",value:d,onChange:O=>h(O.target.value),disabled:p!==te.DISCONNECTED,children:V.map(O=>n.jsx("option",{value:O.value,children:O.label},O.value))}),d===ee.SimulatorFile&&n.jsxs("div",{style:{display:"inline-block"},children:[n.jsx("label",{htmlFor:"simulation-speed-select"}),n.jsx("select",{id:"simulation-speed-select",value:c,onChange:O=>l(Number(O.target.value)),children:o.map(O=>n.jsxs("option",{value:O,children:[O," bps"]},O))})]})]}),n.jsx("input",{className:"button",type:"button",value:"Connect",id:"connect-button",disabled:p!==te.DISCONNECTED,onClick:K})]})}function R({label:t,...e}){return n.jsxs("div",{className:"thin-border blue-bg",style:{display:"flex",justifyContent:"space-between",gap:"1em"},children:[t,n.jsx("div",{className:"number-field",children:e.children})]})}function Za(){const e=u.useContext(X).portaCountClient,s=e.externalController,a=15*1e3,[r,i]=u.useState(Ae(a)),[o,c]=u.useState("idle"),[l,d]=u.useState(!1),[h,p]=u.useState("Press start to begin Cleanup"),[g,f]=u.useState({}),[T]=w(m.CONNECTION_STATUS),E=u.useCallback(()=>{f({})},[]);u.useEffect(()=>{ne.sayIt(h)},[h]),u.useEffect(()=>{const I={particleConcentrationReceived:C=>{const P=C.concentration;switch(C.sampleSource===k.AMBIENT&&r.push(C.timestamp,P),E(),console.debug(`state is ${o}`),o){case"idle":break;case"start":i(Ae(a)),p("Remove alcohol cartridge, replace with sample plug."),s.assumeManualControl(),s.beep(),s.sampleAmbient(),c("waiting-for-ambient-count-to-zero");break;case"waiting-for-ambient-count-to-zero":r.movingAverage()<1&&(c("done"),p("Cleanup complete. Powering off."),d(!0),s.beep(),s.beep(),s.powerOff());break;case"done":break;default:console.error(`unhandled state ${o}`)}}};return e.addListener(I),()=>{e.removeListener(I)}},[g]);function v(){c("start")}function b(I){return n.jsx("div",{className:"svg-container",style:{padding:"4px"},children:I?n.jsx(As,{color:"green"}):n.jsx(It,{color:"red"})})}return n.jsxs("div",{id:"daily-check-panel",style:{width:"fit-content",justifySelf:"center"},children:[n.jsx("div",{children:h}),n.jsxs("div",{className:"inline-flex",children:[n.jsx(it,{compact:!0}),n.jsx("button",{onClick:()=>v(),disabled:T===te.DISCONNECTED,children:"Press to start"})]}),n.jsx(R,{label:"State",children:o}),n.jsx(R,{label:"Particle count check",children:b(l)}),n.jsx(R,{label:"Ambient average",children:(r.movingAverage()??0).toFixed(2)})]})}function Ja(t){return J({tag:"svg",attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M9 14 4 9l5-5"},child:[]},{tag:"path",attr:{d:"M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5a5.5 5.5 0 0 1-5.5 5.5H11"},child:[]}]})(t)}function Pe({debounce:t=!0,debounceDelay:e=500,resize:s=!0,onChange:a,initialValue:r,label:i,placeholder:o,autocompleteOptions:c=[],id:l,oneLine:d=!1,scrollable:h=!1,onChangeOnlyOnBlur:p,className:g}){const[f,T]=de.useState(r),E=u.useRef(null),v=u.useRef(null),[b,I]=u.useState(null),[C,P]=u.useState(!1),[K,H]=u.useState(!0),[q,V]=u.useState(!0),[W,O]=u.useState(0),Y=u.useRef(null),G=u.useRef(null),_=u.useMemo(()=>{const S=Array.isArray(c)?c:c();if((f??"").trim().length===0||!q)return S;function L(F){const D=F.value.toLowerCase();return(f??"").toLowerCase().split(/\s+/).every(y=>D.includes(y))}return S.filter(F=>L(F))},[c,f,q]),j=u.useCallback(S=>{const A=_.length;switch(S.ctrlKey?`Ctrl-${S.key.toUpperCase()}`:S.code){case"Escape":if(f!==r){Z();break}if(q&&A<W){V(!1);break}oe();break;case"Ctrl-N":case"Ctrl-F":case"ArrowDown":if(!A)break;I(F=>(F===null?0:F+1)%A),P(!0);break;case"Ctrl-P":case"Ctrl-B":case"ArrowUp":if(!A)break;I(F=>(A+(F===null?A-1:F-1))%A),P(!0);break;case"Enter":if(!C||!A||b===null)break;A===1&&_[0].value.toLowerCase()===(f??"").toLowerCase()?(S.preventDefault(),z(f)):A>0&&(S.preventDefault(),z(_[b].value)),oe();break;case"Tab":C&&A?b===null||A===1&&_[0].value.toLowerCase()===(f??"").toLowerCase()?z(f):A>0?z(_[b].value):console.debug("tab fallthrough"):z(f),oe();break;default:V(!0),P(!0);break}},[_,b,f,C]);u.useEffect(()=>{he(f)},[]),u.useEffect(()=>{T(r)},[r]),u.useEffect(()=>{if(he(f),f||I(null),!p&&a)if(t){const S=setTimeout(()=>{r!==f&&a(f)},e);return()=>clearTimeout(S)}else a(f)},[f]),u.useEffect(()=>{if(G.current&&b!==null){const S=G.current.children.item(b);S&&S.scrollIntoView({block:"center"}),H(!1)}},[b]),u.useEffect(()=>{I(S=>S===null||_.length===0?null:Math.min(S,_.length-1))},[_]),u.useEffect(()=>{if(C){let S=function(){document.removeEventListener("click",A),document.removeEventListener("focusin",L),document.removeEventListener("mousemove",F)};const A=D=>{if(console.debug("global click listener:",D),D.target!==G.current){if(Y.current){const y=Y.current.getBoundingClientRect();if(D.clientX>=y.left&&D.clientX<=y.right&&D.clientY>=y.top&&D.clientY<=y.bottom)return}v.current&&(console.debug("clicked outside component, value is",f,"event value is",v.current.value),z(v.current.value),oe(),S())}},L=D=>{K&&D.target!==v.current&&v.current&&(console.debug("focusIn different element, value is",v.current.value),z(v.current.value),oe(),S())},F=D=>{D.type==="mousemove"&&H(!0)};return document.addEventListener("click",A),document.addEventListener("focusin",L),document.addEventListener("mousemove",F),()=>{S()}}},[C,K]),u.useEffect(()=>{const S=Array.isArray(c)?c:c();O(S.length)},[c]);function he(S){s&&E.current&&(E.current.dataset.value=S)}function Ee(S){console.debug("textarea onchange",S.target.value),T(S.target.value)}function ge(){K&&I(null)}function oe(){I(null),P(!1),V(!0),v.current&&v.current.blur()}function ae(S){z(S.value),oe()}function xe(S){_.length>1&&S.type==="mousedown"&&document.activeElement===v.current&&P(A=>!A)}function fe(){_.length>1&&P(!0)}const Ne=u.useCallback(()=>_.map(S=>{const A=b!==null&&_[b]===S;return n.jsx("li",{className:`autocomplete-option ${A&&"selected"}`,onMouseEnter:()=>ge(),onClick:()=>ae(S),children:S.label},S.value)}),[_,b]);function Q(){T("")}function Z(){T(r)}function z(S){if(console.debug(`updateValue '${r}' => '${S}'`),S===r){console.debug("no change");return}T(S),a&&a(S)}function re(S){if(console.debug("onBlur handler",f,"autocomplete visible?",C),C){console.debug("let autocomplete handle update"),S.preventDefault();return}z(f)}const N=v.current?.getBoundingClientRect(),x=`smart-text-area-${l}-textarea`;return n.jsxs("label",{id:`smart-text-area-${l}-container`,className:`smart-text-area-container ${g}`,ref:Y,children:[i&&(Cn(i)?n.jsx("label",{id:`smart-text-area-${l}-label`,htmlFor:x,className:"smart-text-area-label",children:i}):i),n.jsx("label",{id:`smart-text-area-${l}-textarea-resizer`,className:"textarea-resizer",ref:E,children:n.jsx("textarea",{id:x,className:`smart-text-area-textarea ${d?"one-line":""} ${h?"scrollable":""}`,placeholder:o,value:f,ref:v,onChange:Ee,onFocus:fe,onBlur:S=>re(S),onMouseDown:xe,onKeyDown:S=>j(S)})}),n.jsx("div",{className:"clear-content-icon svg-container",children:f===r||!r?n.jsx(It,{onClick:()=>Q()}):n.jsx(Ja,{onClick:()=>Z()})}),C&&Cs.createPortal(n.jsx("div",{id:`smart-text-area-${l}-autocomplete-options`,className:`smart-text-area-autocomplete-container ${_.length<W&&"some-options-filtered"}`,ref:G,style:{top:N?.bottom,left:N?.left,width:N?.width},children:Ne()}),document.body)]})}function Qa(){const[t,e]=u.useState(""),[s,a]=u.useState(""),[r,i]=u.useState(""),[o,c]=u.useState(""),[l,d]=w(m.BOOKMARKS),h=[["These bookmarks",window.location.href],["Fit Test for Everyone Discord","https://discord.gg/GeNhXx8Hxw"],["Fit testing resources wiki","https://github.com/emcee5601/fit-testing-resources/wiki"],["MFTC app","https://emcee5601.github.io/fit-test-console/"],["MFTC old versions","https://emcee5601.github.io/mftc-old/"],["MFTC app source","https://github.com/emcee5601/fit-test-console"],["Breathesafe","https://www.breathesafe.xyz/"]];Object.entries(l).forEach(([E,v])=>h.push([E,v]));function p(E,v){e(E),a(v)}function g(){return r&&!Object.values(l).includes(r)}function f(){if(!g())return;const E={};E[o||r]=r,Object.assign(E,l),d(E)}function T(E){const v={};Object.entries(l).filter(([b])=>b!==E).forEach(([b,I])=>v[b]=I),d(v)}return n.jsx("div",{id:"bookmarks",style:{height:"100%",display:"flex",flexDirection:"column",alignItems:"center",gap:"1em"},children:n.jsxs("div",{children:[t&&n.jsx("div",{className:"full-screen-overlay",children:n.jsxs("div",{onClick:()=>e(""),className:"qrcode-container",children:[n.jsx("span",{style:{display:"block"},children:s}),n.jsx("span",{style:{display:"block"},children:n.jsx("a",{href:t,children:t})}),n.jsx(Qe,{value:t,size:512,marginSize:4,title:s})]})}),n.jsxs("fieldset",{children:[n.jsx("legend",{children:"Add new bookmark"}),n.jsxs("div",{id:"bookmark-adder",style:{display:"flex"},children:[n.jsxs("div",{style:{textAlign:"start",height:"100%",display:"flex",flexDirection:"column",gap:"0.3em"},children:[n.jsx("div",{className:"thin-border-2",children:n.jsx(Pe,{id:"bookmark-title",initialValue:o,placeholder:"Title",onChange:E=>c(E||"")})}),n.jsx("div",{className:"thin-border-2",children:n.jsx(Pe,{id:"bookmark-url",initialValue:r,placeholder:"URL",onChange:E=>i(E||"")})})]}),n.jsx("div",{style:{height:"100%"},children:n.jsx(Qe,{value:r,size:128,marginSize:4,title:r,onClick:()=>p(r,o),visibility:r?"visible":"hidden"})}),n.jsx("button",{onClick:()=>f(),disabled:!g(),children:"Save bookmark"})]})]}),h.map(([E,v])=>n.jsx("div",{children:n.jsxs("fieldset",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[n.jsx("legend",{children:E}),n.jsx("a",{href:v,children:v}),n.jsx(Qe,{value:v,size:128,marginSize:4,title:E,onClick:()=>p(v,E)}),E in l&&n.jsx("button",{onClick:()=>T(E),children:"delete"})]})},E))]})})}function er(){const o=u.useContext(X).portaCountClient,c=o.externalController,[l,d]=u.useState(!1),[h,p]=u.useState(!1),[g,f]=u.useState(!1),[T,E]=u.useState(0),[v,b]=u.useState(0),[I,C]=u.useState(1e3),[P,K]=u.useState(Ae(11e3)),[H,q]=u.useState(Ae(5e3)),[V,W]=u.useState("idle"),[O,Y]=u.useState("Press start to begin Daily Checks."),[G,_]=u.useState(0),[j,he]=u.useState(0),[Ee,ge]=u.useState(0),[oe,ae]=u.useState(0),[xe,fe]=u.useState(0),[Ne,Q]=u.useState({}),[Z]=w(m.CONNECTION_STATUS),z=u.useCallback(()=>{Q({})},[]);u.useEffect(()=>{ne.sayIt(O)},[O]),u.useEffect(()=>{const x={particleConcentrationReceived:S=>{const A=S.concentration;switch(S.sampleSource===k.AMBIENT?(E(L=>L>A?L:A),H.push(S.timestamp,A)):(b(L=>L>A?L:A),C(L=>L<A?L:A),P.push(S.timestamp,A)),z(),console.debug(`state is ${V}`),V){case"idle":break;case"start":K(Ae(11e3)),q(Ae(5e3)),C(1e3),b(0),E(0),d(!1),p(!1),f(!1),fe(0),Y("Remove zero filter if attached"),c.assumeManualControl(),c.beep(),c.sampleMask(),W("initial-mask-purge"),_(Date.now());break;case"initial-mask-purge":Date.now()-G>7e3&&(W("waiting-for-particle-check"),_(Date.now()));break;case"waiting-for-particle-check":console.debug(`max mask count: ${v}`),v>1e3&&(W("waiting-for-zero-check"),c.beep(),d(!0),Y("Particle check passed, attach zero filter."),C(1e3));break;case"waiting-for-zero-check":I===0&&(W("purge-ambient-1"),c.sampleAmbient(),_(Date.now()),p(!0),Y("Zero check passed. Reading from ambient"));break;case"purge-ambient-1":Date.now()-G>7e3&&(W("waiting-for-ambient-average"),_(Date.now()),q(Ae(5e3)));break;case"waiting-for-ambient-average":Date.now()-G>12e3&&(he(H.movingAverage()),W("purge-mask"),c.sampleMask(),Y("reading from mask"),_(Date.now()));break;case"purge-mask":Date.now()-G>7e3&&(W("waiting-for-mask-average"),_(Date.now()),K(Ae(11e3)));break;case"waiting-for-mask-average":Date.now()-G>18e3&&(ae(P.movingAverage()),W("purge-ambient-2"),c.sampleAmbient(),Y("reading from ambient"),_(Date.now()));break;case"purge-ambient-2":Date.now()-G>7e3&&(W("waiting-for-second-ambient-average"),_(Date.now()),q(Ae(5e3)));break;case"waiting-for-second-ambient-average":if(Date.now()-G>12e3){ge(H.movingAverage()),W("done");const L=.5*(j+Ee)/Math.max(.01,oe);fe(L);const F=L>5e4;f(F),Y(`done - max fit factor check ${F?"passed":"failed"}`),c.sampleAmbient(),c.beep(),c.beep()}break;case"done":break;default:console.error(`unhandled state ${V}`)}}};return o.addListener(x),()=>{o.removeListener(x)}},[Ne]);function re(){W("start")}function N(x){return n.jsx("div",{className:"svg-container",style:{padding:"4px"},children:x?n.jsx(As,{color:"green"}):n.jsx(It,{color:"red"})})}return n.jsxs("div",{id:"daily-check-panel",style:{width:"fit-content",justifySelf:"center"},children:[n.jsx("div",{children:O}),n.jsxs("div",{className:"inline-flex",children:[n.jsx(it,{compact:!0}),n.jsx("button",{onClick:()=>re(),disabled:Z===te.DISCONNECTED,children:"Press to start"})]}),n.jsx(R,{label:"State",children:V}),n.jsx(R,{label:"Particle count check",children:N(l)}),n.jsx(R,{label:"Zero check",children:N(h)}),n.jsx(R,{label:"Max fit factor check",children:N(g)}),n.jsx(R,{label:"Max ambient count",children:T}),n.jsx(R,{label:"Ambient average",children:(H.movingAverage()??0).toFixed(2)}),n.jsx(R,{label:"Max mask count",children:v}),n.jsx(R,{label:"Min mask count",children:I}),n.jsx(R,{label:"Mask average",children:(P.movingAverage()??0).toFixed(2)}),n.jsx(R,{label:"Fit factor",children:Ue(xe)})]})}function tr(){return n.jsx("div",{style:{textAlign:"start"},children:n.jsxs("ul",{children:[n.jsx("li",{children:n.jsx(on,{to:"/test",children:"Test panel"})}),n.jsxs("ul",{children:[n.jsx("li",{children:"Tap participant info banner to edit participant info."}),n.jsx("li",{children:"Tap exercise score to restart from that exercise. Only available when paused."}),n.jsx("li",{children:"Tap leaf/mask icon in FF preview box to reset ambient/mask values used for preview. This triggers an automatic purge interval."}),n.jsx("li",{children:"The instructions slider adjusts instructions font size."}),n.jsx("li",{children:"Blue progress bars denote progress within each stage/exercise and protocol."}),n.jsxs("li",{children:["Tap the record button ",n.jsx(Rs,{}),' to append the current FF estimate as an exercise result. Creates a manual test record with protocol "Estimated" as needed. Only available when idle.']})]})]})})}function sr(){const[t]=w(m.COLOR_SCHEME);return u.useEffect(()=>{document.querySelector('meta[name="color-scheme"]')?.setAttribute("content",t)},[t]),n.jsx(n.Fragment,{})}function Gs(t){return J({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M256 256a112 112 0 1 0-112-112 112 112 0 0 0 112 112zm0 32c-69.42 0-208 42.88-208 128v64h416v-64c0-85.12-138.58-128-208-128z"},child:[]}]})(t)}function nr(t){return J({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M416 64h-16V48.45c0-8.61-6.62-16-15.23-16.43A16 16 0 0 0 368 48v16H144V48.45c0-8.61-6.62-16-15.23-16.43A16 16 0 0 0 112 48v16H96a64 64 0 0 0-64 64v12a4 4 0 0 0 4 4h440a4 4 0 0 0 4-4v-12a64 64 0 0 0-64-64zm61 112H35a3 3 0 0 0-3 3v237a64 64 0 0 0 64 64h320a64 64 0 0 0 64-64V179a3 3 0 0 0-3-3zM224 307.43A28.57 28.57 0 0 1 195.43 336h-70.86A28.57 28.57 0 0 1 96 307.43v-70.86A28.57 28.57 0 0 1 124.57 208h70.86A28.57 28.57 0 0 1 224 236.57z"},child:[]}]})(t)}function ar({useIcons:t=!1,...e}){const[s]=w(m.TEST_TEMPLATE),[a]=w(m.MINUTES_ALLOTTED_PER_PARTICIPANT),[r,i]=u.useState("");function o(){return!!s.Participant}function c(){return o()&&s.Time?Date.now()-new Date(s.Time).getTime():0}function l(){if(o()){if(s.Time){const p=c()/60/1e3;if(a-p<0)return"over-time"}return"on-time"}return"idle"}function d(){i(ie(c()))}return Dt(d),e.style={...e.style,gap:"0.3em"},n.jsxs("div",{...e,className:`thin-border number-field smooth-background-change svg-container no-wrap ${l()}`,children:[t?n.jsx(Gs,{}):n.jsx("span",{children:"Participant Time:"}),n.jsx("span",{children:r})]})}function rr({useIcons:t=!1,...e}){const s=u.useContext(X),[a]=w(m.MINUTES_ALLOTTED_PER_PARTICIPANT),[r,i]=u.useState("");function o(){return Date.now()-s.settings.eventEndTime.getTime()}function c(){const h=o()/60/1e3;return a-h<0?"over-time":"on-time"}function l(){i(ie(s.settings.eventEndTime.getTime()-Date.now(),!1,!1))}return Dt(l),e.style={...e.style,gap:"0.3em"},n.jsxs("div",{...e,className:`number-field thin-border smooth-background-change svg-container no-wrap ${c()}`,children:[t?n.jsx(nr,{}):n.jsx("span",{children:"Event Time:"}),n.jsx("span",{children:r})]})}function ir(t){return J({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M32 96v64h448V96H32zm0 128v64h448v-64H32zm0 128v64h448v-64H32z"},child:[]}]})(t)}function or(t){return J({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M311.9 47.95c-17.6 0-34.6.7-50.7 2.43L244.6 93.5l-4.9-40.04c-2.5.46-5 .94-7.5 1.47-9.1 1.94-15.1 7.22-20.3 14.87-5.2 7.65-8.9 17.5-12.1 26.6C191 121.5 184 148 178.4 175c6 5.1 12 10.3 17.9 15.4l30.7-17.6 33.8 26.1 51.9-19.7 61 24.5-6.8 16.7-54.4-21.8-54.7 20.7-32.2-24.9-14.9 8.5c19.6 17.3 38.6 34.4 56.5 51.2l14-6.4 33.9 16.1 31.2-13.1 24.2 23.3-12.4 13-15.8-15.1-27.6 11.7-33-15.8c6.9 6.7 13.6 13.2 20.1 19.7l1.7 1.8 19.5 76.3-7.8-5.7-53 .4-38.1-17.8-42.4 14.6-5.8-17 49.2-17 41.1 19.2 24.7-.2-70.7-51.7c-19.7 4.6-39.4 2.8-58.1-3.7-4.2 44.4-5.9 85.7-7 118.7-.4 10.7 2.7 23 7.5 32.5 4.9 9.5 11.7 15.4 15 16.1 5.2 1.2 19 3.2 37.7 5.1l12.4-39 19.1 41.7c16.7 1.2 35 2 53.5 2.2 28.2.3 57.1-.9 82-4.7 15.8-2.3 29.6-6 40.7-10.4-11.8-5.1-21.6-10.6-29.1-16.6-11.1-8.9-18.2-19.3-17.3-30.9v.2c5.4-96.4 10.8-188.8 30.3-286l.1-.4.1-.4c5.3-17.9 17.9-39.86 36.1-55.83-13.9-2.06-28.6-4-43.7-5.66l-22.3 25.3-2.2-27.7c-19-1.64-38.4-2.71-57.4-2.92h-5.7zm148.5 20.44c-4.7 3.69-9.2 8.03-13.3 12.73 12.1 8.18 21.4 23.38 21.8 36.98.3 7.8-1.9 14.9-7.7 21.4-5.8 6.4-15.6 12.4-31.6 15.8l3.8 17.6c18.6-4 32.3-11.5 41.2-21.4 9-9.9 12.7-22.2 12.3-34-.6-19.3-11.1-37.59-26.5-49.11zM25.44 71.91c-.24 1.61-.38 3.43-.38 5.62.1 7.69 2.03 18.17 5.83 30.17 3.41 10.7 8.27 22.5 14.35 34.8 10.63-5.3 20.59-11 28.41-18.1-4.42 12.5-10.15 24.7-18.6 36.5 4.14 7.2 8.63 14.4 13.45 21.5 10.64-5.3 20.72-13 29.52-26.1-3.3 16-8.47 30.6-18.27 41.8 6.53 8.5 13.5 16.8 20.75 24.5 8.7-9.3 15.6-21 20.7-34.9 3.8 18.5 2.6 35.3-5.7 49.4 8 7.2 16.3 13.7 24.8 19.1 6.1-14 8.9-30.6 8.5-49.7 9.2 23.7 11.3 42.9 9.6 59.5 20.2 9.2 40.8 12 61.3 6.1l4.2-1.3 69.3 50.6-5.9-22.8c-73-72.8-175.4-156.7-261.86-226.69zM312.8 123.9l33.2 13.8 31.3-9.9 5.4 17.2-37.5 11.9-33.6-14-28.8 8.1-4.8-17.4zm107.3 236.2c-.7 0-1.3.1-2 .1-3.5.1-7.2.5-11.1 1.3l3.4 17.6c12.2-2.3 20-.4 24.5 2.5 4.4 2.9 6.3 6.8 6.4 12.5.1 9.3-7 23-23.3 32.5 5.4 2.9 11.9 5.9 19.3 8.7 14.4-11.6 22.1-26.8 22-41.4-.1-10.7-5.2-21.2-14.6-27.4-6.7-4.3-15-6.5-24.6-6.4z"},child:[]}]})(t)}function ot(t){const e=u.useRef(null),s="overlay-panel-widget-checkbox-"+u.useId(),a=[];return t.position?Array.isArray(t.position)?a.push(...t.position):a.push(t.position):a.push("left"),t.dismissOverlay&&(t.dismissOverlay.current=()=>{e.current&&(e.current.checked=!1)}),n.jsxs("div",{style:{display:"block"},children:[n.jsx("input",{className:"overlay-panel-widget-checkbox",id:s,type:"checkbox",ref:e}),n.jsx("label",{className:"overlay-panel-widget-button",htmlFor:s,children:t.buttonIcon??"button"}),n.jsx("label",{className:"overlay-panel-widget-overlay",htmlFor:s}),n.jsx("div",{className:`overlay-panel-widget-content ${a.join(" ")}`,children:t.children})]})}function cr(t){const e=u.useRef();function s(){e.current&&e.current()}return n.jsx(ot,{dismissOverlay:e,buttonIcon:n.jsx(ir,{className:"nav-icon"}),position:"left",children:t.options.map(a=>n.jsx(vs,{to:a.value,className:({isActive:r,isPending:i})=>i?"nav-link-pending":r?"nav-link-active":"",viewTransition:!0,onClick:s,children:n.jsx("div",{className:"no-wrap",style:{display:"flex",fontSize:"1.5em"},children:a.label})},a.label))})}function lr(t){return J({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6c4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2c5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.3 28.2-18.9 44-25.4l12.5-57.1c2-9.1 9-16.3 18.2-17.8C227.3 1.2 241.5 0 256 0s28.7 1.2 42.5 3.5c9.2 1.5 16.2 8.7 18.2 17.8l12.5 57.1c15.8 6.5 30.6 15.1 44 25.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8c8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z"},child:[]}]})(t)}function ur(t){return J({tag:"svg",attr:{viewBox:"0 0 640 512"},child:[{tag:"path",attr:{d:"M624 416H381.54c-.74 19.81-14.71 32-32.74 32H288c-18.69 0-33.02-17.47-32.77-32H16c-8.8 0-16 7.2-16 16v16c0 35.2 28.8 64 64 64h512c35.2 0 64-28.8 64-64v-16c0-8.8-7.2-16-16-16zM576 48c0-26.4-21.6-48-48-48H112C85.6 0 64 21.6 64 48v336h512V48zm-64 272H128V64h384v256z"},child:[]}]})(t)}function gs(t){return J({tag:"svg",attr:{viewBox:"0 0 496 512"},child:[{tag:"path",attr:{d:"M328.2 255.8h151.6c9.1 0 16.8-7.7 16.2-16.8-5.1-75.8-44.4-142.2-102.5-184.2-7.4-5.3-17.9-2.9-22.7 4.8L290.4 188c22.6 14.3 37.8 39.2 37.8 67.8zm-37.8 67.7c-12.3 7.7-26.8 12.4-42.4 12.4-15.6 0-30-4.7-42.4-12.4L125.2 452c-4.8 7.7-2.4 18.1 5.6 22.4C165.7 493.2 205.6 504 248 504s82.3-10.8 117.2-29.6c8-4.3 10.4-14.8 5.6-22.4l-80.4-128.5zM248 303.8c26.5 0 48-21.5 48-48s-21.5-48-48-48-48 21.5-48 48 21.5 48 48 48zm-231.8-48h151.6c0-28.6 15.2-53.5 37.8-67.7L125.2 59.7c-4.8-7.7-15.3-10.2-22.7-4.8C44.4 96.9 5.1 163.3 0 239.1c-.6 9 7.1 16.7 16.2 16.7z"},child:[]}]})(t)}function dr(t){return J({tag:"svg",attr:{viewBox:"0 0 640 512"},child:[{tag:"path",attr:{d:"M32,224H64V416H32A31.96166,31.96166,0,0,1,0,384V256A31.96166,31.96166,0,0,1,32,224Zm512-48V448a64.06328,64.06328,0,0,1-64,64H160a64.06328,64.06328,0,0,1-64-64V176a79.974,79.974,0,0,1,80-80H288V32a32,32,0,0,1,64,0V96H464A79.974,79.974,0,0,1,544,176ZM264,256a40,40,0,1,0-40,40A39.997,39.997,0,0,0,264,256Zm-8,128H192v32h64Zm96,0H288v32h64ZM456,256a40,40,0,1,0-40,40A39.997,39.997,0,0,0,456,256Zm-8,128H384v32h64ZM640,256V384a31.96166,31.96166,0,0,1-32,32H576V224h32A31.96166,31.96166,0,0,1,640,256Z"},child:[]}]})(t)}function fs(t){return J({tag:"svg",attr:{viewBox:"0 0 256 256",fill:"currentColor"},child:[{tag:"path",attr:{d:"M116,132V80a12,12,0,0,1,24,0v52a12,12,0,0,1-24,0ZM236,91.55v72.9a19.86,19.86,0,0,1-5.86,14.14l-51.55,51.55A19.85,19.85,0,0,1,164.45,236H91.55a19.85,19.85,0,0,1-14.14-5.86L25.86,178.59A19.86,19.86,0,0,1,20,164.45V91.55a19.86,19.86,0,0,1,5.86-14.14L77.41,25.86A19.85,19.85,0,0,1,91.55,20h72.9a19.85,19.85,0,0,1,14.14,5.86l51.55,51.55A19.86,19.86,0,0,1,236,91.55Zm-24,1.66L162.79,44H93.21L44,93.21v69.58L93.21,212h69.58L212,162.79ZM128,156a16,16,0,1,0,16,16A16,16,0,0,0,128,156Z"},child:[]}]})(t)}function jt(t){return J({tag:"svg",attr:{viewBox:"0 0 256 256",fill:"currentColor"},child:[{tag:"path",attr:{d:"M176,104a8,8,0,0,1-8,8H88a8,8,0,0,1,0-16h80A8,8,0,0,1,176,104Zm-8,24H88a8,8,0,0,0,0,16h80a8,8,0,0,0,0-16Zm88-24v24a32,32,0,0,1-32,32h-5.19c-7.19,15.8-21.79,29.43-43.23,40.16a191.16,191.16,0,0,1-46.15,15.71,7.93,7.93,0,0,1-2.86,0,191.16,191.16,0,0,1-46.15-15.71C59,189.43,44.38,175.8,37.19,160H32A32,32,0,0,1,0,128V104A32,32,0,0,1,32,72h.85a16,16,0,0,1,9.68-10l80-29.09a16.06,16.06,0,0,1,10.94,0l80,29.09a16,16,0,0,1,9.68,10H224A32,32,0,0,1,256,104ZM32.55,144a58.74,58.74,0,0,1-.55-8V88a16,16,0,0,0-16,16v24a16,16,0,0,0,16,16ZM208,136V77.09L128,48,48,77.09V136c0,45,69.09,61.52,80,63.84C138.89,197.52,208,181,208,136Zm32-32a16,16,0,0,0-16-16v48a58.74,58.74,0,0,1-.55,8H224a16,16,0,0,0,16-16Z"},child:[]}]})(t)}function wt({value:t,onChange:e,debounce:s=500,inputRef:a,id:r,...i}){const[o,c]=de.useState(t);return de.useEffect(()=>{c(t)},[t]),de.useEffect(()=>{const l=setTimeout(()=>{e(o)},s);return()=>clearTimeout(l)},[o]),n.jsx("input",{id:`debounced-input-${r}`,ref:a,...i,value:o,onChange:l=>c(l.target.value)})}function hr(t,e){const s=URL.createObjectURL(new Blob([new TextEncoder().encode(e).buffer],{type:"text/plain"})),a=document.createElement("a");return a.download=t,a.href=s,a}function yt(t,e="data",s="txt"){hr(`${e}_${new Date().toISOString().replace(/[:.]/g,"_")}.${s}`,t).click()}function mr(t){const e=_n({fieldSeparator:",",filename:`fit-test-results-${new Date().toISOString().replace(/[:.]/g,"_")}`,decimalSeparator:".",columnHeaders:t.getAllColumns().map(i=>i.id)}),a=t.getSortedRowModel().rows.map(i=>i.original),r=Nn(e)(a);return{csvConfig:e,csv:r}}function gr(t){const{csvConfig:e,csv:s}=mr(t);vn(e)(s)}function ps({label:t,value:e,setValue:s,options:a}){const r=`${t.replace(/[^\p{L}\p{N}]/ui,"")}-settings-select`;return n.jsx(n.Fragment,{children:n.jsxs("div",{className:"labeled-setting",children:[n.jsxs("label",{htmlFor:r,children:[t,": "]}),n.jsx("select",{id:r,value:e,onChange:i=>s(i.target.value),children:a.map(i=>Object.entries(i).map(([o,c])=>n.jsx("option",{value:c,children:o},c)))})]})})}function se({trueLabel:t,falseLabel:e,setting:s}){const[a,r]=w(s);function i(l){return l.toString().replace(/^(.)/,(d,h)=>`${h[0].toUpperCase()}`).replace(/(-(.))/g,(d,h)=>` ${h[1].toUpperCase()}`)}const o=t??i(s),c=`${o.replace(/[^\p{L}\p{N}]/ui,"")}-settings-checkbox`;return n.jsxs("div",{className:"labeled-setting",children:[n.jsx("label",{className:"setting-name",htmlFor:c,children:a?o:e||o}),n.jsxs("label",{className:"switch",children:[n.jsx("input",{type:"checkbox",id:c,onChange:l=>r(l.target.checked),checked:a}),n.jsx("span",{className:"slider round"})]})]})}function ct({trueLabel:t,falseLabel:e,value:s,setValue:a}){const r=`${t.replace(/[^\p{L}\p{N}]/ui,"")}-settings-checkbox`;return n.jsxs("div",{className:"labeled-setting",children:[n.jsx("label",{className:"setting-name",htmlFor:r,children:s?t:e||t}),n.jsxs("label",{className:"switch",children:[n.jsx("input",{type:"checkbox",id:r,onChange:i=>a(i.target.checked),checked:s}),n.jsx("span",{className:"slider round"})]})]})}function fr(){const[t,e]=w(m.SPEECH_ENABLED);return u.useEffect(()=>{ne.setSpeechEnabled(t)},[t]),n.jsx(ct,{trueLabel:"Enable speech",value:t,setValue:e})}function pr(){const[t,e]=w(m.SPEECH_VOICE);u.useEffect(()=>{const a=ne.findDefaultVoice();a&&s(a.name)},[]);function s(a){const r=ne.findVoiceByName(a);console.log(`looking for voice '${a}'; found voice ${r?.name}`);const i=ne.getSelectedVoice();r&&(!i||i.name!==r.name)&&(ne.setSelectedVoice(r),e(o=>o===a?o:(ne.sayItLater(`This is ${a} speaking.`),a)))}return n.jsx(n.Fragment,{children:n.jsxs("div",{className:"labeled-setting",children:[n.jsx("label",{htmlFor:"speech-voice-select",children:"Voice: "}),n.jsx("select",{id:"speech-voice-select",value:t,onChange:a=>s(a.target.value),style:{textOverflow:"ellipsis",width:"15em"},children:ne.allVoices.map(a=>n.jsx("option",{value:a.name,children:`${a.name} (${a.lang}) ${a.default?" DEFAULT":""}`},a.name))})]})})}function Ks(){const t=u.useContext(X),e=t.portaCountClient.state,s=t.portaCountClient.settings,[a,r]=w(m.BAUD_RATE),[i,o]=u.useState(!1),[c,l]=u.useState("all-raw-data"),[d,h]=w(m.MINUTES_ALLOTTED_PER_PARTICIPANT),[p,g]=w(m.MASK_LIST),[f,T]=w(m.PARTICIPANT_LIST),[E,v]=w(m.COLOR_SCHEME),[b,I]=u.useState(t.settings.eventEndTime),[C]=w(m.CONNECTION_STATUS),[P]=w(m.ENABLE_TESTER_MODE),[,K]=u.useState({}),H=u.useCallback(()=>{K({})},[]);function q(_){l(_.target.value)}function V(){switch(c){case"all-raw-data":W();break;case"all-results-as-json":O();break;default:console.log(`unsupported data to download: ${c}`)}}async function W(){await rt.getData().then(_=>{yt(JSON.stringify(_),"fit-test-all-raw-data","json")})}function O(){Ce.getData().then(_=>{yt(JSON.stringify(_),"fit-test-all-results","json")})}function Y(_){const j=Number(_);isNaN(j)?h(he=>he):j>0?h(j):console.warn(`ignoring out-of-range minutes per participant value: ${_}`)}u.useEffect(()=>{t.settings.eventEndTime=b},[b]),u.useEffect(()=>{t.settings.getActualSetting(m.EVENT_END_HHMM).then(()=>{I(t.settings.eventEndTime)});const _={stateChanged(){H()},settingsChanged(){H()}};return t.portaCountClient.addListener(_),()=>{t.portaCountClient.removeListener(_)}},[]);function G(){const _=t.portaCountClient.externalController;_.assumeManualControl(),_.requestRuntimeStatus(),_.sendCommand(M.REQUEST_VOLTAGE_INFO),_.requestSettings()}return n.jsxs("div",{children:[n.jsx("fieldset",{children:"mftc v2.8.1 production"}),P?n.jsx("div",{id:"tester-settings-panel",style:{display:"flex",height:"inherit"},children:n.jsxs("fieldset",{children:[n.jsx("legend",{children:"Settings"}),n.jsxs("section",{id:"settings",style:{display:"flex",flexDirection:"row",flexWrap:"wrap",justifyContent:"center",alignItems:"stretch"},children:[n.jsx("section",{id:"display-settings",children:n.jsxs("fieldset",{children:[n.jsx("legend",{children:"Display"}),n.jsx(se,{setting:m.KEEP_SCREEN_AWAKE}),n.jsx(ps,{label:"Color Scheme",value:E,setValue:_=>v(_),options:[{Auto:"light dark"},{Dark:"dark"},{Light:"light"}]}),n.jsx(se,{setting:m.ENABLE_TEST_INSTRUCTIONS_ZOOM}),n.jsx(se,{setting:m.SHOW_MASK_PERF_GRAPH})]})}),n.jsx("section",{id:"speech-controls",children:n.jsxs("fieldset",{children:[n.jsx("legend",{children:"Speech"}),n.jsx(fr,{}),n.jsx(se,{setting:m.SAY_PARTICLE_COUNT}),n.jsx(se,{setting:m.SAY_ESTIMATED_FIT_FACTOR}),n.jsx(pr,{}),n.jsx(se,{trueLabel:"Verbose speech",setting:m.VERBOSE})]})}),n.jsx("section",{id:"event-settings",children:n.jsxs("fieldset",{children:[n.jsx("legend",{children:"Event"}),n.jsx(se,{setting:m.SHOW_ELAPSED_PARTICIPANT_TIME}),n.jsxs("div",{className:"labeled-setting",children:[n.jsx("label",{htmlFor:"minutes-per-participant-input",children:"Minutes per participant:"}),n.jsx(wt,{style:{width:"8ch"},id:"minutes-per-participant-input",value:d,onChange:Y,type:"number",min:1,max:60})]}),n.jsx(se,{setting:m.SHOW_REMAINING_EVENT_TIME}),n.jsxs("div",{className:"labeled-setting",children:[n.jsx("label",{children:"Event end time"}),n.jsx(st,{className:"date-time-input",selected:b,showTimeSelect:!0,showTimeCaption:!0,includeDates:[new Date],showIcon:!0,dateFormat:"YYYY-MMM-dd HH:mm",timeFormat:"HH:mm",placeholderText:"Pick end time",onChange:_=>_&&I(_)})]}),n.jsxs("fieldset",{id:"today-participant-list",children:[n.jsx("legend",{children:"Participants"}),n.jsx("div",{style:{maxHeight:"50vh"},children:n.jsx(Pe,{scrollable:!0,onChangeOnlyOnBlur:!0,initialValue:f.join(`
`),onChange:_=>{_!==void 0&&T(_.split(/\n/).map(j=>j.trim()).filter(j=>j.length>0))}})})]})]})}),n.jsx("section",{id:"connection",children:n.jsxs("fieldset",{children:[n.jsx("legend",{children:"Connection"}),n.jsxs("div",{style:{display:"inline-block"},children:[n.jsx(ps,{label:"Baud Rate",value:a.toString(),setValue:_=>r(Number(_)),options:[{300:"300"},{600:"600"},{1200:"1200"},{2400:"2400"},{9600:"9600"}]}),n.jsx(se,{setting:m.AUTO_DETECT_BAUD_RATE}),n.jsx(se,{setting:m.ENABLE_WEB_SERIAL_DRIVERS}),n.jsx(se,{setting:m.ENABLE_AUTO_CONNECT})]})]})}),n.jsx("section",{id:"data-settings",children:n.jsxs("fieldset",{children:[n.jsx("legend",{children:"Data"}),n.jsxs("div",{style:{display:"inline-block"},children:[n.jsx(se,{setting:m.SYNC_DEVICE_STATE_ON_CONNECT}),n.jsx(se,{setting:m.AUTO_UPDATE_MASK_LIST}),n.jsx(se,{setting:m.NORMALIZE_MASK_LIST_NAMES}),n.jsxs("div",{className:"labeled-setting",children:[n.jsxs("select",{id:"download-file-format-selector",defaultValue:c,onChange:q,children:[n.jsx("option",{value:"all-raw-data",children:"All Raw data as JSON"}),n.jsx("option",{value:"all-results-as-json",children:"All results as JSON"})]}),n.jsx("input",{className:"button",type:"button",value:"Download!",id:"download-button",onClick:V})]})]})]})}),n.jsxs("section",{id:"advanced-controls",children:[n.jsxs("fieldset",{children:[n.jsx("legend",{children:"Advanced"}),n.jsxs("div",{style:{display:"inline-block"},children:[n.jsx(se,{setting:m.ENABLE_TESTER_MODE}),n.jsx(se,{setting:m.USE_IDLE_AMBIENT_VALUES}),n.jsx(se,{setting:m.SAMPLE_MASK_WHEN_IDLE}),n.jsx(se,{setting:m.ENABLE_CONTROL_SOURCE_WIDGET}),n.jsx(se,{setting:m.SHOW_STDDEV}),n.jsx(se,{setting:m.SHOW_SIMULATOR_RESULTS}),n.jsx(se,{setting:m.ENABLE_SIMULATOR}),n.jsx(ct,{trueLabel:"Show Danger Zone",value:i,setValue:o})]})]}),i&&n.jsxs("fieldset",{children:[n.jsxs("legend",{className:"svg-container",style:{backgroundColor:"red",color:"whitesmoke"},children:[n.jsx(fs,{}),n.jsx(gs,{})," Danger Zone ",n.jsx(gs,{}),n.jsx(fs,{})]}),n.jsx("input",{type:"button",value:"Clear Local Storage",onClick:()=>localStorage.clear()})]})]}),n.jsxs("fieldset",{id:"mask-list",children:[n.jsx("legend",{children:"Mask list"}),n.jsx("div",{style:{maxHeight:"50vh"},children:n.jsx(Pe,{scrollable:!0,onChangeOnlyOnBlur:!0,initialValue:p.join(`
`),onChange:_=>{_!==void 0&&g(_.split(/\n/).map(j=>j.trim()).filter(j=>j.length>0))}})})]}),n.jsxs("fieldset",{id:"settings-state",children:[n.jsx("legend",{children:"Settings & State"}),n.jsxs("div",{className:"inline-flex",children:[n.jsx(it,{compact:!0}),n.jsx("button",{onClick:G,disabled:C!==te.RECEIVING,children:"Fetch settings & state info"})]}),n.jsx(R,{label:"Serial Number",children:s.serialNumber}),n.jsx(R,{label:"Last Service Date",children:s.lastServiceDate.toISOString()}),n.jsx(R,{label:"Run Time Since Service",children:ie(1e3*s.runTimeSinceFactoryServiceSeconds)}),n.jsx(R,{label:"Num Exercises",children:s.numExercises}),n.jsx(R,{label:"Ambient Purge",children:ie(1e3*s.ambientPurge)}),n.jsx(R,{label:"Ambient Sample",children:ie(1e3*s.ambientSample)}),n.jsx(R,{label:"Mask Purge",children:ie(1e3*s.maskPurge)}),[...s.maskSample.entries()].map(([_,j])=>n.jsx(R,{label:`Ex ${String(_)} sample`,children:ie(1e3*j)},_)),[...s.fitFactorPassLevel.entries()].map(([_,j])=>n.jsx(R,{label:`FF pass level ${String(_)}`,children:j},_)),n.jsx(R,{label:"Battery",children:e.batteryStatus}),n.jsx(R,{label:"Pulse",children:e.pulseStatus}),[...e.componentVoltages.entries()].map(([_,j])=>n.jsx(R,{label:`${_} voltage`,children:j},_))]})]})]})}):n.jsx("div",{id:"viewer-settings-panel",style:{display:"flex",height:"inherit"},children:n.jsxs("fieldset",{children:[n.jsx("legend",{children:"Settings"}),n.jsx("section",{id:"settings",style:{display:"flex",flexDirection:"row",flexWrap:"wrap",justifyContent:"center",alignItems:"stretch"},children:n.jsx("section",{id:"advanced-controls",children:n.jsxs("fieldset",{children:[n.jsx("legend",{children:"Advanced"}),n.jsx("div",{style:{display:"inline-block"},children:n.jsx(se,{setting:m.ENABLE_TESTER_MODE})})]})})})]})})]})}function Sr(){return n.jsx(ot,{buttonIcon:n.jsx(lr,{className:"nav-icon"}),position:"right",children:n.jsx(Ks,{})})}function qs({label:t="Last line",border:e=!0}){const a=u.useContext(X).portaCountClient,[r,i]=u.useState(a.state.lastLine),[o,c]=u.useState(new Date(0));u.useEffect(()=>{const d=()=>setTimeout(()=>{i(""),console.debug("last line timeout expired")},3e3);let h=d();const p={lineReceived(g){clearTimeout(h),i(g),c(new Date),h=d()}};return a.addListener(p),()=>{a.removeListener(p),clearTimeout(h)}},[]);const l=n.jsx(n.Fragment,{children:r.trim().length==0?"":r});return t?n.jsxs("fieldset",{className:"info-box-compact",style:{width:"8rem"},children:[n.jsxs("legend",{className:"number-field no-wrap",children:[t," ",r.trim().length>0?ca(o,!0):""]}),n.jsx("div",{className:"console-8020",children:l})]}):n.jsx("div",{className:`console-8020 ${e&&"thin-border"}`,children:l})}function Tr(){const e=u.useContext(X).portaCountSimulator,[s]=w(m.ENABLE_SIMULATOR),[a]=w(m.ENABLE_TESTER_MODE),r=s&&a,[i,o]=u.useState(e.targetCount),[c,l]=u.useState(e.targetCountVariancePct),[d,h]=u.useState(e.targetMaskFF),[p,g]=u.useState(e.targetMaskFFVariancePct);function f(b){e.targetCount=b,o(b)}function T(b){e.targetCountVariancePct=b,l(b)}function E(b){e.targetMaskFF=b,h(b)}function v(b){e.targetMaskFFVariancePct=b,g(b)}return n.jsx(n.Fragment,{children:r&&n.jsxs(ot,{position:["right"],buttonIcon:n.jsx(dr,{className:"nav-icon"}),children:[n.jsx("span",{style:{fontSize:"xx-large"},children:"Simulator"}),n.jsxs("div",{style:{display:"grid",gridTemplateColumns:"max-content 1fr 5ch",justifyItems:"start"},children:[n.jsx("span",{children:"Target Count:"}),n.jsx("input",{type:"range",min:0,max:1e4,value:i,step:100,onChange:b=>f(Number(b.target.value))}),n.jsx("span",{children:i}),n.jsx("span",{children:"Count Variance:"}),n.jsx("input",{type:"range",min:0,max:100,value:c,step:1,onChange:b=>T(Number(b.target.value))}),n.jsx("span",{children:c}),n.jsx("span",{children:"Target FF:"}),n.jsx("input",{type:"range",min:1,max:1e3,value:d,step:1,onChange:b=>E(Number(b.target.value))}),n.jsx("span",{children:d}),n.jsx("span",{children:"FF Variance:"}),n.jsx("input",{type:"range",min:0,max:100,value:p,step:1,onChange:b=>v(Number(b.target.value))}),n.jsx("span",{children:p})]}),n.jsx(qs,{})]})})}const Er=()=>{const[t]=w(m.KEEP_SCREEN_AWAKE),e=u.useRef(null);async function s(){if(e.current===null&&document.visibilityState==="visible")try{e.current=await navigator.wakeLock.request("screen")}catch(r){console.warn(r)}}const a=u.useCallback(()=>{t&&s()},[t]);u.useEffect(()=>(t?(s(),document.addEventListener("visibilitychange",a)):e.current!==null&&(console.debug("removing wake lock"),document.removeEventListener("visibilitychange",a),e.current.release().then(()=>{e.current=null})),()=>{document.removeEventListener("visibilitychange",a)}),[t,a])},xr=["touchstart","touchend","touchcancel","touchmove"];class br{touchStartPoint;links;location;navigate;constructor(e,s,a){this.touchStartPoint=null,this.links=e,this.location=s,this.navigate=a}handleEvent(e){const s=e,r=window.outerWidth*50/100,i=10;switch(s.type){case"touchstart":{const o=s.targetTouches.item(0);o&&(o.clientX<i||o.clientX>window.outerWidth-i?this.touchStartPoint={x:o.clientX,y:o.clientY}:this.touchStartPoint=null);break}case"touchend":{if(!this.touchStartPoint)return;const o=s.changedTouches.item(0);if(!o)return;const c={x:o.clientX,y:o.clientY},l=this.location.pathname,d=this.links.findIndex(h=>h.value===l);c.x>this.touchStartPoint.x+r&&(console.debug("swiped right ->"),d>-1&&this.navigate(this.links[(this.links.length+d-1)%this.links.length].value)),c.x<this.touchStartPoint.x-r&&(console.debug("swiped left <-"),d>-1&&this.navigate(this.links[(d+1)%this.links.length].value)),c.y>this.touchStartPoint.y+r&&console.debug("swiped down V"),c.y<this.touchStartPoint.y-r&&console.debug("swiped up ^");break}}}}function Cr(){const[t]=w(m.SHOW_ELAPSED_PARTICIPANT_TIME),[e]=w(m.SHOW_REMAINING_EVENT_TIME),[s]=w(m.ENABLE_TESTER_MODE),a=Rt(),r=cn(),i=u.useRef(null),[o,c]=u.useState("full-width"),[l,d]=u.useState(0),[h,p]=u.useState(!1);u.useEffect(()=>{const T=new br(g,r,a),E=[...xr];return E.forEach(v=>window.addEventListener(v,T)),()=>{E.forEach(v=>window.removeEventListener(v,T))}},[r]),u.useEffect(()=>{const T=new ResizeObserver(([E])=>{f(E)});return i.current&&T.observe(i.current),()=>{T.disconnect()}},[o]),u.useEffect(()=>{const T=()=>c("full-width");return screen.orientation.addEventListener("change",T),()=>{screen.orientation.removeEventListener("change",T)}},[]),Er();const g=s?[{label:"Test",value:"/test"},{label:"Participant",value:"/participant"},{label:"All Results",value:"/view-results"},{label:"Daily Checks",value:"/daily-checks"},{label:"Cleanup Assistant",value:"/cleanup-assistant"},{label:"Bookmarks",value:"/bookmarks"},{label:"Protocols",value:"/protocols"},{label:"Stats",value:"/stats"},{label:"QR Code",value:"/qrscanner"},{label:"Raw Data",value:"/raw-data"},{label:"Help",value:"/help"}]:[{label:"Results",value:"/view-results"},{label:"Bookmarks",value:"/bookmarks"}];function f(T){const E=window.getComputedStyle(T.target),v=Math.floor(parseFloat(E.height)/parseFloat(E.lineHeight)),b=parseFloat(E.width)-l>0;switch(o){case"full-width":if(fa()){console.debug("mobile mode"),p(!0);break}v>1&&c("2-lines"),p(!1);break;case"2-lines":v<2&&b&&c("full-width"),v>2&&c("time-icons"),p(!1);break;case"time-icons":v<2&&b&&c("2-lines"),v>2&&c("dropdown-tabs"),p(!0);break;case"dropdown-tabs":v<2&&b&&c("time-icons"),p(!0);break}d(parseFloat(E.width))}return n.jsxs("div",{id:"nav-bar",ref:i,className:"nav-bar",children:[n.jsx(sr,{}),n.jsx(cr,{options:g}),n.jsx(ar,{style:{display:t&&s?"inline-flex":"none"},useIcons:h}),g.map(T=>n.jsx(vs,{to:T.value,className:({isActive:E})=>E?"nav-link-active":"nav-link-hidden",children:n.jsx("div",{className:"no-wrap",children:T.label})},T.label)),n.jsx(rr,{style:{display:e&&s?"inline-flex":"none"},useIcons:h}),n.jsx(Tr,{}),n.jsx(Sr,{})]})}function vr({children:t}){return n.jsx(X.Provider,{value:zs,children:t})}function _r(){const t=window.location.pathname,e=t.endsWith("old/")||t.endsWith("-old");return n.jsx(n.Fragment,{children:n.jsx(vr,{children:n.jsx("div",{className:`app-border-container ${e?"red-border":""}`,children:n.jsxs("div",{className:"app-container",style:{display:"flex",flexDirection:"column"},children:[n.jsx("div",{id:"navbar-container",style:{position:"relative",top:0,left:0},children:n.jsx(Cr,{})}),n.jsx("div",{id:"main-container",style:{position:"relative",top:"0.1rem",height:"100%",overflow:"auto",backgroundColor:"var(--root-color)"},children:n.jsx(ln,{})})]})})})})}function Ys(){return n.jsxs("div",{style:{display:"block"},children:["This app requires Chrome browser for some features. Get it here: ",n.jsx("a",{href:"https://www.google.com/chrome/",children:"https://www.google.com/chrome/"})]})}function Nr(){const t=navigator.userAgent.includes("Chrome");return n.jsx(n.Fragment,{children:!t&&n.jsx(Ys,{})})}function wr(){const[t]=w(m.ENABLE_TESTER_MODE),e=Rt();return u.useEffect(()=>{e(t?"/test":"/view-results")},[]),n.jsx(n.Fragment,{children:n.jsx(Nr,{})})}function yr({...t}){return n.jsx("fieldset",{style:{borderBottom:"none",borderInline:"none",paddingInline:0,minWidth:0},children:t.children})}function Ar(t){const s=u.useContext(X).dataCollector,[a]=w(m.PROTOCOL_EXECUTION_STATE);function r(){s.recordTestStart(B.Manual)}return n.jsx("div",{id:"manual-entry-button",children:n.jsxs("button",{disabled:a!=="Idle",onClick:()=>r(),className:"icon-button",children:[t.text||"Manual"," ",n.jsx("div",{className:"svg-container icon-button",children:n.jsx(or,{})})]})})}function Rr(t){const e=u.useRef(null);return u.useEffect(()=>{try{Fn(Object.assign({},t,{target:e.current}))}catch(s){console.error(s)}}),n.jsxs("div",{id:"function-plot-container",children:[n.jsx("style",{id:"function-plot-custom-styles",children:"path.line { opacity: 0.5;}"}),n.jsx("div",{ref:e})]})}const Ir=["#FE2712","#FC600A","#FB9902","#FCCC1A","#FEFE33","#B2D732","#66B032","#347C98","#0247FE","#4424D6","#8601AF","#C21460"];function Ss(t){return Ir[t]||"black"}function Xs(t){const[e,s]=u.useState(!0),[a,r]=u.useState(!1),[i,o]=u.useState(!1);let c=[];t.records?c=t.records.filter(C=>!isNaN(Number(C["Ex 1"]))).toSpliced(10).map(C=>{const P=Object.keys(C).filter(K=>K.startsWith("Ex")&&!isNaN(Number(C[K]))).map(K=>C[K]);return{lo:Math.min(...P),hi:Math.max(...P),label:`${Pt(C.Mask??"").shortName} (${C.ID})`}}):t.ranges&&(c=t.ranges.filter(C=>!(isNaN(C.hi)||isNaN(C.lo))));function l(C,P){return{fn:K=>({hi:we(K.x.hi),lo:we(C.lo)}),range:[C.lo,C.hi],color:Ss(P)}}function d(C,P){return{fn:K=>({hi:la(K.x.hi),lo:C.lo}),range:[we(C.lo),we(C.hi)],color:Ss(P)}}function h(C){return{graphType:"text",location:e?[we(C.lo),C.lo]:[C.lo,we(C.lo)],text:C.label,color:"black"}}const p=1.001,g=200,f=1,T=99.99,E={domain:[i?Math.min(...c.map(C=>we(C.lo))):f,i?Math.max(...c.map(C=>we(C.hi))):T],type:"linear",label:"Filtration %"},v={domain:[a?Math.min(...c.map(C=>C.lo)):p,a?Math.max(...c.map(C=>C.hi)):g],type:"log",label:"Fit Factor"},b={fn:"1/(1-x/100)",range:[f,T]},I={fn:"100*(1-1/x)",range:[p,g]};return n.jsxs("div",{children:[n.jsxs("div",{children:[n.jsx("button",{onClick:()=>s(!e),children:"Invert"}),n.jsx("button",{onClick:()=>o(!i),children:"Zoom Efficiency"}),n.jsx("button",{onClick:()=>r(!a),children:"Zoom Fit Factor"})]}),n.jsx(Rr,{height:300,width:1e3,grid:!0,tip:{xLine:!0,yLine:!0,renderer:(C,P)=>e?`${vt(C)}% = FF:${qt(P)}`:`${vt(P)}% = FF:${qt(C)}`},xAxis:e?E:v,yAxis:e?v:E,data:[e?b:I,...c.map((C,P)=>e?d(C,P):l(C,P)),...c.map(C=>h(C))]})]})}function Pr(t,e){return t.Time===e.Time&&(t.ID===e.ID||t.Final===e.Final&&t["Ex 1"]===e["Ex 1"])}function Lr(t){const e=nt(t);return delete e.ID,delete e.source,e}async function tt(){return await Ce.getData()}async function Zs(t){const e=t.length;t=t.filter(c=>"Time"in c&&"ID"in c&&"Ex 1"in c);const s=e-t.length,a=await tt(),r=a.length,i=[],o=[];for(const c of t)if(a.some(l=>Pr(l,c)))o.push(c);else{const l=Lr(c);l.source="ext",i.push(l)}for(const c of i){const l=await Ce.addRecord(c);c.ID=l}return a.push(...i),console.log(`total records ${a.length}, new records ${i.length}, old records ${r}`),{allRecords:a,newRecords:i,duplicateRecords:o,attemptedRecordCount:e,rejectedRecordCount:s}}function Js(t){return t.getRowModel().rows.map(e=>e.original)}function Or(t,e="cft-results"){const s=Js(t);yt(JSON.stringify(s),e,"json")}async function kr(){if(!("showOpenFilePicker"in window)){const t="showOpenFilePicker not supported. Unable to import file.";return console.error(t),Promise.reject(t)}return window.showOpenFilePicker({id:"file-to-import"}).then(t=>t[0].getFile()).then(t=>t.text()).then(t=>JSON.parse(t)).then(t=>Zs(t)).then(t=>(console.debug(`imported ${t.newRecords.length} records of ${t.attemptedRecordCount}, ignored ${t.duplicateRecords.length} duplicates, rejected ${t.rejectedRecordCount}. total records: ${t.allRecords.length}`),t)).catch(t=>{console.log("Error importing file",t)})}function Dr({table:t,...e}){return n.jsx("button",{...e,onClick:()=>gr(t),children:"Export to CSV"})}function Mr({table:t,...e}){const[s,a]=u.useState([]),i=location.origin+location.pathname+un("/view-results");u.useEffect(()=>{if(s){console.log("adding key listener");const d=h=>{console.log(`key listener got event: ${JSON.stringify(h)}`),h.code==="Escape"&&a([])};return window.addEventListener("keydown",d),()=>{window.removeEventListener("keydown",d),console.log("removed key listener")}}},[s]);function o(d){return`${i}?data=${ws.compressToEncodedURIComponent(JSON.stringify(d))}`}function c(){const d=Js(t),h=[];for(;d.length>0;){let p=null,g=1,f=null,T=[];for(;g<=d.length&&(T=d.toSpliced(g),f=o(T),f.length<=2953);g++)p=f;if(p)h.push(p),d.splice(0,g);else{console.warn(`could not encode data. resulting url for 1 record is too long at ${f?.length}`);break}}a(h)}function l(){const d=t.getState().columnFilters;let h="",p="";return d.forEach(g=>{g.id==="Time"&&(h=g.value),g.id==="Participant"&&(p=g.value)}),[p&&`for ${p}`,h&&`on ${h}`].join(" ")}return n.jsxs(n.Fragment,{children:[s.length>0&&n.jsx("div",{className:"full-screen-overlay",children:n.jsx("div",{style:{display:"flex",flexDirection:"column"},children:s.map((d,h)=>n.jsxs("div",{onClick:()=>a([]),className:"qrcode-container",children:[n.jsx("a",{href:d,children:n.jsxs("span",{style:{display:"block"},children:["Fit test results ",l()," (",h+1," / ",s.length,")"]})}),n.jsx("span",{style:{display:"block"},children:i}),n.jsx(Qe,{value:d,size:512,marginSize:4,title:"Fit Test Results"})]},h))})}),n.jsx("button",{...e,onClick:()=>c(),children:"QR Code"})]})}function Ft(t){const[e]=w(m.COMBINED_MASK_LIST);function s(r){t.onChange&&t.onChange(r)}const a=u.useCallback(()=>e.toSorted(Be.compare).map(r=>({label:r,value:r})),[e]);return n.jsx(Pe,{id:`mask-${t.id}`,className:t.className,onChangeOnlyOnBlur:!0,label:t.label,initialValue:t.value,autocompleteOptions:a,placeholder:t.placeholder||"Click to add mask",onChange:r=>s(r||"")})}function jr({column:t,dates:e}){const s=t.getFilterValue(),{filterVariant:a}=t.columnDef.meta??{};switch(a){case"range":return n.jsxs("div",{children:[n.jsxs("div",{className:"flex space-x-2",children:[n.jsx(wt,{type:"number",value:s?.[0]??"",onChange:r=>t.setFilterValue(i=>[r,i?.[1]]),placeholder:"Min",className:"w-24 border shadow rounded"}),n.jsx(wt,{type:"number",value:s?.[1]??"",onChange:r=>t.setFilterValue(i=>[i?.[0],r]),placeholder:"Max",className:"w-24 border shadow rounded"})]}),n.jsx("div",{className:"h-1"})]});case"select":return n.jsxs("select",{onChange:r=>t.setFilterValue(r.target.value),value:s?.toString(),children:[n.jsx("option",{value:"",children:"All"}),n.jsx("option",{value:"complicated",children:"complicated"}),n.jsx("option",{value:"relationship",children:"relationship"}),n.jsx("option",{value:"single",children:"single"})]});case"date":{const r=t.getFilterValue(),i=r?new Date(r):null;return n.jsx(st,{id:t.id,minDate:new Date("2024-01-01"),maxDate:new Date,isClearable:!0,placeholderText:"Search...",selected:i,showMonthYearDropdown:!0,includeDates:e,showIcon:!0,showDisabledMonthNavigation:!0,className:"date-picker-input",todayButton:n.jsx("input",{type:"button",value:"Today"}),onChange:o=>t.setFilterValue(o?.toLocaleDateString())})}case"mask":{const r=t.getFilterValue()||"";return n.jsx(Ft,{className:"table-cell",id:"filter",value:r,placeholder:"Search...",onChange:i=>t.setFilterValue(i)})}default:return n.jsx(Pe,{id:`${t.id}-filter`,className:"table-cell",onChange:r=>t.setFilterValue(r),placeholder:"Search...",initialValue:s??""})}}function lt(t,e,s=!0){const a=u.useMemo(()=>ha(e>1?e:NaN,s),[e]),[r,i]=u.useState({});u.useEffect(()=>{if(t.current){t.current.style.backgroundColor=a;const c=window.getComputedStyle(t.current).backgroundColor,l=da(c);t.current.style.color=l,c==="rgba(0, 0, 0, 0)"&&setTimeout(()=>i({}),.1)}},[a,t,r])}function Fr({getValue:t,row:e,column:{id:s},table:a}){const r=u.useContext(X),{index:i,original:o}=e,c=t(),[l,d]=de.useState(c),h=u.useRef(null),[p]=w(m.SHOW_STDDEV),g=u.useCallback(()=>{l!=c&&a.options.meta?.updateData(i,s,l)},[l,s,i,a.options.meta,c]);de.useEffect(()=>{d(c)},[c]),u.useEffect(()=>{g()},[l]);const{exerciseNum:f}=s.match(/.*?(?<exerciseNum>[0-9]+)$/)?.groups??{exerciseNum:0},T=e.original.ProtocolName&&r.settings.numExercisesForProtocol[e.original.ProtocolName]>=Number(f)||!1,E=e.original.TestController===B.Manual&&T,v=pa(Number(f),e.original)?.count??0,b=Number(l),I=Lt(b),C=(o.ParticleCounts??[]).filter(V=>V.type===k.AMBIENT),P=Ls(...C.map(V=>V.count)),H=Math.sqrt(C.map(V=>V.stddev??0).reduce((V,W)=>V+W**2,0))/P,q=ma(l,T);return lt(h,b,T),n.jsxs(n.Fragment,{children:[n.jsx("style",{children:`
            .editable-cell {
               background-color: transparent;
               color: inherit;
               padding: 0;
               height: 1.5em;
               max-width: 100%;
               border: none;
               font-size: inherit;
               text-overflow: ellipsis;
            }
`}),n.jsxs("div",{className:[q,"table-cell"].join(" "),style:{width:"100%",display:"inline-flex",flexDirection:"column"},ref:h,children:[n.jsxs("div",{className:"inline-flex",children:[E?n.jsx("input",{value:l||"",onChange:V=>d(V.target.value),onBlur:g,placeholder:`${s}`,className:"editable-cell"}):n.jsxs("div",{children:[b>0&&Ue(b),p&&f===0&&b>0&&H>0&&`${Math.round(H*b)}`]}),l&&e.original.ParticleCounts&&v===0&&"*"]}),b>0&&n.jsxs("span",{className:"efficiency",children:[I,"%"]})]})]})}function Ts({getValue:t,row:{index:e},column:{id:s},table:a}){const r=t(),[i,o]=de.useState(r),c=u.useCallback(()=>{i!=r&&a.options.meta?.updateData(e,s,i)},[i,s,e,a.options.meta,r]);return de.useEffect(()=>{o(r)},[r]),u.useEffect(()=>{c()},[i]),n.jsx(Pe,{className:"table-cell",id:`${String(e)}-${s}`,onChangeOnlyOnBlur:!0,initialValue:i||"",onChange:l=>o(l),onBlur:c,placeholder:`Click to add ${s}`})}function $r({getValue:t,row:{index:e},column:{id:s},table:a}){const r=t(),[i,o]=de.useState(r),c=u.useCallback(l=>{l!=r&&(a.options.meta?.updateData(e,s,l),o(l))},[i,s,e,a.options.meta,r]);return n.jsx(Ft,{id:String(e),className:"table-cell",value:i??"",onChange:l=>c(l)})}function Ur(){const t=de.useRef(!0),e=t.current,s=de.useCallback(()=>{t.current=!1},[]);return de.useEffect(()=>{t.current=!0}),[e,s]}function Qs({tableData:t,setTableData:e,searchableColumns:s=["Time","Participant","Mask","Notes","ProtocolName"],hideColumns:a=[],minExercisesToShow:r=0,columnSortingSettingKey:i=m.RESULTS_TABLE_SORT,columnFilterSettingKey:o=m.RESULTS_TABLE_FILTER,deleteRowsCallback:c}){const l=u.useContext(X),d=l.dataCollector,h=new Intl.DateTimeFormat(void 0,{hour12:!1,hour:"numeric",minute:"numeric",second:"numeric",month:"2-digit",day:"2-digit",year:"numeric"});function p(x){return g(`Ex ${x}`)}function g(x){return{accessorKey:x,cell:Fr,enableColumnFilter:!1,sortUndefined:void 0,sortingFn:T,sortDescFirst:!0,size:60}}function f(x){try{return Array.from(Array(x).keys()).map(S=>p(S+1))}catch(S){return console.error(S),[]}}function T(x,S,A){let L=Number.parseFloat(x.getValue(A)),F=Number.parseFloat(S.getValue(A));return Number.isNaN(L)&&(L=Number.NEGATIVE_INFINITY),Number.isNaN(F)&&(F=Number.NEGATIVE_INFINITY),L>F?1:L<F?-1:0}function E(x,S,A){const L=new Date(x.getValue(A)).getTime(),F=new Date(S.getValue(A)).getTime();return L>F?1:L<F?-1:0}const[v,b]=u.useState(1);function I(x,S,A){const L=x.getValue(S);if((A??"").trim()===(L??"").trim())return!0;try{return RegExp(A,"i").test(L)}catch{return L.includes(A)}}const[C,P]=u.useState([]),K=de.useMemo(()=>[{accessorFn:x=>C.includes(x.ID),header:"Select",cell:x=>{const S=x.row.getValue("ID");return n.jsx("input",{type:"checkbox",checked:C.includes(S),onChange:A=>{A.target.checked?P(L=>[...L,S]):P(L=>L.filter(F=>F!==S))}})},enableColumnFilter:!1,size:50},{accessorKey:"ID",header:"ID",cell:x=>n.jsx("div",{className:"table-cell",children:x.cell.getValue()}),enableColumnFilter:!1,size:50},{accessorKey:"Time",header:"Date",cell:x=>{const S=x.getValue();return n.jsx("div",{className:"table-cell",children:S?h.format(new Date(S)):null})},enableColumnFilter:s.includes("Time"),filterFn:(x,S,A)=>x.getValue(S).startsWith(A),sortingFn:E,meta:{filterVariant:"date"}},{accessorKey:"Participant",cell:Ts,enableColumnFilter:s.includes("Participant"),filterFn:I},{accessorKey:"Mask",cell:$r,enableColumnFilter:s.includes("Mask"),filterFn:I,meta:{filterVariant:"mask"}},{accessorKey:"Notes",cell:Ts,enableColumnFilter:s.includes("Notes"),filterFn:I},g("Final"),...f(v),{accessorKey:"ProtocolName",enableColumnFilter:s.includes("ProtocolName"),filterFn:I,cell:x=>{const S=x.row.original;return n.jsx("div",{className:"table-cell",children:`${S.ProtocolName} - ${S.TestController}`})},header:"Protocol"},{accessorKey:"DataSource",header:"DataSource",filterFn:I}],[v,C]),[H,q]=u.useState(!1),[V,W]=Ur(),[O,Y]=w(o),[G]=w(m.SHOW_SIMULATOR_RESULTS),[_]=w(m.SHOW_MASK_PERF_GRAPH),[j,he]=w(i),[Ee]=w(m.TEST_TEMPLATE),[ge,oe]=u.useState(a.reduce((x,S)=>(x[S]=!1,x),{}));u.useEffect(()=>{ge.Select=H,ge.DataSource=!1,oe(nt(ge)),H||P([])},[H]);const ae=On({data:t,columns:K,enableColumnResizing:!0,columnResizeMode:"onChange",getCoreRowModel:Dn(),getSortedRowModel:Mn(),getFilteredRowModel:jn(),state:{sorting:j,columnFilters:O,columnVisibility:ge},onColumnFiltersChange:Y,onSortingChange:he,autoResetPageIndex:V,meta:{updateData:(x,S,A)=>{d&&(W(),e(L=>L.map((D,y)=>{if(y===x){const $={...L[x],[S]:A};return d.updateTest($),$}return D})))}},debugTable:!0});function xe(){const x=ae.getFilteredRowModel(),S=l.settings.numExercisesForProtocol;let A=r;x.rows.forEach(L=>{for(;L.original[`Ex ${A+1}`];)A+=1;const F=L.original.ProtocolName;(S[F]||4)>A&&(A=S[F]||4)}),b(A)}const{rows:fe}=ae.getRowModel(),Ne=[new Date,...new Set(t.map(x=>new Date(x.Time)))],Q=de.useRef(null),Z=kn({count:fe.length,estimateSize:()=>33,getScrollElement:()=>Q.current,measureElement:typeof window<"u"&&navigator.userAgent.indexOf("Firefox")===-1?x=>x?.getBoundingClientRect().height:void 0,overscan:5});u.useEffect(()=>{Y(x=>[...x.filter(S=>S.id!=="DataSource"),new class{id="DataSource";value="^((?!Simulator).)*$"}].filter(S=>S.id!=="DataSource"||!G))},[G]),u.useEffect(()=>{xe()},[O,t,r]),u.useEffect(()=>{const x={currentTestUpdated(S){e(A=>[...A.filter(L=>L.ID!==S.ID),S])}};return d.addListener(x),()=>{d.removeListener(x)}},[d]);function z(){P([]),c&&c(C)}function re(x){return`${x.replace(/\s+/g,"_")}-column`}const N=u.useCallback(()=>{if(o===m.PARTICIPANT_RESULTS_TABLE_FILTER){const x=(Ee.Participant??"").toLowerCase().replace(/[^a-zA-Z]+/g,"-");return`cft-results${x?`-${x}`:""}`}else return"cft-results"},[O,o]);return n.jsxs("div",{className:"results-table-container",children:[n.jsx("style",{id:"per-column-styles",children:ae.getHeaderGroups().flatMap(x=>x.headers.map(S=>{const A=`.${re(S.id)}`,L=S.getSize();return`${A} { width: ${L}px; }`}))}),n.jsxs("div",{children:[n.jsx("div",{style:{display:"inline-block"},children:n.jsx(ct,{trueLabel:"Enable selection",value:H,setValue:q})}),H&&c&&n.jsx("button",{onClick:()=>z(),children:"Delete selected"}),n.jsx(Dr,{table:ae}),n.jsx(Mr,{table:ae}),n.jsx("button",{onClick:()=>Or(ae,N()),children:"Export JSON"}),n.jsx("button",{onClick:()=>{kr().then(x=>{x.newRecords.length>0&&e(x.allRecords)})},children:"Import JSON"})]}),n.jsx("div",{className:"container",ref:Q,style:{overflow:"auto",flexGrow:1},children:n.jsxs("table",{style:{display:"grid"},children:[n.jsx("thead",{className:"results-table-header",children:ae.getHeaderGroups().map(x=>n.jsx("tr",{className:"results-table-header-row",children:x.headers.map(S=>n.jsxs("th",{className:`results-table-header-cell ${re(S.id)}`,colSpan:S.colSpan,children:[S.isPlaceholder?null:n.jsxs("div",{children:[n.jsxs("div",{className:S.column.getCanSort()?"cursor-pointer select-none":"",onClick:S.column.getToggleSortingHandler(),children:[Ht(S.column.columnDef.header,S.getContext()),{asc:" ",desc:" "}[S.column.getIsSorted()]??null]}),S.column.getCanFilter()&&n.jsx("div",{children:n.jsx(jr,{column:S.column,dates:Ne})})]}),S.column.getCanResize()&&n.jsx("div",{onMouseDown:S.getResizeHandler(),onTouchStart:S.getResizeHandler(),className:`resizer ${S.column.getIsResizing()?"isResizing":""}`})]},S.id))},x.id))}),n.jsx("tbody",{style:{display:"grid",height:`${Z.getTotalSize()}px`,position:"relative"},children:Z.getVirtualItems().map(x=>{const S=fe[x.index];return n.jsx("tr",{"data-index":x.index,ref:A=>Z.measureElement(A),className:"results-table-virtualized-row",style:{transform:`translateY(${x.start}px)`},children:S.getVisibleCells().map(A=>n.jsx("td",{className:`results-table-cell ${re(A.column.id)}`,children:Ht(A.column.columnDef.cell,A.getContext())},A.id))},S.id)})})]})}),_&&n.jsx(Xs,{records:ae.getSortedRowModel().flatRows.map(x=>x.original)})]})}function Br(){const t=u.useContext(X),[,e]=u.useState({}),s=u.useCallback(()=>{e({})},[]),[a]=w(m.SELECTED_PROTOCOL),[r]=w(m.TEST_TEMPLATE),[i,o]=u.useState([]);u.useEffect(()=>{const d={subscriptions:()=>[m.TEST_TEMPLATE],settingsChanged(h,p){console.log(`setting ${h} changed to ${JSON.stringify(p)}`),c(p.Participant)}};return t.settings.addListener(d),c(r.Participant),()=>{t.settings.removeListener(d)}},[]),u.useEffect(()=>{console.debug(`selectedProtocolChanged, num exercises is ${t.settings.numExercises}`),s()},[a]);function c(d){const h=new Date;d=(d??"").trim();const p=new Date(h.getTime()-h.getTimezoneOffset()*60*1e3).toISOString().substring(0,10);Ce.getData(g=>{const f=new Date(g.Time),T=new Date(f.getTime()-f.getTimezoneOffset()*60*1e3).toISOString().substring(0,10);return(g.Participant??"").trim()===d&&T.startsWith(p)}).then(g=>{o(g)})}async function l(d){await Promise.all(d.map(h=>Ce.deleteRecordById(h))),c(r.Participant)}return n.jsx("div",{id:"current-participant-info",children:n.jsxs(yr,{children:[n.jsx("legend",{children:n.jsxs("div",{style:{display:"inline-flex",gap:"0.7em"},children:["Results",r.Participant?` for ${r.Participant}`:""," ",n.jsx(Ar,{text:"Manual Entry"})]})}),n.jsx("div",{style:{justifySelf:"center",maxWidth:"100%"},children:n.jsx(Qs,{tableData:i,setTableData:o,searchableColumns:[],hideColumns:["Participant","Time"],minExercisesToShow:t.settings.numExercises,columnSortingSettingKey:m.PARTICIPANT_RESULTS_TABLE_SORT,columnFilterSettingKey:m.PARTICIPANT_RESULTS_TABLE_FILTER,deleteRowsCallback:l})})]})})}function Vr(t){const[e,s]=w(m.TEST_NOTES);function a(r){t.onChange&&t.onChange(r),s(i=>[...new Set([...i,r])].filter(o=>o&&o.trim().length>0).toSorted(Be.compare))}return n.jsx(Pe,{id:"notes",onChangeOnlyOnBlur:!0,label:t.label,initialValue:t.value,autocompleteOptions:e.map(r=>({label:r,value:r})),placeholder:"Click to add notes",onChange:r=>a(r||"")})}function Wr(t){const[e]=w(m.COMBINED_PARTICIPANT_LIST);function s(a){t.onChange&&t.onChange(a)}return n.jsx(Pe,{id:"participant",label:t.label,initialValue:t.value,onChangeOnlyOnBlur:!0,autocompleteOptions:e.map(a=>({label:a,value:a})),placeholder:"Click to add participant",onChange:a=>s(a||"")})}function en(){const[t,e,s]=w(m.TEST_TEMPLATE);function a(d){d=d.trim(),o({Participant:d,Time:t.Participant!==d?new Date().toISOString():t.Time})}function r(d){o({Mask:d})}function i(d){o({Notes:d})}function o(d){const h={};Object.assign(h,s()),Object.assign(h,d),console.debug(`updateTestTemplate -> ${JSON.stringify(h)}`),e(h)}function c(){o({Participant:"",Mask:"",Notes:""})}function l(){o({Mask:"",Notes:""})}return n.jsx(n.Fragment,{children:n.jsx(ot,{buttonIcon:n.jsxs("div",{id:"compact-participant-info",style:{display:"inline-flex",flexWrap:"nowrap",overflowX:"scroll",gap:"0.7em",width:"100%"},children:[n.jsxs("span",{className:"svg-container",children:[n.jsx(Gs,{}),t.Participant]}),n.jsxs("span",{className:"svg-container",style:{textWrap:"nowrap"},children:[n.jsx(jt,{}),t.Mask]}),n.jsxs("span",{className:"svg-container",style:{textWrap:"nowrap"},children:[n.jsx(Xa,{}),t.Notes]})]}),position:"top",children:n.jsxs("div",{id:"participant-parameters",style:{display:"flex",textAlign:"start",flexDirection:"row",flexWrap:"wrap",gap:"2px"},children:[n.jsx("div",{className:"thin-border-2 participant-info",children:n.jsx(Wr,{value:t.Participant,onChange:d=>a(d||""),label:n.jsxs("span",{id:"smart-text-area-participant-label",className:"smart-text-area-label",children:["Name ",n.jsx("div",{className:"svg-container",children:n.jsx(Kt,{onClick:()=>c()})})]})})}),n.jsx("div",{className:"thin-border-2 participant-info",children:n.jsx(Ft,{value:t.Mask,id:"mask",onChange:d=>r(d||""),label:n.jsxs("span",{id:"smart-text-area-mask-label",className:"smart-text-area-label",children:["Mask ",n.jsx("div",{className:"svg-container",children:n.jsx(Kt,{onClick:()=>l()})})]})})}),n.jsx("div",{className:"thin-border-2 participant-info remainder",style:{flexGrow:1},children:n.jsx(Vr,{value:t.Notes,label:"Notes",onChange:d=>i(d||"")})})]})})})}function zr(){return n.jsxs("div",{id:"participant-panel",style:{display:"flex",flexDirection:"column"},children:[n.jsx(en,{}),n.jsx(Br,{})]})}function Hr(){const[t,e]=u.useState([]),[s,a]=u.useState(!1);function r(i){i.forEach(o=>{e(c=>c.includes(o.rawValue)?c:[...c,o.rawValue])}),console.debug("QRScanner",i)}return n.jsxs("div",{children:[n.jsxs("fieldset",{id:"qr-scanner-container",style:{width:"calc(min(70vh, 70vw))",justifySelf:"anchor-center",display:"flex",flexDirection:"column",alignItems:"center"},children:[n.jsx("legend",{style:{display:"flex",gap:"1em"},children:n.jsx(ct,{trueLabel:"Enable QR Scanner",value:s,setValue:a})}),n.jsx(Ln,{onScan:r,sound:!1,allowMultiple:!0,paused:!s})]}),n.jsxs("fieldset",{children:[n.jsx("legend",{children:"Scanned payloads:"}),n.jsx("ol",{style:{textAlign:"start"},children:t.map(i=>n.jsx("li",{children:i},i))})]})]})}/*!
 *
 * detectIncognito v1.6.2
 *
 * https://github.com/Joe12387/detectIncognito
 *
 * MIT License
 *
 * Copyright (c) 2021 - 2025 Joe Rutkowski <Joe@dreggle.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 * Please keep this comment intact in order to properly abide by the MIT License.
 *
 **/var At={d:(t,e)=>{for(var s in e)At.o(e,s)&&!At.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},$t={};At.d($t,{A:()=>Gr,k:()=>Ut});var We=function(t,e,s,a){return new(s||(s=Promise))(function(r,i){function o(d){try{l(a.next(d))}catch(h){i(h)}}function c(d){try{l(a.throw(d))}catch(h){i(h)}}function l(d){var h;d.done?r(d.value):(h=d.value,h instanceof s?h:new s(function(p){p(h)})).then(o,c)}l((a=a.apply(t,[])).next())})},ze=function(t,e){var s,a,r,i,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},typeof Symbol=="function"&&(i[Symbol.iterator]=function(){return this}),i;function c(l){return function(d){return function(h){if(s)throw new TypeError("Generator is already executing.");for(;i&&(i=0,h[0]&&(o=0)),o;)try{if(s=1,a&&(r=2&h[0]?a.return:h[0]?a.throw||((r=a.return)&&r.call(a),0):a.next)&&!(r=r.call(a,h[1])).done)return r;switch(a=0,r&&(h=[2&h[0],r.value]),h[0]){case 0:case 1:r=h;break;case 4:return o.label++,{value:h[1],done:!1};case 5:o.label++,a=h[1],h=[0];continue;case 7:h=o.ops.pop(),o.trys.pop();continue;default:if(r=o.trys,!((r=r.length>0&&r[r.length-1])||h[0]!==6&&h[0]!==2)){o=0;continue}if(h[0]===3&&(!r||h[1]>r[0]&&h[1]<r[3])){o.label=h[1];break}if(h[0]===6&&o.label<r[1]){o.label=r[1],r=h;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(h);break}r[2]&&o.ops.pop(),o.trys.pop();continue}h=e.call(t,o)}catch(p){h=[6,p],a=0}finally{s=r=0}if(5&h[0])throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}([l,d])}}};function Ut(){return We(this,void 0,Promise,function(){return ze(this,function(t){switch(t.label){case 0:return[4,new Promise(function(e,s){var a="Unknown",r=!1;function i(g){r||(r=!0,e({isPrivate:g,browserName:a}))}function o(){var g=0,f=parseInt("-1");try{f.toFixed(f)}catch(T){g=T.message.length}return g}function c(){return We(this,void 0,void 0,function(){var g,f;return ze(this,function(T){switch(T.label){case 0:return T.trys.push([0,2,,3]),[4,navigator.storage.getDirectory()];case 1:return T.sent(),i(!1),[3,3];case 2:return g=T.sent(),f=g instanceof Error&&typeof g.message=="string"?g.message:String(g),i(f.includes("unknown transient reason")),[3,3];case 3:return[2]}})})}function l(){var g;return We(this,void 0,Promise,function(){return ze(this,function(f){switch(f.label){case 0:return typeof((g=navigator.storage)===null||g===void 0?void 0:g.getDirectory)!="function"?[3,2]:[4,c()];case 1:return f.sent(),[3,3];case 2:navigator.maxTouchPoints!==void 0?function(){var T=String(Math.random());try{var E=indexedDB.open(T,1);E.onupgradeneeded=function(v){var b=v.target.result,I=function(C){i(C)};try{b.createObjectStore("t",{autoIncrement:!0}).put(new Blob),I(!1)}catch(C){(C instanceof Error&&typeof C.message=="string"?C.message:String(C)).includes("are not yet supported")?I(!0):I(!1)}finally{b.close(),indexedDB.deleteDatabase(T)}},E.onerror=function(){return i(!1)}}catch{i(!1)}}():function(){var T=window.openDatabase,E=window.localStorage;try{T(null,null,null,null)}catch{return void i(!0)}try{E.setItem("test","1"),E.removeItem("test")}catch{return void i(!0)}i(!1)}(),f.label=3;case 3:return[2]}})})}function d(){navigator.webkitTemporaryStorage.queryUsageAndQuota(function(g,f){var T=Math.round(f/1048576),E=2*Math.round(function(){var v,b,I,C=window;return(I=(b=(v=C?.performance)===null||v===void 0?void 0:v.memory)===null||b===void 0?void 0:b.jsHeapSizeLimit)!==null&&I!==void 0?I:1073741824}()/1048576);i(T<E)},function(g){s(new Error("detectIncognito somehow failed to query storage quota: "+g.message))})}function h(){self.Promise!==void 0&&self.Promise.allSettled!==void 0?d():(0,window.webkitRequestFileSystem)(0,1,function(){i(!1)},function(){i(!0)})}function p(){var g;return We(this,void 0,Promise,function(){var f,T,E;return ze(this,function(v){switch(v.label){case 0:if(typeof((g=navigator.storage)===null||g===void 0?void 0:g.getDirectory)!="function")return[3,5];v.label=1;case 1:return v.trys.push([1,3,,4]),[4,navigator.storage.getDirectory()];case 2:return v.sent(),i(!1),[3,4];case 3:return f=v.sent(),T=f instanceof Error&&typeof f.message=="string"?f.message:String(f),i(T.includes("Security error")),[2];case 4:return[3,6];case 5:(E=indexedDB.open("inPrivate")).onerror=function(b){E.error&&E.error.name==="InvalidStateError"&&b.preventDefault(),i(!0)},E.onsuccess=function(){indexedDB.deleteDatabase("inPrivate"),i(!1)},v.label=6;case 6:return[2]}})})}(function(){return We(this,void 0,Promise,function(){return ze(this,function(g){switch(g.label){case 0:return o()!==44&&o()!==43?[3,2]:(a="Safari",[4,l()]);case 1:return g.sent(),[3,6];case 2:return o()!==51?[3,3]:(f=navigator.userAgent,a=f.match(/Chrome/)?navigator.brave!==void 0?"Brave":f.match(/Edg/)?"Edge":f.match(/OPR/)?"Opera":"Chrome":"Chromium",h(),[3,6]);case 3:return o()!==25?[3,5]:(a="Firefox",[4,p()]);case 4:return g.sent(),[3,6];case 5:navigator.msSaveBlob!==void 0?(a="Internet Explorer",i(window.indexedDB===void 0)):s(new Error("detectIncognito cannot determine the browser")),g.label=6;case 6:return[2]}var f})})})().catch(s)})];case 1:return[2,t.sent()]}})})}typeof window<"u"&&(window.detectIncognito=Ut);const Gr=Ut,Kr=$t.A;$t.k;function qr(t){const[e,s]=u.useState(!1);return u.useEffect(()=>{Kr().then(a=>s(a.isPrivate))},[]),n.jsx(n.Fragment,{children:e&&n.jsxs("p",{children:[n.jsx("h1",{children:"This is a private browsing window. Results will not be saved beyond the current session. "}),t.altUrl&&n.jsx("a",{href:t.altUrl,children:"Open this link in a normal window to save results."})]})})}function Yr(){const[t]=dn(),[e]=u.useState(t.get("data")?window.location.href:null),[s,a]=u.useState([]),r=Rt();async function i(){const c=t.get("data");if(c){const l=ws.decompressFromEncodedURIComponent(c);if(r("",{replace:!0}),l){const d=JSON.parse(l),{allRecords:h}=await Zs(d);a(h)}else console.log("no data from url"),a(await tt())}else console.log("no data parameter"),a(await tt())}u.useEffect(()=>{Ce.open().then(()=>i()).catch(c=>console.log(`error while opening db: ${c}`))},[]);async function o(c){await Promise.all(c.map(l=>Ce.deleteRecordById(l))),a(await tt())}return n.jsxs("div",{style:{justifySelf:"center",maxWidth:"100%",height:"100%"},children:[n.jsx(qr,{altUrl:e}),n.jsx(Qs,{tableData:s,setTableData:a,deleteRowsCallback:o})]})}function Xr(){const[t,e]=w(m.PROTOCOL_INSTRUCTION_SETS),s=u.useContext(X),[a,r]=u.useState(JSON.stringify(t,null,2)),[i,o]=u.useState(!0);function c(l){r(l);try{const d=JSON.parse(l);bt(d)?(e(d),o(!0)):(console.error(bt.errors),o(!1))}catch(d){console.error("error parsing json:",d),o(!1)}}return n.jsxs(n.Fragment,{children:[n.jsx("section",{id:"controls",children:n.jsx("button",{id:"reset",onDoubleClick:()=>s.settings.resetToDefault(m.PROTOCOL_INSTRUCTION_SETS),children:"Reset to default (double click)"})}),n.jsx("section",{id:"editor",style:{display:"contents"},children:n.jsx("textarea",{style:{height:"90%",width:"90%",borderWidth:"10px",borderColor:i?"green":"red"},onChange:l=>c(l.target.value),value:a})})]})}const Zr=60*60*1e3;function Jr(){const t=u.useContext(X),[e,s]=w(m.STATS_FIRST_DATE),[a,r]=w(m.STATS_LAST_DATE),[i,o]=u.useState([]),[c,l]=u.useState(0),[d,h]=u.useState(0),[p,g]=u.useState(0),[f,T]=u.useState(0),[E,v]=u.useState(0),[b,I]=u.useState(0),[C,P]=u.useState([]),[K,H]=u.useState([]),[q,V]=u.useState(0),[W,O]=u.useState(0),[Y,G]=u.useState(0),[_,j]=u.useState(0),[he,Ee]=u.useState(0);function ge(N){try{return new Date(N.getTime()-N.getTimezoneOffset()*60*1e3)}catch(x){return console.warn("could not parse date: ",N,x),new Date}}function oe(N){return ge(N).toISOString().substring(0,10).replace(/-/g,"")}function ae(N,x){return new Date(x.Time??0).getTime()-new Date(N.Time??0).getTime()}function xe(N,x){return ae(N,x)>1*60*60*1e3}function fe(N){return N.Time?oe(new Date(N.Time)):""}function Ne(N){N=N.toSorted((y,$)=>(y.Time?ge(new Date(y.Time)).getTime():0)-($.Time?ge(new Date($.Time)).getTime():0)),N=N.filter(y=>!(y.Participant?.match(/zero\s+filter/i)||y.DataSource==="Simulator"||y.DataSource==="Simulator-file")),I(new Set(N.map(y=>y.Mask)).size),h(N.length),g(N.reduce((y,$)=>y+($.Final?1:0),0)),l(N.reduce((y,$,Se,le)=>{const Me=le[Se-1]??{};return y+(xe(Me,$)?1:0)},0)),T(new Set(N.map(y=>`${fe(y)}-${y.Participant}`)).size),v(N.reduce((y,$,Se,le)=>{const Me=le[Se-1]??{};return xe(Me,$)?y:y+ae(Me,$)},0));const x=new Map;N.forEach((y,$,Se)=>{const le=Se[$-1]??{};if(xe(le,y))return null;const Me=`${fe(le)}-${le.Participant}`,sn=ae(le,y);x.set(Me,sn+(x.get(Me)||0))}),G(ht(new Array(...x.values())));const S=new Map;N.forEach(y=>{const $=`${fe(y)}-${y.Participant}`;S.set($,(S.get($)??new Set).add(y.Mask??"unknown mask"))});const A=[...S.values()].map(y=>y.size);j(ht(A)),Ee(Os(A)),O(ht(N.map((y,$,Se)=>{const le=Se[$-1]??{};return xe(le,y)||!y.Final?null:ae(le,y)}).filter(y=>y!==null)));const L=t.settings.getProtocolDuration(t.settings.getDefault(m.SELECTED_PROTOCOL));V(N.filter(y=>y.Final).reduce((y,$)=>y+($.ProtocolName?t.settings.getProtocolDuration($.ProtocolName):L),0)),P(N.toSorted((y,$)=>($.Final??0)-(y.Final??0)).filter(y=>!(!y.Final||isNaN(y.Final)||isNaN(Number(y.Final))||!isFinite(Number(y.Final)))).toSpliced(5));const F={};N.forEach(y=>{const $=`${fe(y)}-${y.Participant}-${y.Mask}`;F[$]=y});const D={};Object.values(F).forEach(y=>{const Se=Pt(y.Mask??"").shortName;D[Se]=1+(D[Se]??0)}),console.debug(`mask tally: ${JSON.stringify(D)}`),H(Object.entries(D).toSorted((y,$)=>$[1]-y[1]).toSpliced(5))}async function Q(){return new Promise(N=>{const x=new Set;Ce.getData(S=>(x.add(new Date(S.Time)),!1)).then(()=>N([...x].toSorted((S,A)=>S.getTime()-A.getTime())))})}async function Z(){const N=typeof e=="string"?new Date(e):new Date(0),x=typeof a=="string"?new Date(a):new Date,S=Number(oe(N)),A=Number(oe(x)),F=(await rt.getData(D=>{const y=Number(oe(new Date(D.timestamp)));return S<=y&&y<=A})).toSorted((D,y)=>new Date(D.timestamp).getTime()-new Date(y.timestamp).getTime()).reduce((D,y)=>{const $=new Date(y.timestamp).getTime();if($>D.end+Zr){const Se=oe(new Date(y.timestamp)),le=D.longest.get(Se)||{start:$,end:$,longest:{}};le.end-le.start<D.end-D.start&&(le.start=D.start,le.end=D.end,D.longest.set(Se,le)),D.start=$}return D.end=$,D},{start:0,end:0,longest:new Map});console.debug(`event date ranges: ${JSON.stringify(F.longest)}`,F),Ne(await Ce.getData(D=>{const y=Number(oe(new Date(D.Time)));return S<=y&&y<=A}))}u.useEffect(()=>{Z()},[e,a]),u.useEffect(()=>{Q().then(N=>{if(o(N),N.length===0)return;const x=typeof e=="string"?new Date(e):e;x.getTime()===0?s(N[N.length-1]):typeof e=="string"&&s(x)})},[]);function z(N){N?(a&&N>a&&r(N),s(N)):i.length>0?s(i[0]):s(new Date(0))}function re(N){N?(e&&N<e&&s(N),r(N)):i.length>0?r(i[i.length-1]):r(new Date)}return n.jsxs("div",{id:"stats-panel",children:[n.jsx(Xs,{ranges:[{lo:1.3,hi:4.6,label:"cloth"},{lo:2.5,hi:9.6,label:"surgical"},{lo:3,hi:39,label:"earloop"},{lo:35,hi:171,label:"headloop"}]}),n.jsxs("section",{id:"stats-date-range-selection",style:{display:"flex",justifySelf:"center"},children:["from",n.jsx(st,{id:"stats-first-date-picker",className:"date-picker-input",selected:e,showIcon:!0,dateFormat:"YYYY-MMM-dd",placeholderText:"Start date",highlightDates:i,onChange:N=>z(N)}),"to",n.jsx(st,{id:"stats-last-date-from",className:"date-picker-input",selected:a,showIcon:!0,dateFormat:"YYYY-MMM-dd",placeholderText:"End date",highlightDates:i,onChange:N=>re(N)})]}),n.jsxs("section",{id:"stats-display",style:{display:"flex",flexDirection:"column",justifyContent:"stretch",width:"fit-content",justifySelf:"center"},children:[n.jsxs(R,{label:"For selected date range",children:[n.jsx(R,{label:"Num Events",children:c}),n.jsx(R,{label:"Num Participants",children:f}),n.jsx(R,{label:"Num Masks Tested",children:b}),n.jsx(R,{label:"Num Tests Started",children:d}),n.jsx(R,{label:"Num Tests Completed",children:`${p} (${(100*p/d).toFixed(1)}%)`})]}),n.jsx("hr",{}),n.jsx(R,{label:"Total time from completed tests",children:ie(q*1e3)}),n.jsx(R,{label:"Total event time (estimate)",children:ie(E)}),n.jsxs(R,{label:"Device utilization",children:[(100*q*1e3/E).toFixed(1),"%"]}),n.jsx("hr",{}),n.jsx(R,{label:"Time spent per participant",children:n.jsxs("div",{className:"inline-flex",children:[n.jsx(R,{label:"Average",children:ie(E/f)}),n.jsx(R,{label:"Median",children:ie(Y)})]})}),n.jsx(R,{label:"Time spent per completed test",children:n.jsxs("div",{className:"inline-flex",children:[n.jsx(R,{label:"Average",children:ie(E/p)}),n.jsx(R,{label:"Median",children:ie(W)})]})}),n.jsx("hr",{}),n.jsx(R,{label:"Num masks tested per participant",children:n.jsxs("div",{className:"inline-flex",children:[n.jsx(R,{label:"Average",children:he.toFixed(1)}),n.jsx(R,{label:"Median",children:_.toFixed(1)})]})}),n.jsx("hr",{}),n.jsxs(R,{label:"Per Participant averages",children:[n.jsx(R,{label:"Num Tests Started",children:(d/f).toFixed(1)}),n.jsx(R,{label:"Num Tests Completed",children:(p/f).toFixed(1)})]}),n.jsx("hr",{}),n.jsx(R,{label:"popular masks",children:K.map(([N,x])=>n.jsx(R,{label:N.trim().length===0?"Unnamed mask":N,children:x},N))}),n.jsx("hr",{}),n.jsx(R,{label:"top overall scores",children:C.map(N=>n.jsx(R,{label:N.Mask??"Unnamed mask",children:N.Final},N.ID))}),n.jsx("hr",{}),n.jsx(R,{label:"top individual scores",children:"todo: look at this across all exercises"}),n.jsx("hr",{}),n.jsxs(R,{label:"Per Event averages",children:[n.jsx(R,{label:"Time Spent",children:ie(E/c)}),n.jsx(R,{label:"Num Participants",children:(f/c).toFixed(1)}),n.jsx(R,{label:"Num Masks Tested",children:"todo"}),n.jsx(R,{label:"Num Tests Started",children:(d/c).toFixed(1)}),n.jsx(R,{label:"Num Tests Completed",children:(p/c).toFixed(1)})]})]})]})}function Qr(t){return J({tag:"svg",attr:{version:"1.1",viewBox:"0 0 17 17"},child:[{tag:"g",attr:{},child:[]},{tag:"path",attr:{d:"M9.25 14.5c0 0.415-0.335 0.75-0.75 0.75s-0.75-0.335-0.75-0.75 0.335-0.75 0.75-0.75 0.75 0.335 0.75 0.75zM16 1.5v14c0 0.827-0.625 1.5-1.392 1.5h-12.216c-0.767 0-1.392-0.673-1.392-1.5v-14c0-0.827 0.625-1.5 1.392-1.5h12.217c0.766 0 1.391 0.673 1.391 1.5zM15 1.5c0-0.271-0.179-0.5-0.392-0.5h-12.216c-0.213 0-0.392 0.229-0.392 0.5v14c0 0.271 0.179 0.5 0.392 0.5h12.217c0.212 0 0.391-0.229 0.391-0.5v-14zM3 2h11v11h-11v-11zM4 12h9v-9h-9v9z"},child:[]}]})(t)}function ei(){const t=u.useContext(X),[e]=w(m.ENABLE_CONTROL_SOURCE_WIDGET),s=t.portaCountClient,[a,r]=u.useState(s.state.controlSource);u.useEffect(()=>{const o={controlSourceChanged(c){r(c)}};return s.addListener(o),()=>{s.removeListener(o)}},[]);function i(){e?s.externalController.controlSource=a==B.Internal?B.External:B.Internal:console.log("ControlSourceWidget disabled by setting")}return n.jsxs("div",{id:"control-source-widget",onClick:i,className:`svg-container icon-button ${!e&&"disabled"}`,children:[a===B.External&&n.jsx(ur,{}),a===B.Internal&&n.jsx(Qr,{})]})}function tn(t){return J({tag:"svg",attr:{viewBox:"0 0 1024 1024"},child:[{tag:"path",attr:{fill:"#D9D9D9",d:"M551.9 513c19.6 0 35.9-14.2 39.3-32.8A40.02 40.02 0 0 1 552 512a40 40 0 0 1-40-39.4v.5c0 22 17.9 39.9 39.9 39.9zM752 687.8l-.3-.3c-29-17.5-62.3-26.8-97-26.8-44.9 0-87.2 15.7-121 43.8a256.27 256.27 0 0 1-164.9 59.9c-41.2 0-81-9.8-116.7-28L210.5 844h603l-59.9-155.2-1.6-1z"},child:[]},{tag:"path",attr:{d:"M879 824.9L696.3 352V178H768v-68H256v68h71.7v174L145 824.9c-2.8 7.4-4.3 15.2-4.3 23.1 0 35.3 28.7 64 64 64h614.6c7.9 0 15.7-1.5 23.1-4.3 33-12.7 49.4-49.8 36.6-82.8zM395.7 364.7V180h232.6v184.7L719.2 600c-20.7-5.3-42.1-8-63.9-8-61.2 0-119.2 21.5-165.3 60a188.78 188.78 0 0 1-121.3 43.9c-32.7 0-64.1-8.3-91.8-23.7l118.8-307.5zM210.5 844l41.6-107.6.1-.2c35.7 18.1 75.4 27.8 116.6 27.8 61.2 0 119.2-21.5 165.3-60 33.9-28.2 76.3-43.9 121.3-43.9 35 0 68.4 9.5 97.6 27.1l.6 1.6L813.5 844h-603z"},child:[]},{tag:"path",attr:{d:"M552 512c19.3 0 35.4-13.6 39.2-31.8.6-2.7.8-5.4.8-8.2 0-22.1-17.9-40-40-40s-40 17.9-40 40v.6a40 40 0 0 0 40 39.4z"},child:[]}]})(t)}function ti(t){return J({tag:"svg",attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M5 21c.5 -4.5 2.5 -8 7 -10"},child:[]},{tag:"path",attr:{d:"M7.5 15q -3.5 0 -4.5 -6a8.4 8.4 0 0 1 3.438 .402a12 12 0 0 1 -.052 -.793c0 -3.606 3.204 -5.609 3.204 -5.609s2.003 1.252 2.842 3.557q 2.568 -1.557 6.568 -1.557q .396 3.775 -1.557 6.568c2.305 .839 3.557 2.842 3.557 2.842s-3 2.59 -7 2.59c0 1 0 1 .5 3q -6 0 -7 -5"},child:[]}]})(t)}function si(){const t=u.useContext(X),[e]=w(m.PROTOCOL_EXECUTION_STATE),s=u.useRef(null),[a]=w(m.CURRENT_AMBIENT_AVERAGE),[r]=w(m.CURRENT_MASK_AVERAGE),[i,o]=u.useState(c(a,r));u.useEffect(()=>{const f=c(a,r);o(f)},[a,r]),lt(s,i);function c(f,T){return f.mean/Math.max(.01,T.mean)}function l(){e==="Idle"?(console.debug("resetting ambient collector (reset button pressed)"),t.ambientSampleCollector.reset(5*1e3)):console.debug(`protocol execution state is ${e}, ambient sample collector cannot be reset unless Idle`)}function d(){return t.ambientSampleCollector.isPurging()}function h(){return t.maskSampleCollector.isPurging()}function p(){e==="Idle"?(console.debug("resetting mask collector (reset button pressed)"),t.maskSampleCollector.reset(5*1e3)):console.debug(`protocol execution state is ${e}, mask sample collector cannot be reset unless Idle`)}const g=Math.round(100*a.stddev/a.mean);return n.jsxs("div",{id:"estimated-fit-factor",ref:s,className:"eff-container thin-border",style:{height:"auto"},children:[n.jsxs("div",{className:"eff-item",onClick:l,children:[n.jsx(ti,{}),d()?n.jsx(Nt,{}):_t(a.mean)," n=",a.num," =",isNaN(g)?"?":`${g}%`]}),n.jsxs("div",{className:"eff-item",onClick:p,children:[n.jsx(jt,{}),h()?n.jsx(Nt,{}):_t(r.mean)," n=",r.num]}),n.jsxs("div",{className:"eff-item",children:[n.jsx(tn,{}),Ue(i)]}),n.jsxs("div",{className:"percentage",children:[Lt(i),"%"]})]})}function Es({label:t,score:e,displayScoreAsFE:s=!1,stddev:a,onClick:r}){const i=u.useRef(null),[o]=w(m.SHOW_STDDEV);lt(i,e);const c=s?`${Lt(e)}%`:Ue(e);return n.jsxs("fieldset",{className:"exercise-score-box",ref:i,onClick:r,children:[n.jsx("legend",{children:t}),c,o&&a?`${Math.round(a*e)}`:""]})}function ni(){const t=u.useContext(X),e=t.dataCollector,[s,a]=u.useState({}),[r,i]=u.useState(!1);u.useEffect(()=>{const h={newTestStarted(p){a(p)},currentTestUpdated(p){a(p)}};return e.addListener(h),()=>{e.removeListener(h)}},[]);function o(h){t.protocolExecutor.restartFromExercise(h)}const c=u.useRef(null),l=Sa(s);lt(c,l);const d=Object.entries(s).filter(([h,p])=>{const g=Number(p);return h.startsWith("Ex ")&&isFinite(g)&&g>1});return n.jsxs("div",{style:{display:"contents"},children:[n.jsx("input",{type:"checkbox",onClick:()=>i(!r)}),d.map(([h,p])=>{const g=Number(h.substring(3)),f=Number(p);return n.jsx(Es,{label:h,score:f,displayScoreAsFE:r,onClick:()=>o(g)},h)}),n.jsx(Es,{label:n.jsx(tn,{}),score:Number(s.Final??l),displayScoreAsFE:r,stddev:Math.sqrt((s.ParticleCounts??[]).filter(h=>h.type===k.AMBIENT).map(h=>(h?.stddev??0)/(h?.count??.01)).reduce((h,p)=>h+p**2,0))})]})}var ai=["allowCreateWhileLoading","createOptionPosition","formatCreateLabel","isValidNewOption","getNewOptionData","onCreateOption","options","onChange"],xs=function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"",s=arguments.length>1?arguments[1]:void 0,a=arguments.length>2?arguments[2]:void 0,r=String(e).toLowerCase(),i=String(a.getOptionValue(s)).toLowerCase(),o=String(a.getOptionLabel(s)).toLowerCase();return i===r||o===r},Et={formatCreateLabel:function(e){return'Create "'.concat(e,'"')},isValidNewOption:function(e,s,a,r){return!(!e||s.some(function(i){return xs(e,i,r)})||a.some(function(i){return xs(e,i,r)}))},getNewOptionData:function(e,s){return{label:s,value:e,__isNew__:!0}}};function ri(t){var e=t.allowCreateWhileLoading,s=e===void 0?!1:e,a=t.createOptionPosition,r=a===void 0?"last":a,i=t.formatCreateLabel,o=i===void 0?Et.formatCreateLabel:i,c=t.isValidNewOption,l=c===void 0?Et.isValidNewOption:c,d=t.getNewOptionData,h=d===void 0?Et.getNewOptionData:d,p=t.onCreateOption,g=t.options,f=g===void 0?[]:g,T=t.onChange,E=hn(t,ai),v=E.getOptionValue,b=v===void 0?gn:v,I=E.getOptionLabel,C=I===void 0?fn:I,P=E.inputValue,K=E.isLoading,H=E.isMulti,q=E.value,V=E.name,W=u.useMemo(function(){return l(P,Vt(q),f,{getOptionValue:b,getOptionLabel:C})?h(P,o(P)):void 0},[o,h,C,b,P,l,f,q]),O=u.useMemo(function(){return(s||!K)&&W?r==="first"?[W].concat(dt(f)):[].concat(dt(f),[W]):f},[s,r,K,W,f]),Y=u.useCallback(function(G,_){if(_.action!=="select-option")return T(G,_);var j=Array.isArray(G)?G:[G];if(j[j.length-1]===W){if(p)p(P);else{var he=h(P,P),Ee={action:"create-option",name:V,option:he};T(mn(H,[].concat(dt(Vt(q)),[he]),he),Ee)}return}T(G,_)},[h,P,H,V,W,p,T,q]);return Wt(Wt({},E),{},{options:O,onChange:Y})}var ii=u.forwardRef(function(t,e){var s=pn(t),a=ri(s);return u.createElement(Sn,nn({ref:e},a))}),oi=ii;function ci({compact:t=!1}){const s=u.useContext(X).portaCountClient.externalController,[a,r]=u.useState("");function i(){s.sendCommand(a),r("")}const o={"":"","Switch to App Control":M.INVOKE_EXTERNAL_CONTROL,"Switch to PortaCount Control":M.RELEASE_FROM_EXTERNAL_CONTROL,"Request Settings":M.REQUEST_SETTINGS,"Request Runtime Status":M.REQUEST_RUNTIME_STATUS_OF_BATTERY_AND_SIGNAL_PULSE,"Request Voltage Status":M.REQUEST_VOLTAGE_INFO,"Sample from Ambient":M.SWITCH_VALVE_ON,"Sample from Mask":M.SWITCH_VALVE_OFF,"Disable data transmission":M.DISABLE_CONTINUOUS_DATA_TRANSMISSION,"Enable data transmission":M.ENABLE_CONTINUOUS_DATA_TRANSMISSION,"Beep!":M.SOUND_BEEPER_INSIDE_THE_PORTACOUNT_PLUS.replace("xx","02"),"Power Off":M.TURN_POWER_OFF},c=Object.entries(o).map(([d,h])=>({value:h,label:d})),l=n.jsx(Hs,{options:c,onChange:d=>s.sendCommand(d),children:n.jsx($n,{})});return n.jsx(n.Fragment,{children:t?l:n.jsxs("div",{style:{display:"inline-flex",height:"fit-content"},children:[n.jsx(oi,{name:"Mask",options:c,value:a?{value:a,label:a}:null,styles:{menu:d=>({...d,zIndex:2,width:"max-content",textAlign:"left"}),singleValue:d=>({...d,whiteSpace:"normal",width:"9rem"}),input:d=>({...d,width:"9rem"})},tabSelectsValue:!1,onChange:d=>r(d?.value),allowCreateWhileLoading:!0,isSearchable:!0,placeholder:"Type command..."}),n.jsx("input",{type:"button",value:"Send",id:"send-command-button",onClick:i})]})})}function ut(t,e){const s=u.useRef(),a=u.useRef(),r=i=>{a.current===void 0&&(a.current=i),t({frameCurrentTime:i}),s.current=requestAnimationFrame(r)};u.useEffect(()=>(s.current=requestAnimationFrame(r),()=>{s.current&&cancelAnimationFrame(s.current)}),e)}function Je({duration:t,source:e,state:s}){return n.jsx("div",{className:`${e}-${s}-segment`,style:{flexBasis:`${t}px`,flexGrow:t,minWidth:"0px"},children:""})}const li="rgba(255, 255, 255, 1)",ui="rgba(0, 183, 255, 1)";function Fe(t,e,s=ui,a=li){t.current&&(t.current.style.background=`linear-gradient(90deg,${s} ${100*e}%, ${a} 0%, ${a} 100%)`)}function di({stage:t,elementRef:e,currentTestResults:s,exerciseNum:a,currentEstimate:r,stageIndex:i}){const o=u.useContext(X),c=u.useRef(null),l=He(t),d=r!==void 0?r:a&&s?s[`Ex ${a}`]:void 0,h=ie(1e3*(t.ambient_purge+t.ambient_sample+t.mask_purge+t.mask_sample));ut(()=>{if(c.current){const g=o.protocolExecutor.segments,[f,T]=g.filter(v=>v.stageIndex===i).reduce(([v,b],I)=>[v+I.data.length,b+I.duration],[0,0]),E=f/T;Fe(c,E,void 0,"#ffffff00")}},[c]);const p=t.title||t.instructions.split(".")[0];return n.jsxs("div",{className:"protocol-stage-element",ref:e,style:{position:"relative",flexBasis:`${l}px`,flexGrow:l,overflow:"hidden"},children:[n.jsxs("div",{ref:c,style:{position:"absolute",top:0,left:0,minWidth:0,maxWidth:"100%",width:"100%",opacity:"1"},className:"stage-name",children:[h," ",a?`Ex ${a}:`:null," ",p," ",d&&`(${d})`]}),n.jsxs("div",{className:"stage-segments",children:[n.jsx(Je,{duration:t.ambient_purge,source:k.AMBIENT,state:be.PURGE}),n.jsx(Je,{duration:t.ambient_sample,source:k.AMBIENT,state:be.SAMPLE}),n.jsx(Je,{duration:t.mask_purge,source:k.MASK,state:be.PURGE}),n.jsx(Je,{duration:t.mask_sample,source:k.MASK,state:be.SAMPLE})]})]})}function hi(){const t=u.useContext(X),e=t.protocolExecutor,s=t.portaCountClient,a=t.dataCollector,[r,i]=u.useState(),[o,c]=u.useState(Date.now()),[l]=w(m.PROTOCOL_EXECUTION_STATE),[d]=w(m.SELECTED_PROTOCOL),[h,p]=u.useState({}),[g,f]=u.useState(!0),[T,E]=u.useState([]),[v,b]=u.useState([]),[I,C]=u.useState(!1),[P,K]=u.useState(0),H=u.useRef(null),q=u.useRef(null),V=u.useRef(null),W=u.useRef(null),O=e.lastAmbientSegment?Ge(e.lastAmbientSegment):void 0,Y=r?Ge(r):void 0,G=O&&Y?Ue(O/Y):"?",[_]=w(m.ENABLE_TEST_INSTRUCTIONS_ZOOM),[j]=w(m.ACTIVITY),[he,Ee]=w(m.ZOOM_INSTRUCTIONS);u.useEffect(()=>{q.current&&q.current.scrollIntoView({behavior:"smooth",inline:"nearest"})},[r,q]),u.useEffect(()=>{Ee(_&&j===ue.Testing)},[_,j]);function ge(Q){i(Q),c(Q.segmentStartTimeMs||Date.now())}function oe(){e.currentSegment&&i(e.currentSegment)}u.useEffect(()=>{const Q={testStarted(Z){C(!0),i(T[0]),c(Z),ae({source:B.Internal})},testTerminated(){C(!1),i(void 0)},testCompleted(){C(!1),i(void 0)},fitFactorResultsReceived(Z){const z=T.reduce((re,N,x,S)=>re||(N.exerciseNumber===Z.exerciseNum+1?S[x]:null),null);i(z||void 0),c(Z.timestamp)}};return s.addListener(Q),()=>{s.removeListener(Q)}},[T]),u.useEffect(()=>{const Q={segmentDataUpdated(){},segmentChanged(z){ge(z)},cancelled(){i(void 0)},completed(){i(void 0)}},Z={currentTestUpdated(z){p(z),f(!0)}};return e.addListener(Q),a.addListener(Z),ae({}),oe(),()=>{e.removeListener(Q),a.removeListener(Z)}},[]),u.useEffect(()=>{p({}),ae({}),f(!0),K(t.settings.getProtocolDuration(d))},[d]),u.useEffect(()=>{switch(H.current?.classList.remove("idle","in-progress","paused"),l){case"Idle":H.current?.classList.add("idle");break;case"Paused":H.current?.classList.add("paused");break;case"Executing":H.current?.classList.add("in-progress");break}},[l]),Dt(xe);function ae({protocolName:Q=d,source:Z=B.External}){const z=Z===B.External?t.settings.getProtocolDefinition(Q):Ma(Q);E(e.segments),b(z),f(!0)}function xe(){(g||r)&&f(!1)}function fe(Q,Z=!0){const z=Date.now()-o,re=Math.min(z,Q);return r?r.protocolStartTimeOffsetSeconds*1e3+(Z?re:z):0}ut(()=>{if(l==="Executing"||I){const Z=1e3*(r?.duration??0),z=fe(Z,!I),re=Math.max(.02,Math.min(1,.001*z/P));Fe(W,re)}else l==="Idle"&&Fe(W,.02)},[I,r,l]),u.useEffect(()=>{Ee(_&&j===ue.Testing)},[j,_]);function Ne(){const Q=[];let Z=0;return v.forEach((z,re)=>{z.mask_sample&&Z++;const N=r&&r.stageIndex===re,x=N?{elementRef:q}:{};Q.push(n.jsx(di,{...x,stage:z,exerciseNum:z.mask_sample?Z:void 0,currentTestResults:h,currentEstimate:N?G:void 0,stageIndex:re},re))}),Q}return n.jsx("section",{id:"custom-control-panel",style:{height:he?"inherit":"auto",boxSizing:"border-box",display:"flex",flexDirection:"column"},children:n.jsx("div",{id:"protocol-executor-panel-main",ref:H,className:"idle thin-border",children:n.jsx("div",{id:"protocol-visualizer-container",ref:V,children:Ne()})})})}function mi(){const t=u.useContext(X),e=t.settings.getProtocolNames(),[s,a]=w(m.SELECTED_PROTOCOL),[r]=w(m.PROTOCOL_EXECUTION_STATE),i=u.useRef(null),[o,c]=u.useState(""),l=p=>{const g=s;a(p),g!==p&&t.protocolExecutor.cancel()};ut(()=>{if(r==="Executing"){const g=1e3*t.settings.getProtocolDuration(s),f=t.settings.getProtocolTimeRemaining(),T=g-f,E=Math.max(.02,Math.min(1,T/g));Fe(i,E),c(`${ie(T)} / ${ie(g)}`)}else r==="Idle"&&Fe(i,.02)},[r,s]);function d(){return r==="Idle"?h(s):`${s} ${o}`}function h(p){return`${p} - ${ie(1e3*t.settings.getProtocolDuration(p))}`}return n.jsx("select",{id:"protocol-select",ref:i,className:"thin-border no-dim-disabled",onChange:p=>l(p.target.value),value:s,disabled:r==="Executing",style:{width:"calc(100% - 3px)",height:"inherit"},children:e.map(p=>n.jsx("option",{value:p,children:p===s?d():h(p)},p))})}function gi(){const t=u.useContext(X),[e]=w(m.CURRENT_AMBIENT_AVERAGE),[s]=w(m.CURRENT_MASK_AVERAGE),a=t.dataCollector,[r]=w(m.PROTOCOL_EXECUTION_STATE),[i]=w(m.CONNECTION_STATUS),[o]=w(m.TEST_TEMPLATE),[c,l]=u.useState(!0),d=r!=="Idle"||i!==te.RECEIVING;u.useEffect(()=>{console.debug("template updated"),l(!0)},[o,o.Participant,o.Mask,o.Notes]);async function h(){d||((!a.hasCurrentTestData()||c)&&(await a.recordTestStart(B.Manual,void 0,"Estimated"),l(!1)),a.recordParticleCount(new je(e.mean,k.AMBIENT,B.Manual,e.stddev)),a.recordParticleCount(new je(s.mean,k.MASK,B.Manual)),a.recordNextExerciseResult(e.mean/Math.max(.01,s.mean)))}return n.jsx("div",{id:"record-current-estimate",onClick:h,className:`svg-container icon-button ${d?"disabled":""}`,children:n.jsx(Rs,{})})}function fi(){const e=u.useContext(X).portaCountClient,[s,a]=u.useState(e.state.sampleSource);u.useEffect(()=>{const i={sampleSourceChanged(o){a(o)}};return e.addListener(i),()=>{e.removeListener(i)}},[]);function r(){e.externalController.sampleSource=s==k.MASK?k.AMBIENT:k.MASK}return n.jsxs("div",{id:"sample-source-widget",onClick:r,className:"svg-container icon-button",children:[s===k.AMBIENT&&n.jsx(Un,{}),s===k.MASK&&n.jsx(jt,{})]})}function pi(t){return J({tag:"svg",attr:{version:"1.1",viewBox:"0 0 16 16"},child:[{tag:"path",attr:{d:"M8 0c-4.418 0-8 3.582-8 8s3.582 8 8 8 8-3.582 8-8-3.582-8-8-8zM8 14.5c-3.59 0-6.5-2.91-6.5-6.5s2.91-6.5 6.5-6.5 6.5 2.91 6.5 6.5-2.91 6.5-6.5 6.5zM6 4.5l6 3.5-6 3.5z"},child:[]}]})(t)}function Si(t){return J({tag:"svg",attr:{version:"1.1",viewBox:"0 0 16 16"},child:[{tag:"path",attr:{d:"M8 0c-4.418 0-8 3.582-8 8s3.582 8 8 8 8-3.582 8-8-3.582-8-8-8zM8 14.5c-3.59 0-6.5-2.91-6.5-6.5s2.91-6.5 6.5-6.5 6.5 2.91 6.5 6.5-2.91 6.5-6.5 6.5zM5 5h2v6h-2zM9 5h2v6h-2z"},child:[]}]})(t)}function Ti(t){return J({tag:"svg",attr:{version:"1.1",viewBox:"0 0 16 16"},child:[{tag:"path",attr:{d:"M8 0c-4.418 0-8 3.582-8 8s3.582 8 8 8 8-3.582 8-8-3.582-8-8-8zM8 14.5c-3.59 0-6.5-2.91-6.5-6.5s2.91-6.5 6.5-6.5 6.5 2.91 6.5 6.5-2.91 6.5-6.5 6.5zM5 5h6v6h-6z"},child:[]}]})(t)}function Ei(){const e=u.useContext(X).protocolExecutor,[s]=w(m.SELECTED_PROTOCOL),[a]=w(m.PROTOCOL_EXECUTION_STATE),[r]=w(m.CONNECTION_STATUS);function i(){if(r===te.RECEIVING)switch(a){case"Executing":e.pause();break;case"Paused":e.resume();break;case"Idle":e.executeProtocol(s);break}}return n.jsx("div",{id:"start-protocol-button",className:`svg-container icon-button start ${r!==te.RECEIVING&&"disabled"}`,onClick:i,children:a==="Executing"?n.jsx(Si,{}):n.jsx(pi,{})})}function xi(){const e=u.useContext(X).protocolExecutor,[s]=w(m.PROTOCOL_EXECUTION_STATE),[a]=w(m.CONNECTION_STATUS);function r(){s==="Idle"||a!==te.RECEIVING||e.cancel()}return n.jsx("div",{id:"stop-protocol-button",className:`svg-container icon-button stop ${(s==="Idle"||a!==te.RECEIVING)&&"disabled"}`,onClick:r,children:n.jsx(Ti,{})})}const bi="Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.";function Ci(){const t=u.useContext(X),[e,s]=u.useState(""),[a,r]=u.useState(""),i=u.useRef(null),[o,c]=u.useState(2),[l]=w(m.CURRENT_STAGE_INDEX),[d]=w(m.STAGE_START_TIME),[h]=w(m.SELECTED_PROTOCOL),[p]=w(m.PROTOCOL_EXECUTION_STATE),[g]=w(m.TEST_TEMPLATE);return u.useEffect(()=>{i.current&&(i.current.style.fontSize=`${o}em`)},[o]),u.useEffect(()=>{if(console.debug(`protocolExecutionState ${p}`),p==="Idle"){console.debug("test template is ",g),g.Final&&(s(`Test complete. Final score is ${g.Final}.`),r("Summary"));return}const T=t.settings.getProtocolDefinition(h)[l];T.instructions?s(T.instructions.replace(/\.\s+/,`.
`)):(console.warn(`no instructions for protocol ${h} stage ${l}`),s("-")),T.title&&r(T.title)},[l,h,p,g]),ut(()=>{switch(p){case"Idle":Fe(i,0);break;case"Executing":{const f=He(t.settings.getProtocolDefinition(h)[l]),T=Date.now()-d;Fe(i,Math.min(1,.001*T/f));break}}},[d,l,p]),n.jsxs("fieldset",{style:{display:"flex",flexDirection:"column",flexGrow:1},className:"info-box-compact",children:[n.jsxs("legend",{children:["Instructions (",a,") ",n.jsx("input",{type:"range",min:1,max:5,value:o,step:.01,onChange:f=>c(Number(f.target.value))})]}),n.jsx("textarea",{id:"test-instructions",ref:i,className:"no-focus-border",style:{flexGrow:1,width:"100%",minHeight:"1em",height:"inherit",overflow:"auto",resize:"none",border:"none",alignContent:"start",textAlign:"start",textWrap:"wrap",whiteSpaceCollapse:"collapse"},readOnly:!0,value:e,onChange:()=>null,placeholder:bi})]})}function vi(){return n.jsxs("div",{id:"test-panel",style:{height:"inherit",display:"flex",flexDirection:"column"},children:[n.jsx(en,{}),n.jsxs("div",{className:"inline-flex",children:[n.jsx(si,{}),n.jsxs("div",{style:{flexGrow:1},children:[n.jsx(mi,{}),n.jsx(hi,{})]})]}),n.jsxs("div",{id:"compact-ui",style:{display:"inline-flex",width:"fit-content",gap:"1em",alignItems:"center",height:"fit-content",flexWrap:"wrap",justifyContent:"start"},children:[n.jsx(it,{compact:!0}),n.jsx(gi,{}),n.jsx(Ei,{}),n.jsx(xi,{}),n.jsx(fi,{}),n.jsx(ci,{compact:!0}),n.jsx(ei,{}),n.jsx(ni,{}),n.jsx(qs,{label:""})]}),n.jsx("div",{style:{width:"100%",display:"flex",flexGrow:1},children:n.jsx(Ci,{})})]})}const _i="modulepreload",Ni=function(t,e){return new URL(t,e).href},bs={},wi=function(e,s,a){let r=Promise.resolve();if(s&&s.length>0){const o=document.getElementsByTagName("link"),c=document.querySelector("meta[property=csp-nonce]"),l=c?.nonce||c?.getAttribute("nonce");r=Promise.allSettled(s.map(d=>{if(d=Ni(d,a),d in bs)return;bs[d]=!0;const h=d.endsWith(".css"),p=h?'[rel="stylesheet"]':"";if(!!a)for(let T=o.length-1;T>=0;T--){const E=o[T];if(E.href===d&&(!h||E.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${p}`))return;const f=document.createElement("link");if(f.rel=h?"stylesheet":_i,h||(f.as="script"),f.crossOrigin="",f.href=d,l&&f.setAttribute("nonce",l),document.head.appendChild(f),h)return new Promise((T,E)=>{f.addEventListener("load",T),f.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${d}`)))})}))}function i(o){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=o,window.dispatchEvent(c),!c.defaultPrevented)throw o}return r.then(o=>{for(const c of o||[])c.status==="rejected"&&i(c.reason);return e().catch(i)})};function yi(t={}){const{immediate:e=!1,onNeedRefresh:s,onOfflineReady:a,onRegistered:r,onRegisteredSW:i,onRegisterError:o}=t;let c,l,d;const h=async(g=!0)=>{await l,await d?.()};async function p(){if("serviceWorker"in navigator){if(c=await wi(async()=>{const{Workbox:g}=await import("./workbox-window.prod.es5-B9K5rw8f.js");return{Workbox:g}},[],import.meta.url).then(({Workbox:g})=>new g("./sw.js",{scope:"./",type:"classic"})).catch(g=>{o?.(g)}),!c)return;d=async()=>{await c?.messageSkipWaiting()};{let g=!1;const f=()=>{g=!0,c?.addEventListener("controlling",T=>{T.isUpdate&&window.location.reload()}),s?.()};c.addEventListener("installed",T=>{typeof T.isUpdate>"u"?typeof T.isExternal<"u"?T.isExternal?f():!g&&a?.():T.isExternal?window.location.reload():!g&&a?.():T.isUpdate||a?.()}),c.addEventListener("waiting",f),c.addEventListener("externalwaiting",f)}c.register({immediate:e}).then(g=>{i?i("./sw.js",g):r?.(g)}).catch(g=>{o?.(g)})}}return l=p(),h}function Ai(){const[t,e]=u.useState(""),s=de.useRef(null),[a,r]=u.useState(""),i=de.useRef(null),[o,c]=u.useState(""),l=de.useRef(null),d=u.useContext(X);return u.useEffect(()=>{e(()=>d.dataCollector.rawLines),r(d.dataCollector.logLines),c(d.dataCollector.processedData);const h={logRawLine(){e(()=>d.dataCollector.rawLines)},logMessage(p){r(g=>g+p)},logProcessedData(p){const g=new Date().toISOString();c(f=>f+`${g} ${p}`)}};return d.dataCollector.addListener(h),()=>{d.dataCollector.removeListener(h)}},[]),n.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:[n.jsxs("section",{style:{width:"100%",display:"flex",flexGrow:1},children:[n.jsxs("fieldset",{style:{flexGrow:1},children:[n.jsx("legend",{children:"Raw Data"}),n.jsx("textarea",{id:"raw-data",ref:s,readOnly:!0,style:{width:"100%",height:"100%",border:"none",resize:"vertical"},tabIndex:1e3,value:t})]}),n.jsxs("fieldset",{style:{flexGrow:1},children:[n.jsx("legend",{children:"Processed Data"}),n.jsx("textarea",{id:"interpreted-data",ref:l,readOnly:!0,style:{width:"100%",height:"100%",border:"none",resize:"vertical"},tabIndex:1001,value:o})]})]}),n.jsx("section",{style:{width:"100%",flexGrow:1,display:"flex"},children:n.jsxs("fieldset",{style:{flexGrow:1},children:[n.jsx("legend",{children:"Log"}),n.jsx("textarea",{id:"log-text-area",ref:i,readOnly:!0,style:{width:"100%",height:"100%",border:"none",resize:"vertical"},tabIndex:1002,value:a})]})})]})}const Ri=yi({onNeedRefresh(){confirm("A new version is available. Update to the latest version?")&&Ri(!0)}});ys(document.getElementById("root")).render(n.jsx(u.StrictMode,{children:n.jsx(Tn,{children:n.jsx(u.Suspense,{fallback:"...",children:n.jsx(En,{children:n.jsxs(me,{path:"",element:n.jsx(_r,{}),children:[n.jsx(me,{index:!0,element:n.jsx(wr,{})}),n.jsx(me,{path:"test",element:n.jsx(vi,{})}),n.jsx(me,{path:"participant",element:n.jsx(zr,{})}),n.jsx(me,{path:"view-results",element:n.jsx(Yr,{})}),n.jsx(me,{path:"settings",element:n.jsx(Ks,{})}),n.jsx(me,{path:"protocols",element:n.jsx(Xr,{})}),n.jsx(me,{path:"raw-data",element:n.jsx(Ai,{})}),n.jsx(me,{path:"stats",element:n.jsx(Jr,{})}),n.jsx(me,{path:"qrscanner",element:n.jsx(Hr,{})}),n.jsx(me,{path:"unsupported-browser",element:n.jsx(Ys,{})}),n.jsx(me,{path:"daily-checks",element:n.jsx(er,{})}),n.jsx(me,{path:"cleanup-assistant",element:n.jsx(Za,{})}),n.jsx(me,{path:"bookmarks",element:n.jsx(Qa,{})}),n.jsx(me,{path:"help",element:n.jsx(tr,{})})]})})})})}));
